import{b as D,r as p,j as e,M as i,f as x,u as _,a as h}from"./gg0tb34p9fzo1omt.js";import{f as U,b as T,A as P,a as B}from"./m22845s1ft2he4f8.js";import{bg as f,R as u,ch as L,be as R,bU as H,c6 as w}from"./g670b8vtkhx0yc6d.js";import{m as n}from"./eehax2vszpub1pi3.js";import{gr as K,d2 as O,hJ as k}from"./forbprkns1cohsbl.js";import{T as m}from"./cfdk1y828jwp5ajh.js";function Q({setEnabled:t,isLoading:r,isEnabled:s}){const a=D(),[o,c]=p.useState(!1),d=()=>{c(!0)},y=l=>{c(!1),l&&t(!1)};return e.jsx("div",{className:"pt-1.5",children:s?e.jsxs(e.Fragment,{children:[e.jsx(f,{disabled:r,color:"danger",onClick:()=>{r||d()},children:e.jsx(i,{...n.deleteDirectorySyncConnectionButton})}),e.jsx(K,{title:a.formatMessage(n.deleteDirectorySyncConnectionModalHeader),description:a.formatMessage(n.deleteDirectorySyncConnectionModalExplanation),confirmText:a.formatMessage(n.deleteDirectorySyncConnectionModalConfirmButton),cancelText:a.formatMessage(n.deleteDirectorySyncConnectionModalCancelButton),isOpen:o,primaryButtonColor:"danger",onClose:()=>y(!1),onConfirm:()=>y(!0)})]}):e.jsx(e.Fragment,{children:e.jsx(f,{disabled:r,color:"primary",onClick:()=>{r||t(!0)},children:e.jsx(i,{...n.enableDirectorySyncButton})})})})}class S{static async getWorkspaceDirectorySyncSettings(r){return u.safeGet("/accounts/{account_id}/scim",{parameters:{path:{account_id:r}}})}static async setWorkspaceDirectorySyncEnabled(r,s){return u.safePost("/accounts/{account_id}/scim/set_enabled",{parameters:{path:{account_id:r}},requestBody:{enabled:s}})}static async setWorkspaceDirectorySyncEmailInvitesEnabled(r,s){return u.safePost("/accounts/{account_id}/scim/set_email_invites_enabled",{parameters:{path:{account_id:r}},requestBody:{enabled:s}})}static async getWorkspaceDirectorySyncPortalUrl(r){return u.safeGet("/accounts/{account_id}/scim/portal_link",{parameters:{path:{account_id:r}}})}static async getWorkspaceDirectorySyncFailedEvents(r){return u.safeGet("/accounts/{account_id}/scim/failed_events",{parameters:{path:{account_id:r}}})}static async retryWorkspaceDirectorySyncFailedEvent(r,s){return u.safePost("/accounts/{account_id}/scim/failed_events/{event_id}/retry",{parameters:{path:{account_id:r,event_id:s}}})}static async retryAllWorkspaceDirectorySyncFailedEvents(r){return u.safePost("/accounts/{account_id}/scim/failed_events/retry_all",{parameters:{path:{account_id:r}}})}static async discardWorkspaceDirectorySyncFailedEvent(r,s){return u.safeDelete("/accounts/{account_id}/scim/failed_events/{event_id}",{parameters:{path:{account_id:r,event_id:s}}})}static async getWorkspaceDirectorySyncProgressUsers(r){return u.safeGet("/accounts/{account_id}/scim/sync_progress_users",{parameters:{path:{account_id:r}}})}static async getWorkspaceDirectorySyncProgressGroups(r){return u.safeGet("/accounts/{account_id}/scim/sync_progress_groups",{parameters:{path:{account_id:r}}})}}function z({isLoading:t,workspaceId:r,isDirectoryConnectionConfigured:s}){const[a,o]=p.useState(!1),c=L(),d=D(),y=async()=>{try{o(!0);const l=await S.getWorkspaceDirectorySyncPortalUrl(r);o(!1),l?.portal_link?window.open(l.portal_link,"_blank"):c.danger(d.formatMessage({id:"directorySync.portalLinkNotFound",defaultMessage:"Portal link not found."}),{toastId:"directory_sync_management_portal_button",loggingTitle:"Portal link not found.",loggingDescription:"Error message shown when directory sync portal link is missing"})}catch(l){l instanceof Error?c.danger(l.message,{toastId:"directory_sync_management_portal_button",loggingTitle:l.message,loggingDescription:"Generic error message for unexpected failures when opening the directory sync portal"}):c.danger(d.formatMessage({id:"directorySync.unexpectedError",defaultMessage:"An unexpected error occurred."}),{toastId:"directory_sync_management_portal_button",loggingTitle:"An unexpected error occurred.",loggingDescription:"Generic error message for unexpected failures when opening the directory sync portal"})}};return e.jsxs(f,{disabled:t||a,color:"secondary",className:"mt-3",onClick:y,children:[s?e.jsx(i,{...n.launchDirectorySyncManagementPortalText}):e.jsx(i,{...n.launchDirectorySyncSetupPortalText}),e.jsx(O,{className:"icon-sm ms-1"})]})}function F(t){switch(t){case"dsync.user.created":return n.directorySyncEventTypeUserCreated;case"dsync.user.updated":return n.directorySyncEventTypeUserUpdated;case"dsync.user.deleted":return n.directorySyncEventTypeUserDeleted;case"dsync.group.created":return n.directorySyncEventTypeGroupCreated;case"dsync.group.updated":return n.directorySyncEventTypeGroupUpdated;case"dsync.group.deleted":return n.directorySyncEventTypeGroupDeleted;case"dsync.group.user_added":return n.directorySyncEventTypeGroupUserAdded;case"dsync.group.user_removed":return n.directorySyncEventTypeGroupUserRemoved;case"dsync.activated":return n.directorySyncEventTypeActivated;case"dsync.deleted":return n.directorySyncEventTypeDeleted;case"dsync.deactivated":return n.directorySyncEventTypeDeleted}}function J({isLoading:t,failedEvents:r,retryEventWithId:s,retryAllFailedEvents:a,discardFailedEventWithId:o}){const[c,d]=p.useState(!1),[y,l]=p.useState(),j=D();return e.jsxs(e.Fragment,{children:[y&&e.jsx(R,{testId:"modal-directory-sync-failed-events",isOpen:c,onClose:d,title:j.formatMessage(F(y.event.event)),description:y.failure_reason,type:"success",showCloseButton:!0,isScrollable:!0,children:e.jsx("pre",{children:JSON.stringify(y.event,null,2)})}),r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(U,{className:"flex items-center space-x-4",children:[e.jsx(i,{...n.failedDirectorySyncEventsTableHeader}),e.jsx(f,{disabled:t,color:"secondary",size:"small",className:"ms-auto",onClick:()=>{a()},children:e.jsx(i,{...n.retryAllFailedDirectorySyncEventsButton})})]}),e.jsxs(m.Root,{className:"w-full table-auto",children:[e.jsxs(m.Header,{children:[e.jsx(m.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(i,{...n.directorySyncEventsTableFailureEventTypeColumnHeader})}),e.jsx(m.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(i,{...n.directorySyncEventsTableFailureReasonColumnHeader})}),e.jsx(m.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(i,{...n.directorySyncEventsTableActionsColumnHeader})})]}),e.jsx(m.Body,{children:r.map((g,C)=>e.jsxs("tr",{children:[e.jsx(m.Cell,{children:e.jsx(i,{...F(g.event.event)})}),e.jsx(m.Cell,{children:g.failure_reason}),e.jsxs(m.Cell,{children:[e.jsx("div",{children:e.jsx(f,{disabled:t,color:"secondary",size:"small",onClick:()=>{l(g),d(!0)},children:e.jsx(i,{...n.showEventDirectorySyncEventButton})})}),e.jsx("div",{className:"ms-2",children:e.jsx(f,{disabled:t,color:"secondary",size:"small",onClick:()=>{s(g.event.id)},children:e.jsx(i,{...n.retryDirectorySyncEventButton})})}),e.jsx("div",{className:"ms-2",children:o&&e.jsx(f,{disabled:t,color:"secondary",size:"small",onClick:()=>{o(g.event.id)},children:e.jsx(i,{...n.discardDirectorySyncEventButton})})})]})]},g.event.id))})]})]})]})}function Y({isLoading:t,numUsersSynced:r,numUsersInDirectory:s,numGroupsSynced:a,numGroupsInDirectory:o,failedEvents:c,retryEventWithId:d,retryAllFailedEvents:y,discardFailedEventWithId:l}){return e.jsxs(e.Fragment,{children:[e.jsxs(T,{className:"my-2",children:[e.jsxs("div",{children:[e.jsx(i,{...n.directorySyncUserSyncStatus,values:{numUsersSynced:r,numUsersInDirectory:s}}),e.jsx(k,{percentage:r/(s||1)*100})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx(i,{...n.directorySyncGroupSyncStatus,values:{numGroupsSynced:a,numGroupsInDirectory:o}})}),e.jsx(k,{percentage:a/(o||1)*100})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(J,{isLoading:t,failedEvents:c,retryEventWithId:d,retryAllFailedEvents:y,discardFailedEventWithId:l})})]})}const E=2e3;function b(t,r){const[s,a]=p.useState(!1),{data:o,...c}=x({queryKey:["workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncSettings(t)},enabled:!!t,refetchInterval:s?E:!1});return p.useEffect(()=>{o?.enabled&&o?.directory_connection==null?a(!0):a(!1)},[o]),{data:o,...c}}function M(t,r){const[s,a]=p.useState(!1),{data:o}=b(t),{data:c,...d}=x({queryKey:["workspace/directorySyncStatus/progressUsers","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncProgressUsers(t)},enabled:!!t&&!!o?.directory_connection,refetchInterval:s?E:!1});return p.useEffect(()=>{c?.synced_scim_users===0||c?.synced_scim_users!==c?.total_scim_users?a(!0):a(!1)},[c,o?.directory_connection]),{isLoadingUsers:s,data:c,...d}}function V(t,r){const[s,a]=p.useState(!1),{data:o}=b(t),{data:c,...d}=x({queryKey:["workspace/directorySyncStatus/progressGroups","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncProgressGroups(t)},enabled:!!t&&!!o?.directory_connection,refetchInterval:s?E:!1});return p.useEffect(()=>{c?.synced_scim_groups===0||c?.synced_scim_groups!==c?.total_scim_groups?a(!0):a(!1)},[c,o?.directory_connection]),{isLoadingGroups:s,data:c,...d}}function I(t,r){const{isLoadingUsers:s}=M(t);return x({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncFailedEvents(t)},enabled:!!t,refetchInterval:s?E:!1})}function X(t){const r=_();return h({mutationFn:s=>S.retryWorkspaceDirectorySyncFailedEvent(t,s),onSuccess:()=>{r.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySyncStatus/progressUsers","workspace/directorySyncStatus/progressGroups"]})}})}function Z(t){const r=_();return h({mutationFn:()=>S.retryAllWorkspaceDirectorySyncFailedEvents(t),onSuccess:()=>{r.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySyncStatus/progressUsers","workspace/directorySyncStatus/progressGroups"]})}})}function $(t){const r=_();return h({mutationFn:s=>S.discardWorkspaceDirectorySyncFailedEvent(t,s),onSuccess:()=>{r.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents"]})}})}function ee(t){const r=_();return h({mutationFn:s=>S.setWorkspaceDirectorySyncEnabled(t,s),onSuccess:()=>{r.refetchQueries({queryKey:["workspace/directorySync",t]})}})}function oe({workspaceId:t}){const{data:r,isLoading:s}=b(t),{data:a,isLoading:o}=M(t),{data:c,isLoading:d}=V(t),{data:y,isLoading:l}=I(t),{mutateAsync:j,status:g}=ee(t),{mutateAsync:C,status:W}=X(t),{mutateAsync:G,status:N}=Z(t),{mutateAsync:q,status:A}=$(t),v=g==="pending"||W==="pending"||N==="pending"||A==="pending"||s||o||d||l;return e.jsxs(P,{className:H("ps-6",v&&"text-token-text-secondary"),children:[e.jsx(B,{children:e.jsxs("div",{className:"flex flex-row",children:[e.jsx("div",{children:e.jsx(i,{...n.directorySyncTitle})}),e.jsx("div",{className:"ms-2 mt-1",children:v&&e.jsx(w,{})})]})}),e.jsx(T,{children:e.jsx(i,{...n.directorySyncInfoText})}),r?.directory_connection&&e.jsx("div",{children:e.jsx(Y,{isLoading:v,numUsersSynced:a?.synced_scim_users??0,numUsersInDirectory:a?.total_scim_users??0,numGroupsSynced:c?.synced_scim_groups??0,numGroupsInDirectory:c?.total_scim_groups??0,failedEvents:y??[],retryEventWithId:C,retryAllFailedEvents:G,discardFailedEventWithId:q})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(Q,{setEnabled:j,isLoading:v,isEnabled:r?.enabled??!0}),r?.enabled&&e.jsx(e.Fragment,{children:e.jsx(z,{isLoading:v,workspaceId:t,isDirectoryConnectionConfigured:!!r?.directory_connection})})]})]})}export{oe as DirectorySyncSection};
//# sourceMappingURL=zaxft5nfan1gh5ud.js.map
