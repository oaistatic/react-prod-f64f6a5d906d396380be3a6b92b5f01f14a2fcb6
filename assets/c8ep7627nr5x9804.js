import{b as B,j as t,M as ce,c as Yt,e as Xt,m as Z,r as f,A as Pe,u as tt,a as xe,f as qs,d as Us}from"./gg0tb34p9fzo1omt.js";import{T as Fs,u as Gs,C as Ks,a as zs,H as Ws,b as Vs}from"./mgu35bfjmjtg3slf.js";import{b$ as Qs,dc as $s,pP as Ne,lz as k,lA as L,ki as Re,pQ as Jt,i as es,A as ts,c5 as he,pR as Zs,gG as Ys,ak as Xs,pS as Js,nI as en,o5 as kt,pT as tn,c9 as sn,pU as nn,pV as on,cs as an,i9 as rn,nJ as Rt,bv as cn,bE as Y,bM as Dt,pW as ln,dd as dn,b6 as un,mA as Pt,i3 as mn,i4 as fn,i6 as gn,i7 as xn,pX as ke,a4 as hn,v as pn,cd as Cn,lH as vn,c6 as me,pY as yn,pZ as ss,p_ as bn,p$ as Tn,d as Sn,q0 as Xe,q1 as wn,l9 as En,q2 as An,lW as fe,q3 as jn,q4 as _n,fy as In,q5 as Mn,b as kn,q6 as Rn,dV as Dn,q7 as Pn,q8 as Nn,q9 as On,qa as Ln,qb as Bn,c2 as Hn,c3 as qn,c4 as Un,n7 as Nt,qc as Fn,g as Gn,qd as Kn,kk as zn,qe as Wn,hQ as Vn,qf as Ot,c8 as Lt,qg as Bt,qh as Ie,qi as Me,qj as Ht}from"./forbprkns1cohsbl.js";import{ht as ns,be as Qn,bf as $n,cY as Je,bj as Zn,b_ as Yn,c3 as Xn,c4 as Jn,gF as eo,gG as to,bY as so,bZ as no,bg as qt,bT as oo,a7 as et,h as os,a4 as Ut,gm as ao,bU as pe,D as as,R as V,dw as rs,py as is,c5 as D,it as Ft,dX as X,cD as ro,ck as cs,d as ls,m as ds,f8 as Gt,f9 as io,jw as co,e6 as lo,P as uo,aG as mo}from"./g670b8vtkhx0yc6d.js";import{O as fo,b as ee,u as go,c as xo,g as ho,A as po,a as Co,f as Kt,C as ae,D as vo}from"./ejkv34dzwipa230i.js";import{e as yo}from"./dku20bpa2hgnbl5b.js";import{C as bo}from"./j8f1yha947to1zwq.js";import{i as To,d as So,a as wo,b as Eo,g as Ao}from"./gffsn29yylc5pncm.js";import{C as De,j as zt,S as Wt}from"./jh4r0k3f3n3zptua.js";import{a as jo}from"./l8bgi7e4c78ddktv.js";import{D as _o}from"./e6r7gqenbe47ga9h.js";import{i as Io}from"./eiffxi5640gvsu4t.js";import{a as Mo,g as ko}from"./kxn66emqpeqvk1h7.js";import{N as Ro}from"./jy1u8exw8iz2slve.js";import{S as Do}from"./isn1igquqvc1qe44.js";import{g as Ze,S as Po}from"./bk8slwxjkdlmxjxm.js";import{s as Ye,B as No}from"./ob8dna56sqm37byd.js";import{L as Oo}from"./fz8lyjvdpywhlf94.js";import{u as Lo}from"./kr5jdtt5uczx95b1.js";import{u as Vt}from"./cx1v46pslsfvescw.js";import{i as Qt}from"./e83gfa4m2yetz3zf.js";import{g as Bo}from"./jec2dxephizdapuu.js";var us=(s=>(s.Close="close",s.Loaded="loaded",s.Streaming="streaming",s.Download="download",s))(us||{});const Ho=({isOpen:s,dismissModal:e,closeTextdocEditor:n,textdocVersion:o,clientThreadId:c})=>{const r=B(),a=Qs(c),l=$s(c),g=ns(),i=Ne(o?.textdocId),d=async x=>{k.logButtonClick(L.SAVE_TO_CHAT_ON_EDITOR_CLOSE),!(o?.versionInt==null||g)&&(l({sourceEvent:x,promptMessage:Zn("",{canvas:{user_created_textdocs:o!=null&&o.status===Jt.ATTACHED_PENDING&&i!=null?[{user_created_temp_textdoc_id:o.textdocId,type:o.type,title:o.title,content:o.content,create_source:i.create_source}]:void 0},open_in_canvas_view:{type:"canvas_textdoc",id:o.textdocId}}),completionMetadata:a?{conversationMode:a}:void 0}),i&&Re.markAsSent(i.tempTextdocId),e(),n())};return t.jsx(Qn,{testId:"modal-confirm-close-editor",isOpen:s,size:"custom",className:"max-w-xl",onClose:e,type:"warning",hideSeparator:!0,title:t.jsx("span",{className:"text-xl",children:t.jsx(ce,{id:"jgd5rD",defaultMessage:"Are you sure you want to close?"})}),primaryButton:t.jsx(Je.Button,{title:r.formatMessage({id:"XE+GiU",defaultMessage:"Save to chat"}),color:"primary",onClick:d}),secondaryButton:t.jsx(Je.Button,{title:r.formatMessage({id:"MbWco5",defaultMessage:"Donâ€™t save and close"}),color:"secondary",onClick:()=>{k.logButtonClick(L.CLOSE_WITHOUT_SAVING),i&&Re.removeTempTextdoc(i.tempTextdocId),e(),n()}}),showCloseButton:!0,closeButton:t.jsx($n,{onClick:e}),children:t.jsx("div",{className:"text-md text-token-text-secondary -mt-6 pb-2",children:t.jsx(ce,{id:"q9rJ+Y",defaultMessage:"Changes will not be saved unless you save this canvas to your chat."})})})},Oe="https://persistent.oaistatic.com/canvas/nux-videos/",qo=`${Oe}canvas_writing.mp4`,Uo=`${Oe}canvas_coding.mp4`,Fo=`${Oe}canvas_writing_hero.jpg`,Go=`${Oe}canvas_coding_hero.jpg`,Ko="https://help.openai.com/en/articles/9930697-what-is-the-canvas-feature-in-chatgpt-and-how-do-i-use-it",zo=s=>{"use forget";const e=Yt.c(27),{onClose:n,title:o,description:c,asset:r,size:a}=s,l=B(),g=r===0,i=a===1?252:218;let d;e[0]!==i?(d={height:i},e[0]=i,e[1]=d):d=e[1];const x=g?Fo:Go,y=g?qo:Uo;let m;e[2]!==x||e[3]!==y?(m=t.jsx("video",{muted:!0,loop:!0,autoPlay:!0,playsInline:!0,className:"h-full max-w-none",poster:x,src:y}),e[2]=x,e[3]=y,e[4]=m):m=e[4];let b;e[5]!==d||e[6]!==m?(b=t.jsx("div",{className:"border-token-border-default bg-token-main-surface-secondary text-token-text-secondary relative flex w-full items-center justify-center overflow-hidden border-b",style:d,children:m}),e[5]=d,e[6]=m,e[7]=b):b=e[7];let p;e[8]!==o?(p=t.jsx(Xn,{className:"text-center text-xl leading-6 font-semibold",children:t.jsx(ce,{...o})}),e[8]=o,e[9]=p):p=e[9];let h;e[10]!==c?(h=t.jsx(Jn,{className:"text-token-text-secondary text-center text-sm",children:t.jsx(ce,{...c})}),e[10]=c,e[11]=h):h=e[11];let u;e[12]!==p||e[13]!==h?(u=t.jsxs("div",{className:"flex flex-col gap-2",children:[p,h]}),e[12]=p,e[13]=h,e[14]=u):u=e[14];let T;e[15]!==l?(T=l.formatMessage(ie.button),e[15]=l,e[16]=T):T=e[16];let C;e[17]!==n||e[18]!==T?(C=t.jsx(Je.Button,{onClick:n,title:T,color:"primary"}),e[17]=n,e[18]=T,e[19]=C):C=e[19];let S;e[20]===Symbol.for("react.memo_cache_sentinel")?(S=t.jsxs(eo,{href:Ko,className:"flex items-center gap-1 font-medium",children:[t.jsx(ce,{...ie.learnMore}),t.jsx(to,{className:"icon-sm"})]}),e[20]=S):S=e[20];let A;e[21]!==C||e[22]!==u?(A=t.jsxs("div",{className:"flex flex-col items-center gap-4 px-10 py-8",children:[u,C,S]}),e[21]=C,e[22]=u,e[23]=A):A=e[23];let v;return e[24]!==A||e[25]!==b?(v=t.jsxs("div",{className:"flex flex-col items-center focus:outline-hidden",children:[b,A]}),e[24]=A,e[25]=b,e[26]=v):v=e[26],v},Wo=s=>{"use forget";const e=Yt.c(11),{textdocType:n}=s,{markAsViewed:o}=es(ts.hasDismissedCanvasContextualOnboarding),c=Yn()?.document.body;let r,a,l;e[0]===Symbol.for("react.memo_cache_sentinel")?(r={opacity:.75,scale:.9},a={opacity:1,scale:1},l={type:"spring",bounce:.2,duration:.56},e[0]=r,e[1]=a,e[2]=l):(r=e[0],a=e[1],l=e[2]);const g=he(n)?1:0,i=he(n)?ie.contextualModalTitleCoding:ie.contextualModalTitleWriting,d=he(n)?ie.contextualModalDescriptionCoding:ie.contextualModalDescriptionWriting;let x;e[3]!==o||e[4]!==g||e[5]!==i||e[6]!==d?(x=t.jsx(Z.div,{initial:r,animate:a,transition:l,className:"popover border-token-border-default bg-token-main-surface-primary fixed end-4 bottom-4 z-50 max-w-sm overflow-hidden rounded-2xl border shadow-xl",children:t.jsx(zo,{onClose:o,asset:g,size:0,title:i,description:d})}),e[3]=o,e[4]=g,e[5]=i,e[6]=d,e[7]=x):x=e[7];let y;return e[8]!==c||e[9]!==x?(y=t.jsx(so,{open:!0,defaultOpen:!0,modal:!1,children:t.jsx(no,{container:c,children:x})}),e[8]=c,e[9]=x,e[10]=y):y=e[10],y},ie=Xt({contextualModalTitleWriting:{id:"Pi+0RT",defaultMessage:"Draft and refine on the spot"},contextualModalDescriptionWriting:{id:"Jv0f02",defaultMessage:"Make it shorter. Add an emoji. Translate to kindergartener. ChatGPT can do it all, right on the canvas."},contextualModalTitleCoding:{id:"Zi5Ty0",defaultMessage:"Refine and debug on the spot"},contextualModalDescriptionCoding:{id:"XnaO2x",defaultMessage:"Refactor code. Translate to Python. Check for bugs. ChatGPT can do it all, right on the canvas."},button:{id:"7bNl4/",defaultMessage:"Got it"},learnMore:{id:"vs1lx2",defaultMessage:"Learn more about canvas"}});function ms(s){const e=Zs();if(!s)return{isCodePreviewable:!1,isCodeExecutable:!1,hasCanvasCodeExecution:e};const n=To(s?.type,s?.content),o=So(s.type);return{isCodePreviewable:n,isCodeExecutable:o,hasCanvasCodeExecution:e}}const Vo=({isTextdocStreaming:s,isRequestActive:e,value:n,comments:o})=>{const[c,r]=f.useState(!1);return f.useEffect(()=>{s&&c&&(r(!1),De.reset())},[n,o]),f.useEffect(()=>{e||(r(!1),De.reset())},[e]),[c,r]};function Qo({onClickRestore:s,onClickResetLatest:e}){const n=B();return t.jsx(Z.div,{initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{bounce:0,duration:.24},className:"bg-token-main-surface-primary z-30",children:t.jsx(Z.div,{className:"bg-token-main-surface-primary dark:border-token-border-xlight @container w-full items-center border-t border-gray-100 p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] lg:border-s dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)]",children:t.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[t.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[t.jsx("span",{className:"text-md text-token-text-primary font-semibold text-wrap",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),t.jsx("span",{className:"text-token-text-secondary text-sm text-wrap",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),t.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[t.jsx(qt,{as:"button",color:"primary",onClick:s,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),t.jsx(qt,{as:"button",color:"secondary",onClick:e,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})})}const $o={type:"spring",bounce:.2,duration:.56},Zo=({clientThreadId:s,turn:e})=>{const n=Ys();return t.jsxs(Z.div,{className:"absolute start-0 end-0 top-0 z-10 -translate-y-full",children:[t.jsx(Z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"bg-vert-light-gradient dark:from-token-main-surface-primary absolute inset-0 -top-5 dark:bg-linear-to-t dark:to-transparent"}),t.jsx(Z.div,{className:"flex items-center py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,filter:"blur(8px)",transition:{delay:.4,duration:.72}},transition:$o,children:t.jsx(Xs,{clientThreadId:s,onRequestCompletion:oo,groupedMessagesToRender:e.messageGroups,allGroupedMessages:e.messageGroups,allMessages:e.messages,isUserTurn:!0,isFinalUserTurn:!1,isFinalAssistantTurn:!1,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n})})]},"user-message")},Yo=({clientThreadId:s})=>{const{lastUserTurn:e,lastAssistantTurn:n}=et(s,c=>{const r=os.getConversationTurns(c);let a=null,l=null;for(let g=r.length-1;g>0;g--){const i=r[g];if(!a&&i.role===Ut.User?a=i:!l&&i.role===Ut.Assistant&&(l=i),a&&l)break}return{lastUserTurn:a,lastAssistantTurn:l}}),o=e&&!n?.messages.some(c=>c.recipient?.startsWith(Js));return t.jsx(Pe,{initial:!1,children:o&&t.jsx(Zo,{turn:e,clientThreadId:s})})},Xo=({isRequestActive:s=!1,clientThreadId:e,readonlyReason:n,onCancel:o,onSubmit:c,onSubmitAccelerator:r,acceleratorActions:a=[]})=>{const[l,g]=f.useState(!1),[i,d]=f.useState(""),[x,y]=f.useState(!0),m=B(),[b,p]=f.useState(!1),h=ao(),u=C=>{c?.(C,i),d("")},T=C=>{if(C.nativeEvent.isComposing)return;const{metaKey:S,shiftKey:A,key:v}=C;v==="Enter"&&i.trim()&&!(A||S)&&(u(C),C.preventDefault())};return t.jsxs(t.Fragment,{children:[l&&!h&&t.jsx(fo,{zIndexKey:"acceleratorsOverlay",className:"bg-white/95 dark:bg-black/85"}),t.jsx("div",{className:"relative mb-3 flex items-end justify-center",children:t.jsxs("div",{className:"relative mx-6 max-w-2xl flex-1",children:[t.jsx(Yo,{clientThreadId:e}),t.jsx("div",{className:"flex flex-auto items-start",children:t.jsx("div",{className:pe("dark:bg-token-main-surface-secondary flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 ps-6 pe-2",{"rounded-full":x,"rounded-2xl":!x,"bg-transparent":b}),children:t.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[t.jsx(Io,{placeholder:m.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:s,value:i,className:pe("text-token-text-primary placeholder:text-token-text-secondary w-full resize-none border-0 bg-transparent p-0 outline-0 focus:ring-0 focus-visible:ring-0",{"opacity-0":b}),maxRows:4,onChange:({target:{value:C}})=>d(C),onKeyDown:T,onHeightChange:(C,{rowHeight:S})=>y(Math.floor(C/S)<=1)}),i?t.jsx(Z.button,{className:pe("dark bg-token-main-surface-primary h-8 w-8 rounded-full text-center disabled:bg-[#D7D7D7]",{"self-end":!x}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:u,children:t.jsx(en,{className:"text-token-text-primary h-8 w-8"})}):(a?.length??0)>0&&t.jsx(_o,{disableHint:!0,isVisuallyHidden:n?.isReadonly&&!n.isStreaming,disableOverlay:!0,isEmbeddedInPromptArea:!0,isRequestActive:s,actions:a,onCancel:o,onExpandedChange:C=>{h||p(C),g(C)},onSubmit:r,right:0,bottom:4})]})})})]})})]})};function Jo(s,e){const n=new Set(s.map(l=>l.id)),o=new Set(e.map(l=>l.id)),c=s.filter(l=>!o.has(l.id)).map(l=>({...l,diffStatus:kt.REMOVED})),r=e.filter(l=>!n.has(l.id)).map(l=>({...l,diffStatus:kt.ADDED})),a=s.filter(l=>o.has(l.id));return c.concat(r,a)}const ea=s=>{const{textdocId:e}=s,n=tn(o=>o?.resolveTempTextdocId[e]??e);return f.useMemo(()=>({...s,textdocId:n}),[n,s])};async function ta({textdocId:s,newTitle:e}){e!=null&&await V.safePost("/textdoc/{textdoc_id}/rename",{parameters:{path:{textdoc_id:s}},requestBody:{title:e}}).catch(n=>{as.addError("renameCanvasTitle Error:",n)})}const sa=({serverThreadId:s,textdocVersion:e,initialTitle:n="Untitled Document",isEditingTitle:o,setIsEditingTitle:c})=>{const r=tt(),{mutateAsync:a}=xe({mutationKey:[s,"textdocs"],mutationFn:ta,onMutate:async({textdocId:u,newTitle:T})=>{await r.cancelQueries({queryKey:[s,"textdocs"]});const C=r.getQueryData([s,"textdocs"]);return r.setQueryData([s,"textdocs"],S=>{if(!S)return S;const A=new Map(S.persistedTextdocVersionById),v=A.get(u);if(v){const M={...v,title:T??""};A.set(u,M)}const _=S.persistedTextdocVersions.map(M=>M.textdocId===u?{...M,title:T??""}:M),I=new Map(S.persistedTextdocById),R=I.get(u);if(R){const M={...R,title:T??""};I.set(u,M)}return{...S,persistedTextdocVersionById:A,persistedTextdocVersions:_,persistedTextdocById:I}}),{previousTextDocData:C}},retry:2,onError:(u,T,C)=>{C?.previousTextDocData&&r.setQueryData([s,"textdocs"],C.previousTextDocData),as.addError("Error updating title:",u)},onSettled:()=>{r.invalidateQueries({queryKey:[s,"textdocs"]})}}),l=async u=>{e&&await a({textdocId:e.textdocId??"",newTitle:u})},[g,i]=f.useState(n),d=f.useRef(null),x=f.useRef(g),y=f.useRef(!1);f.useEffect(()=>{o&&d.current&&(d.current.focus(),d.current.select())},[o]);const m=u=>{i(u.target.value)},b=()=>{x.current=g},p=async()=>{y.current||await l(g),y.current=!1,c(!1)},h=u=>{(u.key==="Enter"||u.key==="Escape")&&u.preventDefault(),u.key==="Enter"?u.currentTarget.blur():u.key==="Escape"&&(i(x.current),y.current=!0,u.currentTarget.blur())};return t.jsx("input",{className:"w-[300px] rounded-lg border-none px-3 py-2 outline-hidden",ref:d,value:g,onChange:m,onFocus:b,onBlur:p,onKeyDown:h,style:{fontSize:"1.125rem",fontWeight:"bold",boxSizing:"border-box",backgroundColor:"var(--global-states-light-element-hover, rgba(0, 0, 0, 0.05))"}})};function na(s){const{voiceName:e}=sn(),n=s?()=>oa(s.textdocId,e,ko()):null,o=`${s?.textdocId}.${s?.versionInt}.${e}`;return Mo(n,o)}function oa(s,e,n){return V.safeGet("/textdoc/{textdoc_id}/synthesize",{parameters:{path:{textdoc_id:s},query:{voice:e,format:n}},skipJsonTransform:!0})}const aa=({textdocVersion:s,isPersisting:e=!1,isTextdocAttachedPending:n,isTextdocStreaming:o,hasDebug:c,shouldShowPlayButton:r=!1,hideRenameButton:a=!1,toggleDebugView:l,isDebugVisible:g,toggleConsoleVisibility:i,isConsoleOpen:d,clientThreadId:x})=>{const y=B();nn(),na(s);const[m,b]=f.useState(!1),p=s?.title??"",h=rs(x)??"",u=Ne(s?.textdocId),T=!p||u?.status===on.INFERRING,C=()=>{b(!0)},[S,A]=f.useState(!1),{container:v,triggerRef:_}=is({isOpen:S,onClose:()=>A(!1)}),I=[!u&&!a&&!o?t.jsx(D.Item,{icon:an,onClick:C,children:y.formatMessage({id:"z/PT9T",defaultMessage:"Rename"})},"rename"):null,null,r?t.jsx(D.Item,{icon:rn,onClick:i,children:d?y.formatMessage({id:"owGHqE",defaultMessage:"Close console"}):y.formatMessage({id:"GPb4WX",defaultMessage:"Open console"})},"console"):null,null].filter(Boolean);if(I.length===0)return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex h-6 grow items-center overflow-hidden",children:t.jsx(ee.Title,{className:"@[0px]:hidden @[150px]:block",children:T?t.jsx("div",{className:"w-52",children:t.jsx(Ft,{lines:1,size:"base",width:100,widthVariance:0})}):p})}),e&&t.jsx(Rt,{size:12,className:"text-token-text-tertiary ps-1"})]});const R=s&&t.jsx(D.Portal,{container:v,children:t.jsx(D.Content,{onCloseAutoFocus:M=>M.preventDefault(),children:I})});return t.jsx(t.Fragment,{children:m?t.jsx(sa,{serverThreadId:h,textdocVersion:s,initialTitle:p,isEditingTitle:m,setIsEditingTitle:b}):t.jsxs(t.Fragment,{children:[!1,t.jsxs(D.Root,{open:S,onOpenChange:A,children:[t.jsxs(D.Trigger,{ref:_,className:"hover:bg-token-surface-hover grid grid-cols-[1fr_auto] bg-transparent! pe-2",children:[t.jsx(ee.Title,{className:"max-w-[270px] truncate overflow-hidden",children:T?t.jsx("div",{className:"w-52",children:t.jsx(Ft,{lines:1,size:"base",width:100,widthVariance:0})}):p}),t.jsx("div",{className:"flex items-center ps-1",children:e?t.jsx(Rt,{size:12,className:"text-token-text-tertiary"}):t.jsx(cn,{className:"icon-sm text-token-text-tertiary"})})]}),R]})]})})};function ra({textdocVersion:s,clientThreadId:e,color:n}){const{handleCopy:o,Icon:c,copyLabel:r}=go({textdocVersion:s,clientThreadId:e});return t.jsx(X,{label:r,children:t.jsx(Y,{icon:c,onClick:o,color:n})})}function ia({textdocVersion:s,disabled:e,color:n}){const o=B(),{handleFileDownload:c,handleBlobDownload:r,isLoading:a,downloadCopyLabel:l,isDocument:g}=xo(s);return g?t.jsxs(D.Root,{open:!a&&!e?void 0:!1,children:[t.jsx(D.BasicTrigger,{className:"hover:bg-transparent focus-visible:bg-transparent",children:t.jsx(X,{label:l,children:t.jsx(Y,{icon:Dt,disabled:a||e,color:n})})}),t.jsx(D.Portal,{children:t.jsxs(D.Content,{align:"end",children:[t.jsx(D.Item,{onClick:i=>{i.preventDefault(),c("pdf")},children:o.formatMessage({id:"canvas.download-pdf-button.menu",defaultMessage:"PDF Document (.pdf)"})}),t.jsx(D.Item,{onClick:i=>{i.preventDefault(),c("docx")},children:o.formatMessage({id:"canvas.download-docx-button.menu",defaultMessage:"Microsoft Word Document (.docx)"})}),t.jsx(D.Item,{onClick:i=>{i.preventDefault(),c("md")},children:o.formatMessage({id:"canvas.download-md-button.menu",defaultMessage:"Markdown Document (.md)"})})]})})]}):t.jsx(X,{label:l,children:t.jsx(Y,{icon:Dt,disabled:a||e,onClick:r,color:n})})}function ca({disabled:s=!1,isShowingChanges:e,onMouseEnter:n,onClick:o,onEsc:c}){const r=B(),a=f.useRef(null);return f.useEffect(()=>{if(e){const l=g=>{g.key==="Escape"&&(c?.(),a.current&&a.current===document.activeElement&&a.current.blur())};return window.document.addEventListener("keydown",l),()=>{window.document.removeEventListener("keydown",l)}}},[e,c]),t.jsx(X,{label:!s&&r.formatMessage(e?$t.hideChanges:$t.showChanges),children:t.jsx(Y,{icon:Do,ref:a,disabled:s,onClick:o,onMouseEnter:n,className:pe("transition-colors enabled:hover:bg-black/5 dark:enabled:hover:bg-white/10",e&&Ro)})})}const $t=Xt({showChanges:{id:"3jMGNS",defaultMessage:"Show changes"},hideChanges:{id:"HWiQSk",defaultMessage:"Hide changes"}});function la({disabled:s=!1,hasPreviousVersion:e,hasNextVersion:n,hideShowChanges:o,isShowingChanges:c,onHoverPrevious:r,onHoverShowChanges:a,onToggleShowChanges:l,onClickPrevious:g,onClickNext:i}){const d=B();return t.jsxs("div",{className:"flex items-center",children:[t.jsx(Pe,{children:!o&&t.jsx(Z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"spring",bounce:.24,duration:.4},children:t.jsx(ca,{disabled:s||!e,isShowingChanges:c,onMouseEnter:a,onClick:l,onEsc:l})})}),t.jsx(X,{label:e&&d.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:t.jsx(Y,{disabled:s||!e,icon:ln,onMouseOver:r,onClick:g})}),t.jsx(X,{label:n&&d.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:t.jsx(Y,{disabled:s||!n,icon:dn,onClick:i})})]})}function da(s){for(const e of ua){const n=s.match(e);if(n)return n[0]}return null}const ua=[/AKIA[0-9A-Z]{16}/,/AIza[0-9A-Za-z_-]{35}/,/^(?:ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9]{22}_[A-Za-z0-9]{59}|gho_[A-Za-z0-9]{36}|ghu_[A-Za-z0-9]{36}|ghs_[A-Za-z0-9]{36}|ghr_[A-Za-z0-9]{36})$/,/xox[baprs]-[0-9A-Za-z-]+/,/sk-[A-Za-z0-9]{48}/,/SK[0-9a-fA-F]{32}/,/(sk_live_[0-9a-zA-Z]{24})|(sk_test_[0-9a-zA-Z]{24})/,/-----BEGIN PRIVATE KEY-----/],ma=`${Po}...`;function re(s){return["canvas","textdoc","share",s]}function fa({isLoading:s,isPublishedVersionLatest:e,sharedTextdoc:n,textdocVersion:o,title:c}){const{textdocId:r}=o,[a,l]=f.useState(!1),g=da(o.content),i=(v,_)=>{v&&hn(v,void 0,_).then(()=>{l(!0),setTimeout(()=>{l(!1)},1500)}).catch(()=>{})},d=tt(),{mutate:x,isPending:y}=xe({scope:{id:r},mutationFn:v=>V.safePost("/textdoc/{textdoc_id}/share",{parameters:{path:{textdoc_id:v}}}).then(_=>ke(_.shared_textdoc)),onSuccess:v=>{d.setQueryData(re(r),v),i(Ze(v.sharedTextdocId))}}),{mutate:m,isSuccess:b}=xe({scope:{id:r},mutationFn:v=>V.safePost("/textdoc/shared/{shared_textdoc_id}/update_to_latest",{parameters:{path:{shared_textdoc_id:v}}}).then(_=>ke(_.shared_textdoc)),onSuccess:v=>{d.setQueryData(re(r),v)}}),{mutate:p}=xe({scope:{id:r},mutationFn:({sharedTextdocId:v,access:_})=>V.safePost("/textdoc/shared/{shared_textdoc_id}/update_access",{parameters:{path:{shared_textdoc_id:v}},requestBody:{shared_textdoc_access:_}}).then(I=>ke(I.shared_textdoc)),onMutate:({access:v})=>{const _=re(r),I=d.getQueryData(_);return d.setQueryData(_,I&&{...I,access:v}),{previousAccess:I?.access}},onSuccess:v=>{d.setQueryData(re(r),v)},onError:(v,_,I)=>{const R=re(r),M=d.getQueryData(R);d.setQueryData(R,M&&{...M,access:I?.previousAccess})}}),h=f.useRef(null),u=v=>{h.current?.focus(),n?(k.logButtonClick(L.COPY_SHARE_LINK,ge(o)),i(Ze(n.sharedTextdocId),v)):(k.logButtonClick(L.CREATE_SHARE_LINK,ge(o)),x(r))},T=v=>{n&&(k.logButtonClick(v===pn.PUBLIC?L.UPDATE_SHARE_LINK_PUBLIC:L.UPDATE_SHARE_LINK_PRIVATE,ge(o)),p({sharedTextdocId:n.sharedTextdocId,access:v}))},C=n?Ze(n.sharedTextdocId):void 0,S=()=>{n&&(k.logButtonClick(L.UPDATE_SHARE_LINK_TO_LATEST,ge(o)),m(n.sharedTextdocId))},A=g||n?.isAnonifyApiKeyDetected;return t.jsx(No,{inputRef:h,isLoading:s,isPublishedVersionLatest:e,sharedObject:n&&{id:n.sharedTextdocId,title:c,access:n.access,versionInt:n.versionInt,isModerationBlocked:n.isModerationBlocked,isAnonifyApiKeyDetected:n.isAnonifyApiKeyDetected},title:c,shareTextPlaceholder:ma,shareUrl:C,isCopySuccessful:a,didPublishUpdates:b,isCreateLinkRequestInProgress:y,handleUpdateLatestSharedVersion:S,handlePrivacyChange:T,handlePrimaryButtonClick:u,maybeRenderWarndingContent:()=>t.jsx(t.Fragment,{children:A&&t.jsx(xa,{})})})}function ge(s){return{textdocType:s.type,textdocId:s.textdocId}}function ga({textdocVersion:s,isDisabled:e,title:n}){const o=ro(),c=B(),r=s?.textdocId,{data:a,isLoading:l}=qs({enabled:!!r&&!e,queryKey:re(r),queryFn:()=>!r||r.startsWith(vn)?Promise.resolve(null):V.safeGet("/textdoc/{textdoc_id}/share",{parameters:{path:{textdoc_id:r}}}).then(h=>h.shared_textdoc&&ke(h.shared_textdoc))}),[g,i]=f.useState(!1),{triggerRef:d,container:x}=is({isOpen:g,onClose:()=>i(!1)}),y=o?.isWorkspaceAccount()&&!o?.features.includes(un.WorkspaceShareLinks);if(e||y||!s)return t.jsx(X,{label:y?c.formatMessage(Ye.workspaceSharingDisabled):c.formatMessage(Ye.share),children:t.jsx(Y,{disabled:!0,icon:Pt})});const m=()=>{k.logButtonClick(L.OPEN_SHARE_MENU,ge(s))},b=a?.versionInt===s.versionInt&&a?.title===s.title,p=({className:h})=>t.jsxs("div",{className:"relative h-fit w-fit",children:[t.jsx(Pt,{className:h}),!b&&a&&t.jsx("div",{className:"absolute end-0 top-[1px] flex items-center gap-1.5",children:t.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-blue-400"})})]});return t.jsxs(mn,{open:g,onOpenChange:i,children:[t.jsx(X,{label:c.formatMessage(Ye.share),children:t.jsx(fn,{ref:d,asChild:!0,children:t.jsx(Y,{icon:p,onClick:m})})}),t.jsx(Pe,{children:g&&t.jsx(gn,{forceMount:!0,container:x,children:t.jsx(xn,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:t.jsx(fa,{title:n,sharedTextdoc:a,isLoading:l,isPublishedVersionLatest:b,textdocVersion:s})})})})]})}function xa(){return t.jsx(Cn,{type:"danger",className:"w-auto md:p-3",children:t.jsx(ce,{id:"8NG6sN",defaultMessage:"There may be an API key in your canvas. If you share the canvas, anyone with the link can see its contents."})})}const ha=({clientThreadId:s,isHistoricalVersion:e,textdocVersion:n,readonlyReason:o,hasDebug:c,isEmbedded:r,isPersisting:a,isShowingChanges:l,hideRunCode:g=!1,hideHistoryActions:i=!1,hideRenameButton:d=!1,onHoverPrevious:x,onHoverShowChanges:y,onToggleShowChanges:m,onClickPrevious:b,onClickNext:p,onClickCodePreview:h,onClose:u,toggleDebugView:T,toggleConsoleVisibility:C,isCodeRunning:S,isTextdocAttachedPending:A,isTextdocStreaming:v,isConsoleOpen:_,isDebugVisible:I})=>{const R=B(),M=cs(),le=Ne(n?.textdocId),J=n?.title??"",{isCodePreviewable:te,isCodeExecutable:P,hasCanvasCodeExecution:H}=ms(n),Ce=!g&&(te||P),N=n?.versionInt,de=N!=null&&N>1,ve=e,Le=!i,Be=te&&S,ye=n==null||le!=null||e||o.isStreaming,q=n==null||o.isStreaming;return t.jsxs(ee.Header,{className:pe("@container",te&&S&&"bg-transparent!"),children:[t.jsx(ee.CloseButton,{onClick:u}),t.jsx("div",{className:"@container flex flex-1 basis-0 items-center truncate leading-[0]",children:t.jsx(aa,{hasDebug:c,isConsoleOpen:_,isDebugVisible:I,toggleConsoleVisibility:C,toggleDebugView:T,isPersisting:a,textdocVersion:n,isTextdocAttachedPending:A,isTextdocStreaming:v,shouldShowPlayButton:Ce,hideRenameButton:d,clientThreadId:s})}),t.jsxs("div",{className:"flex min-w-0 basis-auto items-center leading-[0] select-none",children:[Le&&t.jsx(la,{hideShowChanges:Be,disabled:o.isStreaming,hasNextVersion:ve,hasPreviousVersion:de,isShowingChanges:l,onHoverPrevious:x,onHoverShowChanges:y,onToggleShowChanges:m,onClickPrevious:b,onClickNext:p}),t.jsx(ra,{clientThreadId:s,textdocVersion:n}),n&&n.type!==me.LOADING&&le==null&&t.jsx(ia,{disabled:q,textdocVersion:n}),t.jsx(ga,{isDisabled:ye,textdocVersion:n,title:J}),Ce&&t.jsx(Fs,{clientThreadId:s,isCodePreviewable:te,isDisabled:!H||o.isTextdocStreaming&&!S,disabledTooltip:H?void 0:R.formatMessage({id:"NTZRWe",defaultMessage:"Code execution for canvas is disabled for your workspace. Contact your admin to enable."}),onClick:h,isCodeRunning:S}),!r&&!M&&t.jsx(Oo,{clientThreadId:s})]})]})},pa=s=>{const e=ls(),n=ds(e,"80186230"),o=cs(),{eligible:c,isLoading:r,markAsViewed:a}=es(s);return{markAsViewed:a,eligible:!o&&c&&n,isLoading:r}};function Ca(){return pa(ts.hasDismissedCanvasContextualOnboarding)}function va(s){const e=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,o=s.matchAll(e);for(const c of o){const r=c[2];try{let a=r;a.startsWith("www.")&&(a="http://"+r),new URL(a),n.add(r)}catch{}}return n}const ya=async({lastVersion:s,textdocId:e,content:n,comments:o})=>{const c=yn(o,n);return(await V.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:e}},requestBody:{version:s,content:n,comments:c}})).version},ba=()=>{const s=f.useRef([]),e=f.useRef(null),{mutateAsync:n,isPending:o}=xe({mutationKey:["canvas","textdoc","persist"],mutationFn:ya});return[f.useCallback(async(r,a,l)=>{const g=new AbortController,d=(async()=>{const[b]=s.current;try{await b?.promise}catch(p){k.logError("Saving document",p)}if(!g.signal.aborted)try{const p=Math.max(e.current??0,r.versionInt??ss);let h="";try{Qt(a)?h=a():h=a}catch(S){k.logError("Serializing document",S)}let u=[];try{Qt(l)?u=l():u=l}catch(S){k.logError("Adjusting comments",S)}const{textdocId:T}=r;bn({textdocId:T,basedOnVersionInt:p,content:h,comments:u});const C=await n({textdocId:T,lastVersion:p,content:h,comments:u});Tn({textdocId:T,basedOnVersionInt:p,newVersion:C}),e.current=C}catch(p){k.logError("Error saving document",p)}finally{s.current.shift()}})(),x={abort:()=>g.abort(),promise:d},[y,m]=s.current;return m&&(m.abort(),s.current=y?[y]:[]),s.current=y?[y,x]:[x],d},[n]),s,o]},Ta=3e3,Sa=s=>{const[e,n,o]=ba(),c=B(),r=f.useRef(null),a=f.useCallback(Sn(async(i,d,x)=>{if(!Xe(i))return e(i,d,x);Re.replaceTempTextdocContent(i.textdocId,typeof d=="string"?d:d())},Ta,{leading:!1}),[e]),l=wn(s);return f.useEffect(()=>{if(!l)return;const i=Gt(window,{pagehide:()=>a.flush(),beforeunload:x=>{a.flush(),x.returnValue=c.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),d=Gt(document,{visibilitychange:()=>a.flush(),keydown:()=>{r.current="keyboard"},mousemove:()=>{r.current!=="mouse"&&a.flush(),r.current="mouse"}});return()=>{r.current=null,d(),i()}},[c,l,a]),f.useEffect(()=>()=>{a.flush()},[s,a]),En(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:i})=>i)??[])}),[f.useCallback((i,d,x)=>{const{textdocId:y}=i;return Xe(i)||An(y),a(i,d,x)},[a]),a.flush,o||l]};function wa(s,e,n){const o=tt(),c=n!=null&&e!=null,{data:r,error:a,fetchNextPage:l,hasNextPage:g,isFetching:i}=Us(Zt(s,e,c)),d=f.useCallback(async()=>{const p=e!=null;await o.prefetchInfiniteQuery(Zt(s,e,p))},[o,s,e]);f.useEffect(()=>{const p=e;return()=>{o.removeQueries({queryKey:fs(s,p),exact:!0})}},[o,s,e]);const[x,y,m,b]=f.useMemo(()=>{if(r&&n){const h=r.pages.flatMap(T=>T),u=h.findIndex(T=>"beforeVersion"in n?(T.versionInt??ss)<n.beforeVersion:T.versionInt===n.version);if(u!==-1)return[u===h.length-1,h[u],u>0?h[u-1]:null,u<h.length-1?h[u+1]:null]}const p=r?.pages.flatMap(h=>h)??[];return[!0,null,null,p.length===0?null:p[0]]},[r,n]);return f.useEffect(()=>{!i&&c&&g&&x&&l()},[i,c,g,x,l]),f.useEffect(()=>{!y&&a&&fe(s)},[y,a,s]),{historicalTextdocVersion:y,nextHistoricalTextdocVersion:m,prefetchHistoricalTextdocVersion:d,previousHistoricalTextdocVersion:b}}function fs(s,e=null){return["textdocHistory",s,e]}function Zt(s,e,n=!0){return{queryKey:fs(s,e),queryFn:({pageParam:o})=>Ea(s,o),initialPageParam:e??void 0,getNextPageParam:o=>{const c=io(o)?.versionInt;if(c&&c>1)return c},enabled:n,staleTime:1/0,retry:2}}async function Ea(s,e){return e===void 0||e<=1?[]:(await V.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:s},query:{before_version:e}}})).previous_doc_states.map(({id:o,version:c,textdoc_type:r,title:a,content:l,updated_at:g,comments:i,metadata:d})=>({textdocId:o,versionInt:c,messageId:null,title:a,type:_n(r),content:l,status:Jt.COMPLETE,createdAt:co(g),comments:jn(i,l),metadata:{content_references:d?.content_references}}))}const Za=({isFullScreen:s=!1,isEmbedded:e=!1,hideHeader:n=!1,hideRunCode:o=!1,isReadonlyFromQueryParam:c=!1,hideRenameButton:r=!1,clientThreadId:a,focusedTextdoc:l,onClose:g,isAnimating:i=!1,width:d,hideBottomComposer:x=!1})=>{const y=ls(),{textdocId:m,history:b,showChangesAtVersion:p=null,shouldRunCodeOnOpen:h=!1}=ea(l),u=B(),[T,C,S]=Sa(m),{targetedContent:A}=In(),v=Mn(),[_,I]=f.useState(!1),[R,M]=f.useState(!1),le=kn(m),J=Rn(),te=et(a,os.getRequestId),P=Dn(te),{data:H,isLoading:Ce}=Pn(m,p),[N,de]=f.useState(!1),[ve,Le]=f.useState(null),Be=Nn(a),ye=f.useRef(null),q=le?.versions??[],se=q[0]?.versionInt,{historicalTextdocVersion:be,nextHistoricalTextdocVersion:gs,previousHistoricalTextdocVersion:xs,prefetchHistoricalTextdocVersion:st}=wa(m,se,b),nt=On();f.useEffect(()=>{De.reset()},[m]);const ot=q.length>0?q[q.length-1]:null,He=q.length>1?q[q.length-2]:null,at=rs(a),{restoreHistoricalTextdocVersion:hs,optimisticRestoredTextdocVersion:ps}=Ln(at,ot,be),ne=b!=null,E=ne?be:ot,G=p!=null,ue=Gs(a,E),rt=i?null:H,Te=(()=>{if(i||E==null)return[];const w=Kt(E.comments);return!G&&be!=null?be.comments:!G||H==null?w:H.contentBefore!==H.contentAfter?[]:Jo(H.commentsBefore,H.commentsAfter)})(),O=E?.type??me.LOADING,qe=Bn(),it=Xe(E),Q=Hn(E),Ue=qn(E),ct=Un(E),Cs=ct&&!e,vs=Vt(J),ys=Vt(P);f.useEffect(()=>{!it&&q.length===0&&qe!==Nt.NATIVE&&(!J&&vs.current||!P&&ys.current||!J&&!P)&&g?.()},[q.length,J,P]);const{content:K,currentlyStreamingLineIndex:lt}=H?.contentBefore!=null&&!he(O)?{content:H.contentBefore,currentlyStreamingLineIndex:null}:ho(E,He),bs=Lo(at,Array.from(va(K))),[Se,Fe]=Vo({value:K,isRequestActive:P,isTextdocStreaming:Q,comments:Te}),dt=Fn(E),ut=qe===Nt.LAST_TURN||Se||S;f.useEffect(()=>{Gn().sendMessage({type:us.Streaming,streaming:ut})},[ut]);const Ts=({getSerializedDocument:w,getAdjustedComments:j})=>{E&&T(E,w,j)},Ss=w=>{if(!E)return;const j=w.doc.toString();T(E,j,w.field(yo,!1)??[])},mt=(w,j,z,$,oe)=>{Fe(!0),ue({sourceEvent:w,action:z,content:j,userMessageType:Ie.ASK_CHATGPT,sourceRange:$,selectionMetadata:{selection_type:oe,selection_position_range:$}})},ft=({id:w})=>{dt(w,Bt.DISMISS),De.reset()},gt=async(w,j)=>{Fe(!0);const{id:z,at:$,content:oe}=j;if(await dt(z,Bt.ACCEPT)===!1)return Fe(!1);ue({sourceEvent:w,content:oe,userMessageType:Ie.ACCEPT_COMMENT,sourceRange:$,action:Wt.EDIT,selectionMetadata:{selection_type:zt.SELECTION,selection_position_range:$}})},Ge=(w,j,z,$)=>{const{action:oe}=$;ue({sourceEvent:w,action:oe,content:z,sourceRange:j,userMessageType:Ie.ACCELERATOR,acceleratorMetadata:{action:oe,id:$.id,prompt:z},selectionMetadata:j!=null?{selection_type:zt.SELECTION,selection_position_range:j}:void 0})},ws=(w,j)=>{ue({sourceEvent:w,action:Wt.EDIT,content:j,userMessageType:Ie.FULL_SCREEN_SUBMIT})},Es=Kn(),xt=w=>Es?.[w]??w,Ke=()=>zn(a,void 0,!0),As=()=>{b?Me(m,b):fe(m)},U=wo({streamingSource:qe,isRestoring:ps!=null,isRequestActive:P,isTextdocStreaming:Q,isReadonlyFromQueryParam:c,isHistoricalVersion:ne,isShowingChanges:G});let we=null;const ht=i||U.isReadonly||Se,Ee=ns()||Be||c||it,pt=()=>i&&Te.length>0?ae.ALL_HIDDEN:Ee?ae.COMMENTS_READONLY:U.isReadonly?U.isStreaming?ae.ENABLED:U.isReadonlyFromQueryParam||U.isShowingChanges||U.isHistoricalVersion?ae.COMMENTS_READONLY:ae.ALL_HIDDEN:ae.ENABLED,js=f.useCallback(async w=>{const{suggestion:j}=await V.safePost("/textdoc/{textdoc_id}/autocomplete",{parameters:{path:{textdoc_id:m}},requestBody:{content:w}});return j},[m]),Ct=s||i||c;let ze=[];switch(O){case me.LOADING:we=t.jsx(vo,{});break;case me.DOCUMENT:we=t.jsx(Co,{value:K,comments:Te,previousValue:He?.content,getAutocompleteSuggestion:js,previousComments:Kt(He?.comments),isRewriting:Ue,isAnimatingFromPreview:i,isSendDisabled:Ee,getStableCommentId:xt,diff:rt,isRequestActive:P,isDisabled:U.isReadonly||J,isWaitingForCommentResponse:Se,hideAccelerators:Ct,hideToolbar:ht,hideEditOverlay:i,commentsMode:pt(),readonlyReason:U,onBlur:C,onSave:C,onChange:Ts,onCancelRequest:Ke,targetedContent:A,onAddComment:mt,onAcceptComment:gt,onDismissComment:ft,onSubmitAccelerator:Ge,onExitShowChanges:As,safeUrls:bs,width:d,modelCursor:ct||Q&&!Ue?E?.modelCursor:void 0,shouldResetSelection:E?.versionInt===1,metadata:le?.metadata}),ze=jo;break;default:he(O)&&(we=t.jsx(po,{id:"codemirror",getStableCommentId:xt,language:Eo(O),value:K,comments:Te,hideAccelerators:Ct,commentsMode:pt(),hideToolbar:ht,onSubmitAccelerator:Ge,currentlyStreamingLineIndex:lt??null,readonlyReason:U,isRequestActive:P,isSendDisabled:Ee,isWaitingForCommentResponse:Se,onChange:Ss,onCancelRequest:Ke,onAddComment:mt,onBlur:C,onSave:C,codemirrorRef:ye,onDismissComment:ft,onAcceptComment:gt,textdocDiff:rt??void 0,modelCursor:Q&&lt==null?E?.modelCursor:void 0}),ze=bo)}const We=f.useRef(null),Ae=f.useRef(null),{hasCanvasCodeExecution:Ve,isCodeExecutable:vt,isCodePreviewable:W}=ms(E),yt=Ve&&W,bt=Ve&&vt,_s=Wn(),Tt=f.useCallback(()=>{!N&&(yt||bt)?(de(!0),We.current?.runCode(O,K).finally(()=>de(!1))):(We.current?.stopCode(),de(!1))},[yt,bt,N,K,O]),St=Vn(()=>{Tt()});f.useEffect(()=>{h&&St()},[h,St]);const{eligible:Is,markAsViewed:Ms}=Ca(),F=E?.versionInt,ks=F!=null&&F>1,Rs=ne,je=xs?.versionInt,Qe=gs?.versionInt,Ds=()=>{G?b?Me(m,b):fe(m):(k.logButtonClick(L.SHOW_CHANGES,{textdocType:O,textdocId:m,versionInt:F,latestVersionInt:se}),F&&Ht(m,F,b))},Ps=()=>{k.logButtonClick(L.HISTORY_PREVIOUS,{textdocType:O,textdocId:m,versionInt:F,latestVersionInt:se,isShowingChanges:G}),m&&F&&ks&&Me(m,{beforeVersion:F},G&&je!=null?je:void 0)},Ns=()=>{k.logButtonClick(L.HISTORY_NEXT,{textdocType:O,textdocId:m,versionInt:F,latestVersionInt:se,isShowingChanges:G}),Rs&&(Qe?Me(m,{version:Qe},G?Qe:void 0):G&&se?Ht(m,se,null):fe(m))},Os=ds(y,"1804926979"),wt=et(a,Bo(m)),Ls=lo(),Et=Ne(E?.textdocId),Bs=!n&&t.jsx(ha,{hideRunCode:o,clientThreadId:a,isHistoricalVersion:ne,textdocVersion:E,readonlyReason:U,hasDebug:v,isEmbedded:e,isPersisting:S,isShowingChanges:G,isConsoleOpen:R,isDebugVisible:_,hideHistoryActions:c,hideRenameButton:r,onHoverPrevious:()=>{st(),je&&nt(m,je)},onHoverShowChanges:()=>{st(),F&&nt(m,F)},onToggleShowChanges:Ds,onClickPrevious:Ps,onClickNext:Ns,toggleDebugView:()=>I(w=>!w),toggleConsoleVisibility:()=>{R||uo.logEvent("Canvas Open Console Clicked"),M(w=>!w)},onClose:()=>{if(k.logButtonClick(L.CLOSE_TEXTDOC,{textdocType:E?.type}),Ms(),Et&&!s){const{create_source:w,hasUserEdits:j,tempTextdocId:z}=Et;if(j&&w!==Lt.USER_CREATED_COMPOSER){_t(!0);return}Re.removeTempTextdoc(z),w===Lt.USER_CREATED_COMPOSER&&Ls.appendText(K)}g?.()},onClickCodePreview:Tt,isCodeRunning:N,isTextdocStreaming:Q,isTextdocAttachedPending:Ot(E)});let At=null;const _e=!o&&Ve&&(vt||W),$e=Ao(O,K);f.useEffect(()=>{_e&&($e&&Ae.current?.prepareEnvironment($e),W&&N&&!Q&&mo(Ae.current)?.updateCode(K))},[_e,$e,Q]);const jt=E?.title??"";_e&&(At=t.jsx(Ks,{title:jt,onChangeBackgroundColor:Le,visuallyHidden:!W||!N,disableNetworkRequests:!_s,networkAccessDeniedMessage:u.formatMessage({id:"GE4AJf",defaultMessage:"Network requests in canvas are disabled for your workspace. Contact your admin to enable this feature."}),enableTransition:W&&O!==me.CODE_HTML,isCodeUpdating:Q,ref:Ae}));const[Hs,_t]=f.useState(!1),It=t.jsx(Ho,{isOpen:Hs,dismissModal:()=>_t(!1),closeTextdocEditor:()=>{g?.()},textdocVersion:E,clientThreadId:a}),Mt=t.jsxs(t.Fragment,{children:[Bs,t.jsx(ee.Content,{scrollToBottomMode:Cs?"bottom":"top",shouldScrollToTop:Ue,isLoading:Ce,hideChildren:W&&N,overlay:At,children:we}),_e&&t.jsx(zs,{ref:We,sandboxRef:Ae,textdocId:m,textdocTitle:jt,textdocContent:K,isTextdocAttachedPending:Ot(E),highlightLine:w=>ye.current?.highlightLine(w),isRequestActive:P,createTextdocTurn:ue,isOpen:R,onOpenChange:M}),t.jsx(Pe,{children:ne&&!c&&t.jsx(Qo,{onClickRestore:hs,onClickResetLatest:()=>fe(m)})}),s&&!ne&&!x&&!(N&&W)&&!Ee&&t.jsx(Xo,{isRequestActive:P,clientThreadId:a,onSubmitAccelerator:Ge,onSubmit:ws,onCancel:Ke,readonlyReason:U,acceleratorActions:ze}),!i&&!e&&Is&&t.jsx(Wo,{textdocType:O})]});if(Os&&wt&&E){const j=new URLSearchParams(window.location.search).get(Ws),z=j==null?void 0:parseInt(j);return t.jsxs(t.Fragment,{children:[It,t.jsx(ee,{previewBackgroundColor:ve,isPreviewingCode:W&&N,children:t.jsxs("div",{className:"flex h-full",children:[t.jsx("div",{className:"relative flex h-full min-h-0 flex-auto grow flex-col",children:Mt}),t.jsx(Vs,{hiveId:wt,clientThreadId:a,textdocVersion:E,ts:z})]})})]})}return t.jsxs(t.Fragment,{children:[It,t.jsx(ee,{previewBackgroundColor:ve,isPreviewingCode:W&&N,children:Mt})]})};export{us as C,Za as T};
//# sourceMappingURL=c8ep7627nr5x9804.js.map
