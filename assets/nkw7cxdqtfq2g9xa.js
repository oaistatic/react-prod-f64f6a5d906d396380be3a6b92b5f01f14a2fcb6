import{hJ as E,hD as i,hE as I,cX as R,mi as O,R as v,mj as w,mk as N,hF as m,hW as A}from"./g670b8vtkhx0yc6d.js";import{r as S}from"./gg0tb34p9fzo1omt.js";import{m as k}from"./jmquhb7hx6l9kqbx.js";import{aO as d,aP as f}from"./forbprkns1cohsbl.js";function re({composerController:a,parsedDocumentHandler:n}){const{connectorConfig:s}=E();return S.useEffect(()=>{const t=()=>{const e=P(a,s);n(e)};return t(),a.subscribe("change",t)},[a,s,n]),null}function P(a,n){const s=a.getCurrentText(),t=[];for(const e of n.values())switch(e.type){case i.GDRIVE:{if(e.link_enabled??!0){const r=b(s,e);t.push(...r),e.access_token&&r.reduce((c,l)=>c.replace(l.url,""),s)!==s&&r.forEach(({url:c})=>a.replaceAll(c,""))}break}case i.O365:break;case i.O365_BUSINESS:{const r=z(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}case i.O365_PERSONAL:{const r=L(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}case i.CONFLUENCE:{const r=F(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}case i.JIRA:{const r=M(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}case i.NOTION_OPEN_CONNECTOR:{const r=Z(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}case i.SLACK_OPEN_CONNECTOR:{const r=K(s,e).filter(o=>o!=null);e.access_token&&r.forEach(({url:o})=>a.replaceAll(o,"")),t.push(...r);break}}return t.length&&I.linkPasted(k(R(t,e=>e.type),e=>e.length)),t}const C=/\bhttps:\/\/docs\.google\.com\/(document|spreadsheets|presentation)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,T=/\bhttps:\/\/drive\.google\.com\/(file)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,x="https://www.googleapis.com/auth/drive.readonly";function b(a,n){return[...a.matchAll(C),...a.matchAll(T)].map(s=>{const t={url:s[0],id:s[2],type:i.GDRIVE};return n.access_token&&n.scopes&&n.scopes.includes(x)?{...t,handler:{type:"fetch",tryFetch:async()=>{f.logAttemptIfAccessTokenIsExpired(n,m.Link);const r=`https://www.googleapis.com/drive/v3/files/${t.id}?fields=name,mimeType`,o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${n.access_token}`,"Content-Type":"application/json"}});if(!o.ok)return Promise.reject(new Error(`HTTP ${o.status}`));const{name:c,mimeType:l}=await o.json(),u=A(l);return{connector:i.GDRIVE,id:t.id,title:c,mimeType:l,url:t.url,syntheticExtension:u}}}}:{...t,handler:{type:"prompt",message:"not-connected"}}})}function g(a){let n;try{n=new URL(a).toString()}catch{return null}return`u!${btoa(n).replaceAll("=","").replaceAll("/","_").replaceAll("+","-")}`}const D=/\bhttps:\/\/onedrive\.live\.com\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,U=/\bhttps:\/\/photos\.onedrive\.com\/(?:share|photo)\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,$=/\bhttps:\/\/1drv\.ms\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm;function L(a,n){return[...a.matchAll(D),...a.matchAll($),...a.matchAll(U)].map(s=>{const t=g(s[0]);if(!t)return null;const e={url:s[0],id:t,type:i.O365_PERSONAL};return n.access_token?{...e,handler:{type:"fetch",tryFetch:y(d.OneDrive_PERSONAL_SHARES,t,n.access_token,n)}}:{...e,handler:{type:"prompt",message:"not-connected"}}})}const j=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/wiki\/spaces\/[^\s]+\/pages\/(\d+)\/([^\s]+)?/gm;function F(a,n){return[...a.matchAll(j)].map(s=>{const t=s[1],e=s[2],r=s[3];if(!e)return null;const o={url:s[0],id:e,type:i.CONFLUENCE};return n.access_token?{...o,handler:{type:"fetch",tryFetch:async()=>{let c=r;return!r&&n.access_token&&(c=await X(n.access_token,`https://${t}`,n,e)),{connector:n.type,id:e,title:c,mimeType:"text/html",url:o.url,syntheticExtension:null,manifest:{id:e,domain:t,type:N.PAGE,manifest_type:i.CONFLUENCE}}}}}:{...o,handler:{type:"prompt",message:"not-connected"}}})}const B=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/browse\/([^\s]+)\??/gm,G=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/jira\/(?:[^\s]+\/)*projects\/(?:[^\s]+\/)+(?:[^\s]+\/?)\?selectedIssue=([^\s]+)&?/gm;function M(a,n){return[...a.matchAll(B),...a.matchAll(G)].map(s=>{const t=s[1],e=s[2];if(!e||!t)return null;const r={url:s[0],id:e,type:i.JIRA};return n.access_token?{...r,handler:{type:"fetch",tryFetch:async()=>{const o=await Q(n.access_token,`https://${t}`,n,e);return Promise.resolve({connector:n.type,id:e,title:o,mimeType:"text/markdown",url:r.url,syntheticExtension:null,manifest:{id_or_key:e,domain:t,manifest_type:i.JIRA}})}}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const J=/\bhttps:\/\/[^\s]+?\.sharepoint\.com\/[^\s]*/gm;function z(a,n){return[...a.matchAll(J)].map(s=>{const t=g(s[0]),e=d.OneDrive_BUSINESS_SHARES;if(!t)return null;const r={url:s[0],id:t,type:i.O365_BUSINESS};return n.access_token?{...r,handler:{type:"fetch",tryFetch:y(e,t,n.access_token,n)}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const H=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/?\??$/gm,V=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/p(?<message_id>[^\s?&]+)(?:\?(?:.*thread_ts=(?<thread_id>[^\s&]+)(?:&.*))?)?/gm;function K(a,n){return[...a.matchAll(V),...a.matchAll(H)].map(s=>{const t=s.groups?.domain;if(!t)throw new Error(`No domain found in match ${JSON.stringify(s)}`);const e=s.groups?.conversation_id;if(!e)throw new Error(`No conversation ID found in match ${JSON.stringify(s)}`);const r=s.groups?.message_id;let o=null;r&&(o=`${r.slice(0,10)}.${r.slice(10)}`);const c=s.groups?.thread_id??null;let l="Conversation",u=`conversation-${e}`;o?(l="Message",u=`message-${o}`):c?(l="Thread",u=`thread-${c}`):e[0]==="D"&&(l="Direct message");const p={id:u,url:s[0],domain:t,conversationId:e,messageId:o,threadId:c,type:i.SLACK_OPEN_CONNECTOR};return n.access_token?{...p,handler:{type:"fetch",tryFetch:async()=>n.access_token?Promise.resolve({connector:n.type,id:p.id,title:l,mimeType:"application/json",url:p.url,syntheticExtension:null,manifest:{conversation_id:p.conversationId,domain:p.domain,manifest_type:i.SLACK_OPEN_CONNECTOR,message_id:p.messageId,thread_id:c,type:O.MESSAGE}}):Promise.reject(new Error("Not connected"))}}:{...p,handler:{type:"prompt",message:"not-connected"}}})}function y(a,n,s,t,e){switch(a){case d.OneDrive_BUSINESS_SHARES:case d.OneDrive_PERSONAL_SHARES:return()=>h(`${a}/${encodeURIComponent(n)}/driveItem`,s,t);case d.OneDrive_BUSINESS_DRIVE_ITEMS:return()=>h(`${a}/${encodeURIComponent(n)}`,s,t);case d.OneDrive_BUSINESS_DRIVE_ROOT:return async()=>{const r=await q(s,n);if(!r)return Promise.reject(null);const o=`${a}:${encodeURIComponent(r)}`;return h(o,s,t)};case d.OneDrive_PERSONAL_DRIVE_ITEMS:return()=>Promise.reject(null)}}async function q(a,n){const t=await fetch("https://graph.microsoft.com/v1.0/me/drive/root",{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!t.ok)return null;const{webUrl:e}=await t.json(),o=new URL(e).pathname;return n.startsWith(o)?n.substring(o.length):n}async function h(a,n,s,t){f.logAttemptIfAccessTokenIsExpired(s,m.Link);const e=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!e.ok)return Promise.reject(new Error(`HTTP ${e.status}`));const{id:r,name:o,file:c,webUrl:l,...u}=await e.json();return t||(t=u.parentReference?.driveId),{connector:s.type,id:r,title:o??"",mimeType:c?.mimeType??"",url:l??"",syntheticExtension:null,o365DriveId:t}}const W="https://api.atlassian.com/oauth/token/accessible-resources";async function _(a,n,s){f.logAttemptIfAccessTokenIsExpired(s,m.Link);const e=(await fetch(W,{headers:{Authorization:`Bearer ${a}`}}).then(r=>r.json())).find(r=>r.url===n)?.id;return e||Promise.reject(new Error("Cloud ID not found"))}async function X(a,n,s,t){const e=await _(a,n,s);return(await fetch(`https://api.atlassian.com/ex/confluence/${e}/wiki/api/v2/pages/${t}?include-version=false`,{headers:{Authorization:`Bearer ${a}`}}).then(c=>c.json())).title??"Confluence Page"}async function Q(a,n,s,t){const e=await _(a,n,s);return(await fetch(`https://api.atlassian.com/ex/jira/${e}/rest/api/2/issue/${t}?fields=summary`,{headers:{Authorization:`Bearer ${a}`}}).then(c=>c.json())).fields.summary??"Jira Issue"}const Y=/\bhttps:\/\/www\.notion\.so\/(?:.*?)?(?<page_id>[a-f0-9]{32})(?:\?[\x21-\x7e]*)?/gm;function Z(a,n){return[...a.matchAll(Y)].map(s=>{const t=s.groups?.page_id;if(!t)return null;const e={url:s[0],id:t,type:i.NOTION_OPEN_CONNECTOR};return n.access_token?{...e,handler:{type:"fetch",tryFetch:async()=>{const r=await v.safePost("/connectors/metadata",{requestBody:{manifest:{id:t,manifest_type:i.NOTION_OPEN_CONNECTOR}}});return Promise.resolve({connector:n.type,id:t,title:r.title??"Notion Page",mimeType:"application/json",url:e.url,syntheticExtension:null,manifest:{id:t,type:w.PAGE,manifest_type:i.NOTION_OPEN_CONNECTOR}})}}}:{...e,handler:{type:"prompt",message:"not-connected"}}})}export{re as ContextConnectorDocumentParser,g as encodeOneDriveShareUrl,P as parseDocumentURLsAndStripFromInput};
//# sourceMappingURL=nkw7cxdqtfq2g9xa.js.map
