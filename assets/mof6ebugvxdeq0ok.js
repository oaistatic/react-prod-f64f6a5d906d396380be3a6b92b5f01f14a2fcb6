import{r as t,b as z,am as $,j as u,M as W}from"./gg0tb34p9fzo1omt.js";import{D as L,ax as G,aZ as O,i$ as j,bg as B,cO as T,bU as F,c6 as U,P as H,S as V}from"./g670b8vtkhx0yc6d.js";import{hE as P,hF as N,hG as q,aw as I}from"./forbprkns1cohsbl.js";function k(s,r){return e=>{L.addAction(`${s}.${r}`,e)}}function Z(s){return(r,e)=>{L.addError(r,{...e,name:s,status:"error"})}}const w={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:Z("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class X{static async transcribe(r,e,S={}){const m=new FormData;m.append("file",r),e&&m.append("language",e);const d={durationMs:S.durationMs,language:e,fileSize:r.size},l=performance.now();return w.transcription.request(d),G.post(`${O}/transcribe`,m).then(n=>{const c=performance.now()-l;return w.transcription.requestSuccess({...d,durationMs:c}),n}).catch(n=>{const c=performance.now()-l;throw w.transcription.error(n,{...d,durationMs:c}),n})}}const J=48e3,K=10,_=J*K,Q=4e3,Y=10*60*1e3,M=s=>P.setState(r=>{r.status=s}),ee=s=>{const r=t.useRef(s);r.current=s;const e=t.useRef(null),S=t.useRef([]),m=t.useRef(null),d=t.useRef(null),l=t.useRef(null),n=t.useRef(new Float32Array(0)),c=t.useRef(null),b=t.useRef(null),v=t.useRef(!1),o=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),x=t.useCallback(async(a,p)=>{M("transcribing");try{let i;j()?i=new File([a],"whisper.mp3",{type:"audio/mpeg"}):i=new File([a],`whisper.${a.type.split(/[\/;]/)[1]||"mp3"}`,{type:a.type});const f=await X.transcribe(i,void 0,{durationMs:p});M("idle"),w.transcription.transcriptDelivered({durationMs:p,transcriptLength:f.text.length}),r.current.onSuccess(f.text,f.asset_pointer,f.asset_ttl),o()}catch(i){M("error"),w.transcription.error(i,{durationMs:p}),o()}},[o]),R=t.useCallback(a=>{if(!v.current)return;v.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const p=c.current!=null?performance.now()-c.current:void 0;a&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,M("idle"),o(),w.recording.cancel({durationMs:p}),c.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(i=>i.stop()),e.current=null,l.current?.disconnect(),l.current=null,d.current?.disconnect(),d.current=null,m.current?.close(),m.current=null,a||w.recording.submit({durationMs:p})},[o]),A=t.useCallback(()=>{o(),M("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:Q,channelCount:1}}).then(a=>{c.current=performance.now(),w.recording.start(),e.current=new MediaRecorder(a);const p=j();v.current=!0,p?(S.current=[],e.current.ondataavailable=g=>{g.data.size>0&&S.current.push(g.data)},e.current.onstop=async()=>{const g=new Blob(S.current,{type:"audio/mpeg-3"}),h=c.current!=null?performance.now()-c.current:void 0;await x(g,h)},e.current.start(1e3)):(e.current.ondataavailable=async g=>{const h=c.current!=null?performance.now()-c.current:void 0;await x(g.data,h)},e.current.start()),n.current=new Float32Array(_).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),M("recording"),b.current=window.setTimeout(()=>{R()},Y);const i=new AudioContext;m.current=i;const f=i.createMediaStreamSource(a);d.current=f;const y=i.createScriptProcessor(2048,1,1);l.current=y,y.onaudioprocess=g=>{const h=g.inputBuffer.getChannelData(0);for(let E=0;E<h.length;E++)h[E]=Math.max(h[E],r.current.initialValue);const D=n.current,C=new Float32Array(D.length+h.length);if(C.set(D,0),C.set(h,D.length),C.length>_){const E=C.length-_;n.current=C.slice(E)}else n.current=C;r.current.onWaveformDataUpdate(n.current)},f.connect(y),y.connect(i.destination)}).catch(()=>{M("error"),o(),w.recording.cancel()})},[o,R,x]);return t.useEffect(()=>()=>{R(!0)},[R]),{startRecording:A,stopRecording:R}};function se({disabled:s=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:S,onExit:m,buttonClassName:d,visualTreatment:l}){const n=z(),c=P(g=>g.status),b=t.useRef(!1),{startRecording:v,stopRecording:o}=ee({onSuccess:e,onWaveformDataUpdate:S,initialValue:r}),x=$();t.useEffect(()=>()=>{o()},[o]),t.useEffect(()=>{b.current||(v(),b.current=!0)},[v]),t.useEffect(()=>{x.state!=="idle"&&o()},[x.state,o]);const R=()=>{o(!0),m()},A=l==="codex"?u.jsx(B,{type:"button",color:"ghost",size:"small",onClick:R,icon:T,disabled:s||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:u.jsx(W,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):u.jsx("div",{children:u.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:s||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:F(l==="composer-btn"?"composer-btn":F(N,s?"opacity-30":q,d)),children:u.jsx(T,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),a=c==="transcribing",p=a?u.jsx(U,{}):u.jsx(I,{className:"icon-lg"}),i=a?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),f=()=>{H.logEvent("Whisper on Web/Windows: Clicked to end dictation"),V.logEvent("chatgpt_composer_whisper_button_clicked_end"),o()},y=l==="codex"?u.jsx(B,{type:"button",color:"secondary",size:"small",disabled:s,icon:a?U:I,onClick:f,children:u.jsx(W,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):u.jsx("div",{children:u.jsx("button",{type:"button","aria-label":i,disabled:s,className:l==="composer-btn"?"composer-btn":F(N,s?"opacity-30":q,d),onClick:f,children:p})});return u.jsxs("div",{className:"flex gap-x-1.5",children:[A,y]})}export{se as WhisperModeControls};
//# sourceMappingURL=mof6ebugvxdeq0ok.js.map
