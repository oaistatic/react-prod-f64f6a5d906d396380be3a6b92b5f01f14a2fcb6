import{e as Vt,r as C,v as _t,I as zt,j as ne,b as Ht}from"./gg0tb34p9fzo1omt.js";import{aQ as Ut,nx as V,oN as _,j2 as X,oP as ee,oO as N,bU as ie,qh as Ft,qi as qt,qj as dt,aG as De,pY as pt,qk as Kt,ql as Ke,qm as $t,pS as Gt,qn as Ne,qo as $e,D as Wt,q1 as jt,jA as Xt,f9 as Yt,fj as Zt,qp as Ge,oM as Jt,pX as Qt,qq as ht,qr as en,qs as ft,qt as tn,qu as nn,q0 as mt,f as sn,oL as gt,qv as on,pW as rn,qw as an,oG as cn,ch as ln,bo as un,qx as dn,d as pn,G as hn,H as fn,m as mn,ic as gn}from"./g670b8vtkhx0yc6d.js";import{n as wn,d as yn,m as We,g as En,f as Cn,l as Mn,o as kn,r as he,t as Me,a as wt,b as vn,u as yt,p as xn,q as Et,v as Pn}from"./bfgn782syyllzt4r.js";import{L as bn,C as Sn,M as Tn,a as Ae,b as je}from"./oe9a5f58lvevdkk3.js";import{d as Rn,X as Xe,bU as Dn,bT as Nn,lz as W,rB as An,rC as In,rD as On,p3 as Ie,rE as Ln,p4 as Ct,rF as Bn,hH as Vn}from"./forbprkns1cohsbl.js";import{D as _n,Z as zn}from"./jy1u8exw8iz2slve.js";import{u as Hn}from"./go2lz3yja1ixfdzl.js";import{T as Un,i as Fn}from"./j0nw4kv698ot3br0.js";import{z as qn,E as Kn,C as Ye}from"./hb16nhh4rqym397l.js";import{z as Ze,c as Je,E as Pe,n as $n,B as Gn}from"./be6sa05e05n18ich.js";import{E as Wn,M as jn,N as Xn}from"./f76gy0b8ieo4s693.js";import{stripDirectivePlugin as Yn}from"./l0kfwbyw3s1gkuhr.js";import{k as Zn}from"./pc2givv05uuq8g6l.js";import{v as Jn,u as Qn,w as es,x as ts,y as ns}from"./jh4r0k3f3n3zptua.js";import{f as ss,u as os,c as rs}from"./jec2dxephizdapuu.js";import{H as is}from"./gffsn29yylc5pncm.js";const as=n=>Ut(n).checkGate("924611523");function cs(n,e){const t=[];return n.descendants((s,o)=>{s.marks.forEach(r=>{r.type===e&&t.push({from:o,to:o+s.nodeSize,mark:r})})}),t}function ls(n,e,t){const s=e.mark.type,o={...e.mark.attrs,disabled:t};return n.removeMark(e.from,e.to,s),n.addMark(e.from,e.to,s.create(o)),n}const Oe=new _("disableUnsafeLinks");function us(n,e){return n.setMeta(Oe,{safeUrls:e})}function ds(n){return n.getMeta(Oe)??null}function ps(n=new Set){return new V({key:Oe,state:{init(e){return{safeUrls:n}},apply(e,t){const s=ds(e);if(s==null)return t;const{safeUrls:o}=s;return{...t,safeUrls:o}}},appendTransaction(e,t,s){const o=this.getState(s),r=s.tr,i=s.schema.marks[bn.proseMirrorMarkName()],a=cs(s.doc,i);let c=!1;return a.forEach(l=>{const u=l.mark.attrs.href,d=o.safeUrls.has(u),p=l.mark.attrs.disabled===!0;d===p&&(ls(r,l,!d),c=!0)}),c?r:null}})}const me=new _("placeholder");function hs(n,e){return n.setMeta(me,{isDisabled:e})}function fs(n){return n.getMeta(me)??null}function ms(n,e=!1){return new V({key:me,state:{init(){return{isDisabled:e}},apply(t,s){const o=fs(t);return o?.isDisabled!=null?{...s,isDisabled:o.isDisabled}:s}},props:{decorations(t){const{doc:s,selection:o}=t;if(me.getState(t).isDisabled||!(o instanceof X&&o.empty))return null;const{$cursor:i}=o;if(!i||!n)return null;const a=i.start();if(!((i.parent.isTextblock||i.parent.type.name==="doc")&&i.pos===a&&i.node().content.size===0))return null;const l=ee.widget(a,()=>{const u=document.createTextNode(n.formatMessage(gs.placeholder)),d=document.createElement("span");return d.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",d.style.position="absolute",d.appendChild(u),d});return N.create(s,[l])}}})}const gs=Vt({placeholder:{id:"n2B51U",defaultMessage:"Write something..."}}),ws={"override-strong-color":"_override-strong-color_y6grp_1"};function Mt({isHovered:n,isRejected:e,isTextAcive:t}){return ie({"line-through":!t,"filter grayscale-[0.6]":e,"opacity-60":e,"bg-opacity-50 dark:bg-opacity-50":e,"bg-opacity-10 dark:bg-opacity-10":e,"bg-opacity-60 dark:bg-opacity-60":!0})}function ys({isHovered:n,isRejected:e,isReplacement:t}){return ie("bg-red-100 dark:bg-red-600",Mt({isHovered:n,isRejected:e,isTextAcive:e}),{"dark:bg-red-800":e,"text-red-500 dark:text-red-200":!0,"border border-red-400 rounded-l border-e-0":e,"border border-red-400 rounded-sm":e})}function Es({isHovered:n,isRejected:e,isReplacement:t}){return ie(ws["override-strong-color"],"text-green-600 dark:text-green-200 bg-green-100 dark:bg-green-600",Mt({isHovered:n,isRejected:e,isTextAcive:!0}),{"dark:bg-green-800":e,"border border-green-500 rounded-r border-s-0":e,"border border-green-500 rounded-sm":e})}const be=new _("edit"),Qe=(n,e,t,s)=>{const o=[];for(const{start:r,end:i,editId:a}of e)o.push(ee.inline(r,i,{class:ys({isHovered:!1,isRejected:!1,isReplacement:!1}),"data-edit-id":a}));for(const{start:r,end:i,editId:a}of n)o.push(ee.inline(r,i,{class:Es({isHovered:!1,isRejected:!1,isReplacement:!0}),"data-edit-id":a}));return o},Cs=(n,e)=>new V({key:be,state:{init(){const s=new Set;return{decorations:Qe(n,e),hoveredEditId:null,rejectedEdits:s}},apply(t,s){const o=t.getMeta(be)??null,{hoveredEditId:r,rejectedEdits:i}=o??s;return{decorations:Qe(n,e),hoveredEditId:r,rejectedEdits:i}}},props:{decorations(t){const s=this.getState(t);return s?N.create(t.doc,s.decorations.concat()):N.empty},editable(){return!1},attributes(){return{class:"cursor-default",style:"--text-primary:var(--text-secondary)"}}}});class Z{constructor(e,t){this.length=e,this.step=t}cut(e){return e===this.length?this:new Z(e,this.step)}static slice(e,t,s){if(t===s)return Z.none;if(t===0&&s===Z.len(e))return e;const o=[];for(let r=0,i=0;i<s;r++){const a=e[r],c=i+a.length,l=Math.min(s,c)-Math.max(t,i);l>0&&o.push(a.cut(l)),i=c}return o}static join(e,t,s){if(e.length===0)return t;if(t.length===0)return e;const o=s(e[e.length-1].step,t[0].step);if(o==null)return e.concat(t);const r=e.slice(0,e.length-1);r.push(new Z(e[e.length-1].length+t[0].length,o));for(const i of t)r.push(i);return r}static len(e){let t=0;for(const s of e)t+=s.length;return t}static none=[]}class Ms{constructor(e,t,s,o,r,i){this.fromA=e,this.toA=t,this.fromB=s,this.toB=o,this.deleted=r,this.inserted=i}get lenA(){return this.toA-this.fromA}get lenB(){return this.toB-this.fromB}}const et=(n,e,t,s,o)=>new Ms(n,e,t,s,n===e?Z.none:[new Z(e-n,o)],t===s?Z.none:[new Z(s-t,o)]);class ge{constructor(e,t){this.doc=e,this.changes=t}static create(e){return new ge(e,[])}addSteps(e,t){const s=[];for(const r of t){let i=0;if(r.getMap().forEach((a,c,l,u)=>{s.push(et(a+i,c+i,l,u,r)),i=u-l-(c-a)}),r instanceof Ft||r instanceof qt){const{from:a,to:c}=r;s.push(et(a,c,a,c,r))}}if(s.length===0)return this;const o=this.changes.concat(s);return new ge(e,o)}}const ae=new _("changeset"),Se=new _("highlightChanges"),kt=n=>ae.getState(n),ks=n=>{const{state:e}=n,t=e.tr.setMeta(ae,!0);n.updateState(e.apply(t))},vs=n=>{const{state:e}=n,t=kt(e);if(!t)return;const{maps:s,steps:o}=t,r=new dt(s),i=e.tr;for(let c=o.length-1;c>=0;c--){const l=o[c].map(r.slice(c+1));if(!l)continue;i.maybeStep(l).doc&&r.appendMap(l.getMap(),c)}const a=e.apply(i.setMeta(ae,!0));n.updateState(a)},xs=()=>{const n=s=>({changeset:ge.create(s),maps:[],steps:[]}),e=new V({key:ae,state:{init:(s,{doc:o})=>n(o),apply:(s,o,r,i)=>{const{doc:a}=i;if(s.getMeta(ae))return n(a);const{docChanged:l,mapping:u,steps:d,docs:p}=s;if(!l)return o;const{changeset:h,maps:m,steps:v}=o,{maps:x}=u,Y=d.map((k,E)=>k.invert(p[E]));return{changeset:h.addSteps(a,d),maps:m.concat(x),steps:v.concat(Y)}}}}),t=new V({key:Se,state:{init(){return{deco:N.empty,show:!1}},apply(s,o,r,i){const a=e.getState(i);if(!a)return o;const{changeset:c}=a,{doc:l}=i,{changes:u}=c,d=u.map(({fromB:h,toB:m})=>ee.inline(h,m,{class:"blame-marker"})),p=s.getMeta(Se);return{deco:N.create(l,d),show:p??o.show}}},props:{decorations(s){const o=this.getState(s);if(!o?.show)return N.empty;const{deco:r}=o;return r}}});return[e,t]},te=(n,e,t)=>{C.useEffect(()=>{const s=e.current;if(!s)return;const{state:o}=s,r=n(o.tr);r&&s.dispatch(r)},t)},re=new _("autocomplete");function tt(n,e){return n.setMeta(re,{suggestion:e})}function Ps(n){return n.getMeta(re)}function nt(n){if(!(n instanceof X))return null;const{$cursor:e}=n;if(!e)return null;const t=e.end();return e.pos===t?t:null}function bs(n=null){return new V({key:re,state:{init(){return{suggestion:n}},apply(e,t){const s=Ps(e);return s===void 0?t:{...t,suggestion:s.suggestion??null}}},props:{decorations(e){const{doc:t,selection:s}=e,{suggestion:o}=re.getState(e);if(!o)return null;const r=nt(s);if(r==null)return N.empty;const i=ee.widget(r,()=>{const a=document.createTextNode(o),c=document.createElement("span");return c.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",c.appendChild(a),c});return N.create(t,[i])},handleDOMEvents:{keydown:(e,t)=>{const{state:s}=e,o=re.getState(s),r=nt(s.selection);t.key==="Tab"&&o.suggestion&&r!=null&&(t.preventDefault(),e.dispatch(s.tr.insert(r,s.schema.text(o.suggestion))))}}}})}const Ss=(n,e)=>{const t=C.useRef(!1),s=C.useRef(null),o=C.useRef(e);o.current=e;const r=C.useCallback(Rn(async i=>{t.current=!1;const a=crypto.randomUUID();s.current=a;const c=await o.current?.(i());!t.current&&c!==void 0&&n.current&&s.current===a&&n.current.dispatch(tt(n.current.state.tr,c))},200),[]);return C.useCallback(i=>{t.current=!0;const a=De(n.current);a.dispatch(tt(a.state.tr,null)),r(i)},[r,n])};var ce=(n=>(n.PROSEMIRROR_CONTEXT_CHILDREN="prosemirror-context-children",n.PROSEMIRROR_EDITOR_CONTAINER="prosemirror-editor-container",n))(ce||{});function Ts(n,e){return{x:Xe(e.x,n.left,n.right),y:Xe(e.y,n.top,n.bottom)}}function vt(n){let e=n.selection.$from.pos-1;if(e<0)return null;let t=n.doc.nodeAt(e);for(;(t==null||t.type.name===Un.proseMirrorNodeName())&&e>0;)e-=1,t=n.doc.nodeAt(e);return t!=null?{node:t,pos:e}:t}function Rs(n,e){const t=vt(n);if(t==null)return!1;const{node:s,pos:o}=t,r=o+s.nodeSize,i=n.tr,c=n.schema.nodes.paragraph.create(null);i.insert(r,c);const l=r+c.nodeSize-1,u=i.doc.resolve(l),d=new X(u);return i.setSelection(d),e(i),!0}function Ds(n,e){const t=vt(n);if(t==null)return!1;const{node:s,pos:o}=t,r=n.tr;return r.deleteRange(o,o+s.nodeSize),e(r),!0}const st=(n,e)=>{if(n===e)return null;let t=0,s=n.length,o=e.length;for(;t<s&&n.charCodeAt(t)===e.charCodeAt(t);)t+=1;for(;s>t&&o>t&&n.charCodeAt(s-1)===e.charCodeAt(o-1);)s-=1,o-=1;return{from:t,to:s,text:e.slice(t,o)}},ot=n=>Pe.theme({"&":{backgroundColor:n?"var(--main-surface-primary)":"var(--gray-100)"}});class Le{constructor(e,t,s,o){this.pmView=t,this.getPos=s,this.node=e;const r=[{key:"ArrowUp",run:this.maybeEscape("line",-1)},{key:"ArrowLeft",run:this.maybeEscape("char",-1)},{key:"ArrowDown",run:this.maybeEscape("line",1)},{key:"ArrowRight",run:this.maybeEscape("char",1)},{key:"Backspace",run:this.handleBackspace},{key:"Shift-Enter",run:this.handleShiftEnter}];this.languageCompartment=new Ze,this.themeCompartment=new Ze;const i=wn(e.attrs.lang),a=Je.create({doc:this.node.textContent,extensions:[this.themeCompartment.of([ot(o),Ye(We(o))]),Pe.theme({"&":{borderRadius:"4px",padding:"0.5rem"},"&.cm-focused":{outline:"none"}}),$n.of([...r,...En,...Cn,Mn]),qn(),yn(),Kn(),Gn(),this.languageCompartment.of(i!=null?[i]:[]),Je.changeFilter.of(c=>(!c.docChanged&&!this.updating&&this.forwardSelection(),!0))]});this.cm=new Pe({state:a,dispatch:this.dispatch}),i==null&&this.setLanguage(e.attrs.lang)}node;updating=!1;cm;languageCompartment;themeCompartment;get pmSchema(){return this.pmView.state.schema}get dom(){return this._setIsCodeBlockView(),this.cm.dom}setLanguage=async e=>{const t=await kn(e);t&&this.cm.dispatch({effects:this.languageCompartment.reconfigure(t)})};setTheme=e=>{const t=[ot(e),Ye(We(e))];this.cm.dispatch({effects:this.themeCompartment.reconfigure(t)})};handleBackspace=e=>{const{selection:t}=e.state;if(!(t.main.empty&&t.main.from===0)||this.cm.state.doc.length>0)return!1;const s=Ds(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),s};handleShiftEnter=()=>{const e=Rs(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),e};dispatch=e=>{if(this.cm.update([e]),this.updating)return;const t=(this.getPos()??0)+1,s=e.state.doc.toString(),o=st(this.node.textContent,s);if(o){const{text:r,from:i,to:a}=o,c=r?this.pmSchema.text(r):null,l=this.pmView.state.tr.replaceWith(i+t,a+t,c);this.pmView.dispatch(l)}this.forwardSelection()};update=e=>{if(e.type!==this.node.type)return!1;e.attrs.lang!==this.node.attrs.lang&&this.setLanguage(e.attrs.lang),e.attrs.isDarkMode!=null&&e.attrs.isDarkMode!==this.node.attrs.isDarkMode&&this.setTheme(e.attrs.isDarkMode),this.node=e;const t=st(this.cm.state.doc.toString(),e.textContent);if(t){const{text:s,from:o,to:r}=t;this.updating=!0,this.cm.dispatch({changes:{from:o,to:r,insert:s}}),this.updating=!1}return!0};asProseMirrorSelection=e=>{const t=(this.getPos()??0)+2,{anchor:s,head:o}=this.cm.state.selection.main;return X.create(e,s+t,o+t)};forwardSelection=()=>{if(!this.cm.hasFocus)return;const{state:e}=this.pmView,t=this.asProseMirrorSelection(e.doc);t.eq(e.selection)||this.pmView.dispatch(e.tr.setSelection(t))};maybeEscape=(e,t)=>s=>{const{state:o}=s,{selection:r}=o,a=(()=>{const h=r.main.from,{number:m,from:v}=o.doc.lineAt(h);return{line:m,ch:h-v}})(),c=o.selection.ranges.some(h=>!h.empty),l=1,u=o.doc.lineAt(o.doc.length).number;if(c||a.line!==(t<0?l:u)||e==="char"&&a.ch!==(t<0?0:o.doc.line(a.line).length))return!1;const d=(this.getPos()??0)+(t<0?0:this.node.nodeSize),p=pt.near(this.pmView.state.doc.resolve(d),t);return this.pmView.dispatch(this.pmView.state.tr.setSelection(p).scrollIntoView()),this.pmView.focus(),!0};setSelection=(e,t)=>{this.focus(),this.updating=!0,this.cm.dispatch({selection:{anchor:e,head:t}}),this.updating=!1};focus=()=>{this.cm.focus(),this.forwardSelection()};selectNode=()=>{this.focus()};stopEvent=()=>!0;destroy=()=>{this.cm.destroy()};_setIsCodeBlockView=()=>{this.cm.dom.dataset.isCodeBlockView="true"};static _getIsCodeBlockView=e=>e.dataset.isCodeBlockView==="true";static isInCodeBlockView(e){return e instanceof HTMLElement?e.closest("[data-is-code-block-view]")!=null:!1}}function Ns(n,e,t){try{return e instanceof X?X.create(n,e.anchor,e.head):e instanceof Kt?X.create(n,e.from,e.to):e instanceof Ke?new Ke(n):void 0}catch{return X.create(n,0)}}class As extends Wn{unifiedInitializationHook(e){return e.use(Yn)}}class Is{rules;constructor(e,t){this.rules=[].concat.apply([],e.syntaxExtensions().map(s=>s.proseMirrorInputRules(t)))}build(){return Fn({rules:this.rules})}}class Os{keymap;constructor(e,t){this.keymap=new Map;for(const s of e.syntaxExtensions())this.addKeymap(s.proseMirrorKeymap(t));this.addKeymap($t)}build(){const e={};return this.keymap.forEach((t,s)=>{e[s]=Gt(...t)}),Ne(e)}addKeymap(e){for(const t in e)this.keymap.get(t)||this.keymap.set(t,[]),De(this.keymap.get(t)).push(e[t])}}class Ls{nodeViews;constructor(e){this.nodeViews={};for(const t of e.nodeExtensions()){const s=t.proseMirrorNodeName(),o=t.proseMirrorNodeView();s!==Sn.proseMirrorNodeName()&&s!=null&&o!=null&&(this.nodeViews[s]=o)}}build(){return this.nodeViews}}class Bs{nodes={};marks={};constructor(e){for(const t of e.nodeExtensions()){const s=t.proseMirrorNodeName(),o=t.proseMirrorNodeSpec();s!=null&&o!=null&&(s!=="text"&&(o.attrs={...o.attrs,start:{default:void 0},end:{default:void 0}}),this.nodes[s]=o)}for(const t of e.markExtensions()){const s=t.proseMirrorMarkName(),o=t.proseMirrorMarkSpec();s!=null&&o!=null&&(this.marks[s]=o)}}build(){try{return new $e({nodes:this.nodes,marks:this.marks})}catch(e){Wt.addError(e,{nodes:this.nodes})}return new $e({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM:()=>["p",0]},text:{group:"inline"}},marks:this.marks})}}class Vs{extensionManager;constructor(e){this.extensionManager=e}build(){let e=Dn();for(const t of this.extensionManager.extensions())e=t.unifiedInitializationHook(e);return e}}function _s(n){return n instanceof Xn}function zs(n){return n instanceof jn}class Hs{markExtensionList;nodeExtensionList;otherExtensionList;constructor(e){this.markExtensionList=new Map,this.nodeExtensionList=new Map,this.otherExtensionList=new Map;for(const t of e)this.add(t)}extensions(){return this.syntaxExtensions().concat(Array.from(this.otherExtensionList.values()))}markExtensions(){return Array.from(this.markExtensionList.values())}getMarkExtension(e){return this.markExtensionList.get(e)??null}nodeExtensions(){return Array.from(this.nodeExtensionList.values())}getNodeExtension(e){return this.nodeExtensionList.get(e)??null}syntaxExtensions(){return this.nodeExtensions().concat(this.markExtensions())}add(e){for(const t of e.dependencies())this.add(t);if(zs(e)){this.markExtensionList.set(e.constructor.name,e);return}if(_s(e)){this.nodeExtensionList.set(e.constructor.name,e);return}this.otherExtensionList.set(e.constructor.name,e)}}class Us{extensionManager;constructor(e){this.extensionManager=e}convert(e){const t=this.convertNode(e);if(t.length!==1)throw new Error("Couldn't find any way to convert the root ProseMirror node.");return t[0]}convertNode(e){let t=null;const s=[];for(const o of this.extensionManager.nodeExtensions()){if(!o.proseMirrorToUnistTest(e))continue;s.push(o);let r=[];for(let i=0;i<e.childCount;++i)r=r.concat(this.convertNode(e.child(i)));t=o.proseMirrorNodeToUnistNodes(e,r)}return t==null?(console.warn(`Couldn't find any way to convert ProseMirror node of type "`+e.type.name+'" to a unist node.'),[]):t.map(o=>{for(const r of e.marks){const{type:{name:i}}=r;if(s.some(l=>{const u=l.proseMirrorNodeSpec()?.marks;return u!=null&&!u.includes(i)}))continue;let c=!1;for(const l of this.extensionManager.markExtensions())r.type.name===l.proseMirrorMarkName()&&(o=l.processConvertedUnistNode(o,r),c=!0);c||console.warn(`Couldn't find any way to convert ProseMirror mark of type "`+i+'" to a unist node.')}return o})}}class Be{extensionManager;proseMirrorSchema;constructor(e,t){this.extensionManager=e,this.proseMirrorSchema=t}static unistNodeIsParent(e){return"children"in e}convert(e){const t={},s=this.convertNode(e,t);for(const o of this.extensionManager.syntaxExtensions())o.postUnistToProseMirrorHook(t);if(s.length!==1)throw new Error("Couldn't find any way to convert the root unist node.");return s[0]}convertNode(e,t){let s=0;const o=(r,i)=>{for(const a of this.extensionManager.syntaxExtensions()){if(!a.unistToProseMirrorTest(r)||Nn(r)&&a.customDirectiveName()!=null&&a.customDirectiveName()!==r.name)continue;let c=[];Be.unistNodeIsParent(r)&&(c=r.children.flatMap(m=>o(m,i)));const{position:l}=r,u=l?.start.offset??s;let d=l?.end.offset;if(d==null&&"value"in r&&typeof r.value=="string"){const{value:m}=r;d=u+m.length}d==null&&(d=u),s=d;const p={start:u,end:d};return jt(a.unistNodeToProseMirrorNodes({node:r,schema:this.proseMirrorSchema,convertedChildren:c,context:i,attrs:p})).filter(Xt)}return console.warn(`Couldn't find any way to convert unist node of type "`+r.type+'" to a ProseMirror node.'),[]};return o(e,t)}}const Fs=5;class qs{builtSchema;inputRulesBuilder;keymapBuilder;nodeViewBuilder;unistToProseMirrorConverter;proseMirrorToUnistConverter;unified;memoizedProsemirrorDocs=new Map;constructor(e=[]){const t=new Hs(e);this.builtSchema=new Bs(t).build(),this.inputRulesBuilder=new Is(t,this.builtSchema),this.keymapBuilder=new Os(t,this.builtSchema),this.nodeViewBuilder=new Ls(t),this.unistToProseMirrorConverter=new Be(t,this.builtSchema),this.proseMirrorToUnistConverter=new Us(t),this.unified=new Vs(t).build()}parse(e){try{if(this.memoizedProsemirrorDocs.has(e))return De(this.memoizedProsemirrorDocs.get(e));const t=this.unistToProseMirrorConverter.convert(this.parseUnist(e));if(this.memoizedProsemirrorDocs.set(e,t),this.memoizedProsemirrorDocs.size>Fs){const s=this.memoizedProsemirrorDocs.keys().next().value;s&&this.memoizedProsemirrorDocs.delete(s)}return t}catch(t){W.logError("Failed to parse document",t)}return this.schema().text(" ")}parseUnist(e){return this.unified.runSync(this.unified.parse(e))}schema(){return this.builtSchema}inputRulesPlugin(){return this.inputRulesBuilder.build()}keymapPlugin(){return this.keymapBuilder.build()}nodeViews(){return this.nodeViewBuilder.build()}serialize(e){const t=this.proseMirrorToUnistConverter.convert(e);return this.unified.stringify(t)}}const rt=new Map;function se(n={}){const e=JSON.stringify(n);let t=rt.get(e);return t==null&&(t=new qs([new Tn,...n?.shouldStripDirectives?[new As]:[]]),rt.set(e,t)),t}const Ks=(n,e,t,s)=>{const o=[];for(const r of e)for(const i of t)o.push({from:r,to:i,parentNodeNamesAtStart:r.parentNodeTypeNameStack,slice:n.slice(r.pmPos,i.pmPos)});return o.sort((r,i)=>{const a=Math.abs(r.from.sourcePos-s.start)+Math.abs(r.to.sourcePos-s.end),c=Math.abs(i.from.sourcePos-s.start)+Math.abs(i.to.sourcePos-s.end);return a===c?i.slice.size-r.slice.size:a-c}),o},$s=(n,e)=>Zt(n.parentNodeNamesAtStart,e.parentNodeTypeNameStack),it=new WeakMap,Gs=({diff:n})=>{const e=new An(In.GetDiffedDoc,{debug:!1});e.startBlock("get_diffed_doc");const t=se(),{contentAfter:s,contentBefore:o,edits:r}=n,i=t.parse(s),a=t.parse(o),c=r.concat().sort((k,E)=>k.positionBefore.start-E.positionBefore.start),l=[],u=[];e.startBlock("init_position_transformers");const{sourceRangeToPmRange:d}=he(a),{sourceRangeToPmRange:p}=he(i);e.endBlock("init_position_transformers");let h=a,m=0,v=0;const x=[],Y=(k,E,M)=>{for(const[A,H]of M.entries())try{if(!$s(E,H))continue;const{pmPos:P}=H,{slice:O}=E;return h=h.replace(P,P,O),l.push({editId:k,start:P,end:P+O.size}),[A,H]}catch(P){x.push(P)}return null};for(let k=0;k<c.length;k++){const{id:E,positionBefore:M,positionAfter:A}=c[k];e.startBlock("transform_positions");const H=d(M),P=p(A);e.endBlock("transform_positions");const{start:O,end:S}=H,{start:I,end:w}=P,y=A.start!==A.end,f=y?Ks(i,I,w,A):null;e.startBlock("get_merged_doc_positions");const{positions:L}=he(h);e.endBlock("get_merged_doc_positions");const U=Math.max(...O.map(({pmPos:R})=>R)),T=Math.min(...S.map(({pmPos:R})=>R)),q=[].concat(S).concat(O),F=M.start!==M.end&&a.textBetween(U,T).length>0;let B=!1;if(F&&!y)u.push({editId:E,start:U+m,end:T+m}),B=!0;else if(!F&&!y)B=!0;else{const R=q.map(({pmPos:D})=>L[D+m]);for(const D of f??[]){const z=Y(E,D,R);if(z==null)continue;const J=z[0],ye=D.slice.size,le=J<S.length;le||(m+=ye),F&&u.push({editId:E,start:U+m,end:T+m}),le&&(m+=ye),B=!0;break}}if(!B&&f!=null){const D=Math.min(...O.map(({pmPos:z})=>z))+m-1;for(const z of f)try{h=h.replace(D,D,z.slice),l.push({editId:E,start:D,end:D+z.slice.size}),m+=z.slice.size,F&&u.push({editId:E,start:U+m,end:T+m}),B=!0;break}catch(J){x.push(J)}}B?W.logEvent("Canvas Diff Edit Success"):(W.logEvent("Canvas Diff Edit Fail"),W.logError("Failed to insert edit for diffed doc",Yt(x),{errors:x.map(On),replaceFromCandidates:O,replaceToCandidates:S,sliceFromCandidates:I,sliceToCandidates:w}),v++)}return W.logDistribution("Canvas Diff Edit Success Ratio",(c.length-v)/c.length),W.logDistribution("Canvas Diff Edit Fail Count",v),W.logDistribution("Canvas Diff Edit Success Count",c.length-v),W.logDistribution("Canvas Diff Edit Count",c.length),e.endBlock("get_diffed_doc"),{doc:h,addedRanges:l,deletedRanges:u}},Ws=({diff:n})=>{const e=it.get(n);if(e!=null)return e;const t=Gs({diff:n});return it.set(n,t),t},de=new _("focus"),js=(n,e)=>new V({key:de,state:{init:()=>!1,apply(t,s){const o=t.getMeta(de);return typeof o=="boolean"?o:s}},props:{handleDOMEvents:{blur:(t,s)=>{const{relatedTarget:o}=s;return o!=null&&Le.isInCodeBlockView(o)||(e(s),t.dispatch(t.state.tr.setMeta(de,!1))),!1},focus:(t,s)=>(n(s),t.dispatch(t.state.tr.setMeta(de,!0)),!1)}}}),Xs=500;class j{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let o,r;t&&(o=this.remapping(s,this.items.length),r=o.maps.length);const i=e.tr;let a,c;const l=[],u=[];return this.items.forEach((d,p)=>{if(!d.step){o||(o=this.remapping(s,p+1),r=o.maps.length),r--,u.push(d);return}if(o){u.push(new G(d.map));const h=d.step.map(o.slice(r));let m;h&&i.maybeStep(h).doc&&(m=i.mapping.maps[i.mapping.maps.length-1],l.push(new G(m,void 0,void 0,l.length+u.length))),r--,m&&o.appendMap(m,r)}else i.maybeStep(d.step);if(d.selection)return a=o?d.selection.map(o.slice(r)):d.selection,c=new j(this.items.slice(0,s).append(u.reverse().concat(l)),this.eventCount-1),!1},this.items.length,0),{remaining:c,transform:i,selection:a}}addTransform(e,t,s,o){const r=[];let i=this.eventCount,a=this.items,c=!o&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){const d=e.steps[u].invert(e.docs[u]);let p=new G(e.mapping.maps[u],d,t),h;(h=c&&c.merge(p))&&(p=h,u?r.pop():a=a.slice(0,a.length-1)),r.push(p),t&&(i++,t=void 0),o||(c=p)}const l=i-s.depth;return l>Zs&&(a=Ys(a,l),i-=l),new j(a.append(r),i)}remapping(e,t){const s=new dt;return this.items.forEach((o,r)=>{const i=o.mirrorOffset!=null&&r-o.mirrorOffset>=e?s.maps.length-o.mirrorOffset:void 0;s.appendMap(o.map,i)},e,t),s}addMaps(e){return this.eventCount==0?this:new j(this.items.append(e.map(t=>new G(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;const s=[],o=Math.max(0,this.items.length-t),r=e.mapping;let i=e.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},o);let c=t;this.items.forEach(p=>{const h=r.getMirror(--c);if(h==null)return;i=Math.min(i,h);const m=r.maps[h];if(p.step){const v=e.steps[h].invert(e.docs[h]),x=p.selection&&p.selection.map(r.slice(c+1,h));x&&a++,s.push(new G(m,v,x))}else s.push(new G(m))},o);const l=[];for(let p=t;p<i;p++)l.push(new G(r.maps[p]));const u=this.items.slice(0,o).append(l).append(s);let d=new j(u,a);return d.emptyItemCount()>Xs&&(d=d.compress(this.items.length-s.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){const t=this.remapping(0,e);let s=t.maps.length;const o=[];let r=0;return this.items.forEach((i,a)=>{if(a>=e)o.push(i),i.selection&&r++;else if(i.step){const c=i.step.map(t.slice(s)),l=c&&c.getMap();if(s--,l&&t.appendMap(l,s),c){const u=i.selection&&i.selection.map(t.slice(s));u&&r++;const d=new G(l.invert(),c,u),p=o.length-1;let h;(h=o.length&&o[p].merge(d))?o[p]=h:o.push(d)}}else i.map&&s--},this.items.length,0),new j(Ge.from(o.reverse()),r)}static empty=new j(Ge.empty,0)}function Ys(n,e){let t;return n.forEach((s,o)=>{if(s.selection&&e--==0)return t=o,!1}),n.slice(t)}class G{constructor(e,t,s,o){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=o}merge(e){if(this.step&&e.step&&!e.selection){const t=e.step.merge(this.step);if(t)return new G(t.getMap().invert(),t,this.selection)}}}class Q{constructor(e,t,s,o,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=o,this.prevComposition=r}}const Zs=20;function Js(n,e,t,s){const o=t.getMeta(oe);let r;if(o)return o.historyState;t.getMeta(to)&&(n=new Q(n.done,n.undone,null,0,-1));const i=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(i&&i.getMeta(oe))return i.getMeta(oe).redo?new Q(n.done.addTransform(t,void 0,s,fe(e)),n.undone,at(t.mapping.maps),n.prevTime,n.prevComposition):new Q(n.done,n.undone.addTransform(t,void 0,s,fe(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){const a=t.getMeta("composition"),c=n.prevTime==0||!i&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-s.newGroupDelay||!Qs(t,n.prevRanges)),l=i?ke(n.prevRanges,t.mapping):at(t.mapping.maps);return new Q(n.done.addTransform(t,c?e.selection.getBookmark():void 0,s,fe(e)),j.empty,l,t.time,a??n.prevComposition)}else return(r=t.getMeta("rebased"))?new Q(n.done.rebased(t,r),n.undone.rebased(t,r),ke(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new Q(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),ke(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function Qs(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,o)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&o>=e[r]&&(t=!0)}),t}function at(n){const e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,o,r,i)=>e.push(r,i));return e}function ke(n,e){if(!n)return null;const t=[];for(let s=0;s<n.length;s+=2){const o=e.map(n[s],1),r=e.map(n[s+1],-1);o<=r&&t.push(o,r)}return t}function eo(n,e,t){const s=fe(e),o=oe.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;const i=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),o,s),c=new Q(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(i).setMeta(oe,{redo:t,historyState:c})}let ve=!1,ct=null;function fe(n){const e=n.plugins;if(ct!=e){ve=!1,ct=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){ve=!0;break}}return ve}const oe=new _("history"),to=new _("closeHistory");function xe(n={},e=void 0){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new V({key:oe,state:{init(){return e??new Q(j.empty,j.empty,null,0,-1)},apply(t,s,o){return Js(s,o,t,n)}},config:n,props:{handleDOMEvents:{beforeinput(t,s){const o=s.inputType,r=o=="historyUndo"?Pt:o=="historyRedo"?Te:null;return!r||!t.editable?!1:(s.preventDefault(),r(t.state,t.dispatch))}}}})}function xt(n,e){return(t,s)=>{const o=oe.getState(t);if(!o||(n?o.undone:o.done).eventCount==0)return!1;if(s){const r=eo(o,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const Pt=xt(!1,!0),Te=xt(!0,!0),no=()=>new V({key:new _("katex"),props:{decorations(n){const e=[];return n.doc.descendants((t,s)=>{(t.type.name==="inline_math"||t.type.name==="math_block")&&e.push(ee.widget(s+1,()=>{const o=document.createElement("span"),r=Zn.renderToString(t.attrs.latex,{throwOnError:!1,displayMode:t.type.name==="math_block"});return o.innerHTML=r,o}))}),N.create(n.doc,e)}}});function so(n,e){const t=e&&n.dom?.querySelectorAll(`[data-edit-id="${e}"]`);return t?Array.from(t):[]}function Zo(n,e){return so(n,e).flatMap(s=>Array.from(s.getClientRects()))}function Re(n,e,t){return n>=t.left&&n<=t.right&&e>=t.top&&e<=t.bottom}function oo(n){const e=Math.min(...n.map(r=>r.left)),t=Math.max(...n.map(r=>r.right)),s=Math.min(...n.map(r=>r.top)),o=Math.max(...n.map(r=>r.bottom));return{left:e,right:t,top:s,bottom:o}}function ro(n,e,t){return t.some(o=>Re(n,e,o))?!0:t.length<2?!1:t.some(o=>n>=o.left&&n<=o.right&&e>o.bottom)&&t.some(o=>n>=o.left&&n<=o.right&&e<o.top)}const io=new _("linkTooltip"),ao=36;class co{tooltipElement;button;onMouseLeave;constructor(e){this.tooltipElement=document.createElement("div"),this.tooltipElement.className=ie("absolute  py-1.5 px-2.5 bg-token-main-surface-primary border border-token-border-default rounded-lg text-xs z-50 items-center cursor-pointer shadow-md flex justify-center cursor-pointer","transform -translate-x-1/2"),this.button=document.createElement("button"),this.button.textContent="Open link",this.button.className=ie("bg-none","border-none","text-token-text-primary ","text-sm"),this.tooltipElement.appendChild(this.button),this.onMouseLeave=e,this.tooltipElement.addEventListener("mouseleave",e)}show(e,t,s){document.body.appendChild(this.tooltipElement),this.tooltipElement.style.left=`${e}px`,this.tooltipElement.style.top=`${t}px`;const o=()=>{window.open(s,"_blank"),this.hide()};this.button.addEventListener("click",o,{once:!0})}hide(){this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement)}}function lo(){let n=null,e=null;const t=r=>{if(n==null||e==null)return!1;const i=Array.from(e.getClientRects()),a=n.tooltipElement.getBoundingClientRect();if(i.length===1){const c=i[0];return!Re(r.clientX,r.clientY,oo([c,a]))}else return!ro(r.clientX,r.clientY,[a,...i])},s=(r,i)=>{n&&(n.hide(),n=null);const a=r.getAttribute("href");if(!a)return;const c=Array.from(r.getClientRects()),l=c.find(p=>Re(i.clientX,i.clientY,p))??c[0],u=l.left+l.width/2,d=l.top-ao;n=new co(p=>{t(p)&&o()}),n.show(u,d,a),e=r},o=()=>{n&&(n.hide(),n=null),e=null};return new V({key:io,props:{handleDOMEvents:{mousemove(r,i){const a=()=>{const{target:l}=i;if(!(l instanceof HTMLElement))return!1;const u=l.closest("a[href]");return u!=null&&u!==e?(s(u,i),!0):!1},c=()=>{n==null||!t(i)||o()};a()||c()}}},view:()=>({destroy:o})})}function bt(n){return se().serialize(n).length}const uo=new _("maxLength"),po=(n,e,t)=>new V({key:uo,state:{init(){return t},apply:()=>{}},filterTransaction(s){if(n==null||!s.steps.some(i=>i instanceof Jt||i instanceof Qt?i.slice.size>i.to-i.from:!1))return!0;const r=bt(s.doc);return r<=t?!0:(e&&Ie(e,n),W.logEvent("Canvas Prosemirror Max Length",{maxLength:t,newLength:r}),!1)}});function ho(n,e){const{state:t}=n,{selection:s}=t,o=s.content(),{schema:r}=t,i=r.topNodeType.create(null,o.content),a=fo(i,n),c=t.doc.textBetween(s.from,s.to,`
`);e.clipboardData?.setData("application/x-prosemirror",c),e.clipboardData?.setData("text/plain",a),e.preventDefault()}function fo(n,e){let t="";function s(o){if(o.type.name==="paragraph")return o.content.forEach(r=>{s(r)}),t+=`
`,!1;if(o.type.name==="contentReference"){const r=o.attrs.index,i=mo(r,e);return i&&(t+=`[${i}]`),!1}else o.isText&&o.text!==void 0&&(t+=o.text);return!0}return n.descendants(s),t.endsWith(`
`)&&(t=t.slice(0,-1)),t}function mo(n,e){const t=ht.getState(e.state),s=parseInt(n);if(t==null||s==null)return null;const o=t?.displayedContentReferences?.[s];return o==null||o.type!=="grouped_webpages"?null:o.items?.[0]?.url}class go{dom;node;view;getPos;key;collectReactElement;constructor(e,t,s,o){this.node=e,this.getPos=s,this.view=t,this.dom=document.createElement("span"),this.dom.className="content-reference-node";const r=()=>`${_t()}`;this.key=`content-reference-node-${r()}`,this.collectReactElement=o,this.renderReactComponent()}renderReactComponent(){const{index:e}=this.node.attrs,t=ht.getState(this.view.state);if(e==null)return;const s=t?.displayedContentReferences?.[e];if(!s||s.type!=="grouped_webpages")return;const o=ne.jsx(Ln,{webpageRef:s,trackContentReferenceEvent:()=>{},index:e}),r=zt.createPortal(o,this.dom);this.collectReactElement(this.key,r)}update(e){return e.attrs!==this.node.attrs&&(this.node=e,this.renderReactComponent()),!0}destroy(){this.collectReactElement(this.key,null)}}class wo{dom;node;getPos;view;constructor(e,t,s){this.getPos=s,this.view=t,this.node=e;const o=document.createElement("span");o.className="hive-log-wrapper",o.style.display="inline-block",o.style.userSelect="none";const r=document.createElement("span");r.className="hive-log",r.contentEditable="false",r.setAttribute("data-type","hive-log"),r.setAttribute("data-timestamp",e.attrs.timestamp),r.textContent=ss(e.attrs.timestamp);const i=a=>{a.preventDefault(),a.stopPropagation()};o.addEventListener("mousedown",i),r.addEventListener("mousedown",i),r.addEventListener("click",a=>{a.preventDefault();const{openSidebar:c,setCurrentTime:l}=os.getState();c(),l(parseInt(e.attrs.timestamp))}),o.appendChild(r),this.dom=o}stopEvent(e){return e.type==="mousedown"?(e.preventDefault(),!0):!1}destroy(){}}function yo(n={}){return new V({view(e){return new Eo(e,n)}})}class Eo{constructor(e,t){var s;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(s=t.width)!==null&&s!==void 0?s:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(o=>{let r=i=>{this[o](i)};return e.dom.addEventListener(o,r),{name:o,handler:r}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,s;if(t){let a=e.nodeBefore,c=e.nodeAfter;if(a||c){let l=this.editorView.nodeDOM(this.cursorPos-(a?a.nodeSize:0));if(l){let u=l.getBoundingClientRect(),d=a?u.bottom:u.top;a&&c&&(d=(d+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),s={left:u.left,right:u.right,top:d-this.width/2,bottom:d+this.width/2}}}}if(!s){let a=this.editorView.coordsAtPos(this.cursorPos);s={left:a.left-this.width/2,right:a.left+this.width/2,top:a.top,bottom:a.bottom}}let o=this.editorView.dom.offsetParent;this.element||(this.element=o.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let r,i;if(!o||o==document.body&&getComputedStyle(o).position=="static")r=-pageXOffset,i=-pageYOffset;else{let a=o.getBoundingClientRect();r=a.left-o.scrollLeft,i=a.top-o.scrollTop}this.element.style.left=s.left-r+"px",this.element.style.top=s.top-i+"px",this.element.style.width=s.right-s.left+"px",this.element.style.height=s.bottom-s.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),s=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),o=s&&s.type.spec.disableDropCursor,r=typeof o=="function"?o(this.editorView,t,e):o;if(t&&!r){let i=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=en(this.editorView.state.doc,i,this.editorView.dragging.slice);a!=null&&(i=a)}this.setCursor(i),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}function pe(n){return(e,t,s)=>{const{doc:o,selection:r}=e,{empty:i,$head:a}=r;if(i&&s?.endOfTextblock(n)){const c=n==="left"||n==="up"?-1:1,l=pt.near(o.resolve(c>0?a.after():a.before()),c);if(l.$head?.parent.type.name===Ae)return t?.(e.tr.setSelection(l)),!0}return!1}}const Co=Ne({ArrowLeft:pe("left"),ArrowRight:pe("right"),ArrowUp:pe("up"),ArrowDown:pe("down")}),we=new _("modelCursor");function Mo(n,e){return n.setMeta(we,{modelCursor:e})}function ko(n){return n.getMeta(we)??null}const lt=(n,e)=>{const{doc:t}=n,s=[];if(!e)return N.empty;const{modelSelectionPositionRange:o,modelCursorPosition:r}=e,{sourceRangeToPmRange:i,sourceEndToPmPos:a}=he(t);if(r!=null){const c=Me(r,a(r),"min");if(c==null)return N.empty;if(c!=null&&wt(t,c)){const l=t.resolve(c);if(t.nodeAt(c)?.type.name===je.proseMirrorNodeName()||l.nodeBefore?.type.name===je.proseMirrorNodeName())return N.empty}s.push(ee.widget(c,()=>{const l=document.createElement("span");return l.className=vn.modelCursor,l},{ignoreSelection:!0,side:1}))}else if(o!=null){const{start:c,end:l}=i(o),u=Me(o.start,c,"max"),d=Me(o.end,l,"min");if(u==null||d==null)return N.empty;s.push(ee.inline(u,d,{class:`${_n} bg-[Highlight]!`}))}return s.length?N.create(t,s):N.empty},vo=(n,e)=>{let s=n.domAtPos(e)?.node;if(s===n.dom)return null;for(;s&&!(s instanceof HTMLElement);)s=s.parentNode;return s},xo=(n,e)=>{vo(n,e.to)?.scrollIntoView({behavior:"smooth",block:"center"})},Po=(n,e)=>{if(n&&!e)return!0;const t=n?.modelSelectionPositionRange?.start,s=e?.modelSelectionPositionRange?.start;return t!==void 0&&(s===void 0||t!==s)};function ut(n=void 0,e=void 0){return new V({key:we,state:{init:(t,s)=>({modelCursor:n,deco:lt(s,n),isNewCursor:!1,isCursorActive:e?.isCursorActive??!1}),apply:(t,s,o,r)=>{const a=ko(t)?.modelCursor??s.modelCursor,c=lt(r,a),l=!!((!s.isCursorActive||Po(a,s.modelCursor))&&c&&c.find()[0]),u=!!a&&(l||s.isCursorActive);return{modelCursor:a,deco:c,isNewCursor:l,isCursorActive:u}}},props:{decorations(t){return this.getState(t)?.deco}},view(t){return{update(s){const{deco:o,isNewCursor:r}=we.getState(s.state),i=o&&o.find()[0];i&&r&&xo(s,i)}}}})}const St="ignoreDocChange";function bo(n){return n.setMeta(St,!0)}function So(n){return n.getMeta(St)===!0}function To(n){const e=n.content.size-(n.lastChild?.content.size??0)-1;if(wt(n,e))return X.create(n,e)}const Tt=({intl:n,toaster:e,value:t,comments:s,diff:o,maxLength:r=Ct,selection:i,onFocus:a,onBlur:c,onSave:l,safeUrls:u,modelCursor:d,isDisabled:p,prevState:h,contentReferences:m,shouldUseContentReferencePlugin:v})=>{const x=se(),Y=x.schema();let k=t;r!=null&&k.length>r&&(k=k.slice(0,r),e!=null&&n!=null&&Ie(e,n));let E,M=[],A=[];o&&o.edits.length>0?{doc:E,addedRanges:M,deletedRanges:A}=Ws({diff:o}):E=x.parse(k);const H=i?Ns(E,i):To(E),P=()=>{const S=h?.plugins.find(I=>I.spec.key===xe().spec.key);return S==null||h==null?xe():xe({},S.getState(h))},O=S=>{const I=h?.plugins.find(y=>y.spec.key===ut().spec.key),w=h&&I?.getState(h);return ut(S,w)};return ft.create({doc:E,schema:Y,selection:H,plugins:[...v?[tn(m)]:[],po(n,e,r),x.inputRulesPlugin(),x.keymapPlugin(),Ne({"Mod-s":()=>(l(),!0),"Mod-z":Pt,"Mod-shift-z":Te,"Mod-y":Te}),Co,no(),yo(),nn(),P(),js(a,c),yt(s??[]),...o?[Cs(M,A)]:[],O(d),ps(new Set(u??[])),ms(n,p),bs(h?re.getState(h).suggestion:null),lo(),...xs()]})},Ro=(n,e)=>{const t=se(),s=t.schema(),o=t.parse(n);return ft.create({doc:o,schema:s,plugins:[yt(e??[])]})},Jo=({mount:n,value:e,comments:t,isDarkMode:s})=>new gt({mount:n},{editable:()=>!1,state:Ro(e,t),nodeViews:{[Ae]:(r,i,a)=>new Le(r,i,a,s)}}),Do=(n,{intl:e,toaster:t,comments:s,value:o,maxLength:r=Ct,onBlur:i,onFocus:a,onChange:c,onUpdate:l,onSave:u,safeUrls:d,modelCursor:p,selection:h,isDisabled:m,diff:v,prevState:x,contentReferences:Y,collectReactElement:k},E=!1)=>{const M=mt(sn()),A=Tt({intl:e,toaster:t,comments:s,value:o,maxLength:r,onBlur:i,onFocus:a,onSave:u,safeUrls:d,modelCursor:p,selection:h,isDisabled:m,diff:v,prevState:x,contentReferences:Y,shouldUseContentReferencePlugin:M});l(A);const H=w=>{const y=I.state.apply(w);if(I.updateState(y),l(y),!w.docChanged||So(w))return;const f=kt(y);if(!f)return;const{doc:L}=y,{changeset:U}=f;c?.({transaction:w,changeset:U,doc:L,getSerializedDocument:()=>se().serialize(L),getAdjustedComments:()=>{const T=xn(Et,y);if(T==null)return[];const q=se(),F=q.parse(q.serialize(L)),B=Jn(F,T.positions);return Qn(T.comments,B)}})},P=se(),S={...P.nodeViews(),...M?{[cn]:(w,y,f)=>new go(w,y,f,k)}:{},...rs()?{[is]:(w,y,f)=>new wo(w,y,f)}:{},...v!=null?{}:{[Ae]:(w,y,f)=>new Le(w,y,f,E)}},I=new gt({mount:n},{state:A,editable:()=>!m,dispatchTransaction:H,nodeViews:S,...M?{handleDOMEvents:{copy:(w,y)=>ho(w,y)}}:{},handlePaste(w,y){let f;if(M&&(f=y.clipboardData?.getData("application/x-prosemirror")),f||=y.clipboardData?.getData("text/plain"),f==null)return!1;W.logEvent("Canvas Prosemirror Paste",{textLength:f.length});const L=bt(w.state.doc),U=L+f.length,T=r!=null&&U>r;T&&t!=null&&e!=null&&Ie(t,e);const q=y.clipboardData?.getData("text/html");if(q){const B=No(q),R=new window.DOMParser().parseFromString(B,"text/html"),D=on.fromSchema(w.state.schema).parse(R.body),z=new rn(D.content,1,1);return w.dispatch(w.state.tr.replaceSelection(z)),!0}let F=f;if(T){const R=r-L-50;F=R>0?f.slice(0,R):""}return an(w,F,M),!0}});return{view:I,pmu:P}},No=n=>n.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),Ao="_main_5jn6z_1",Io={main:Ao};function Oo(n,e){const t=e.target;if(t instanceof Element&&[ce.PROSEMIRROR_EDITOR_CONTAINER,ce.PROSEMIRROR_CONTEXT_CHILDREN].some(c=>t.closest(`#${c}`)!=null))return!1;n.focus();const s=Ts(n.dom.getBoundingClientRect(),{x:e.clientX,y:e.clientY}),o=n.state.tr,r=n.posAtCoords({left:s.x,top:s.y});if(r!=null){const i=Math.min(r.pos,Pn(n.state.doc)-1);o.setSelection(new X(o.doc.resolve(i))),n.dispatch(o)}return!0}const Rt=({editorRef:n,wrapperClassName:e,transparentBackground:t=!1,comments:s,commentingOn:o,diff:r,paddingBottom:i,hoveredCommentId:a,focusedCommentId:c,hoveredEditId:l,rejectedEdits:u,showChanges:d,isDisabled:p=!1,value:h,onBlur:m,onFocus:v,onChange:x,onMouseLeave:Y,onSave:k,getAutocompleteSuggestion:E,safeUrls:M,children:A,width:H,modelCursor:P,shouldResetSelection:O=!1,contentReferences:S})=>{const I=Ht(),w=ln(),y=C.useRef(null),f=C.useRef(null),[L,U]=C.useState(null),T=un(),q=dn(),[{width:F},B]=Hn(),R=C.useRef(m);R.current=m;const D=C.useRef(v);D.current=v;const z=Ss(f,E),J=pn(),le=hn(J)?.planType??fn.FREE,ue=mn(J,"1958014328")?1e7:Bn(le),Ve=async g=>{x?.(g),as(J)&&z(g.getSerializedDocument)},_e=C.useRef(Ve);_e.current=Ve;const Ee=C.useRef(k);Ee.current=k;const Ce=mt(J),[At,It]=C.useState(()=>new Map),ze=C.useCallback((g,b)=>{It(K=>{const $=new Map(K);return b==null?$.delete(g):$.set(g,b),$})},[]),He=C.useCallback((g=h)=>Tt({intl:I,toaster:w,comments:s,diff:r,value:g,selection:O?void 0:f.current?.state.selection,onBlur:b=>R.current?.(b),onFocus:b=>D.current?.(b),onSave:()=>Ee.current?.(),modelCursor:P,isDisabled:p,safeUrls:M,prevState:L,contentReferences:S,shouldUseContentReferencePlugin:Ce,maxLength:ue}),[I,w,s,r,h,O,P,p,M,L,S,ze,Ce,ue]),Ot=C.useCallback(g=>{const b=He(g);f.current?.updateState(b),U(b)},[He]);C.useImperativeHandle(n,()=>({UNSAFE_setValue:Ot,revertChanges:()=>{if(f.current==null)throw new Error("Tried to call revertChanges, but viewRef.current is null");vs(f.current)},flushChanges:()=>{if(f.current==null)throw new Error("Tried to call flushChanges, but viewRef.current is null");ks(f.current)},maybeFocusOnEditor:g=>{if(f.current==null)throw new Error("Tried to call maybeFocus, but viewRef.current is null");return Oo(f.current,g)},viewRef:f})),gn(()=>{const{current:g}=y;if(!g)return;const{view:b}=Do(g,{intl:I,toaster:w,comments:s,diff:r,value:h,onBlur:K=>R.current?.(K),onFocus:K=>D.current?.(K),onChange:K=>_e.current?.(K),onUpdate:U,onSave:()=>Ee.current?.(),isDisabled:p,safeUrls:M,prevState:L,contentReferences:S,collectReactElement:ze,maxLength:ue},T);return f.current=b,()=>{b?.destroy()}},[r,ue]),C.useEffect(()=>{f.current?.setProps({editable:()=>!p})},[p]),te(g=>hs(g,p),f,[p]),te(g=>{if(!q)return;const{schema:b}=g.doc.type,K=b.nodes.code_block;return K?(g.doc.descendants(($,qe)=>{if($.type===K){const Bt=$.type.create({...$.attrs,isDarkMode:T},$.content,$.marks);g.replaceWith(qe,qe+$.nodeSize,Bt)}}),bo(g)):g},f,[q,T]),te(g=>g.setMeta(Se,d),f,[d]),te(g=>Mo(g,P),f,[P]),te(g=>g.setMeta(Et,{comments:s,commentingOn:o,hoveredCommentId:a,focusedCommentId:c}),f,[s,a,c,o]),te(g=>g.setMeta(be,{hoveredEditId:l,rejectedEdits:u??new Set}),f,[l,u]),te(g=>us(g,new Set(M??[])),f,[M]);const Lt=C.useCallback(()=>f.current,[f]),Ue=[],Fe=[];return C.Children.forEach(A,g=>{if(!C.isValidElement(g))return;const{type:b}=g;if(b===Nt)Ue.push(g);else if(b===Dt)Fe.push(g);else throw new Error("Invalid Prosemirror child: "+JSON.stringify(b))}),ne.jsx(es.Provider,{value:Lt,children:ne.jsx(ts.Provider,{value:L,children:ne.jsxs(ns.Provider,{value:F,children:[ne.jsx("div",{id:ce.PROSEMIRROR_CONTEXT_CHILDREN,children:Ue}),ne.jsxs("div",{className:e,onMouseLeave:Y,id:ce.PROSEMIRROR_EDITOR_CONTAINER,style:{paddingBottom:i},children:[ne.jsx("div",{ref:Vn(y,B),className:ie(Io.main,zn.composer,"markdown prose dark:prose-invert contain-inline-size focus:outline-hidden",t?"bg-transparent":"bg-token-main-surface-primary"),style:{width:H}}),Fe,Ce?Array.from(At.values()):null]})]})})})},Dt=({children:n})=>n,Nt=({children:n})=>n;Rt.EditorChildren=Dt;Rt.ContextChildren=Nt;export{Rt as P,ce as T,Ro as a,Zo as b,Jo as c,oo as d,so as g,Io as s};
//# sourceMappingURL=k33dlpm8wya9l7ki.js.map
