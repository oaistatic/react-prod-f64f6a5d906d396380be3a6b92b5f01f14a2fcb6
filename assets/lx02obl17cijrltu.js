const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/b2c9wjk47ow2mjzk.js","assets/gg0tb34p9fzo1omt.js","assets/forbprkns1cohsbl.js","assets/g670b8vtkhx0yc6d.js","assets/root-ilxovqci.css","assets/conversation-small-mtta3ozz.css","assets/kapf1vasjh1lo9ik.js","assets/jpdmr6hprcjyd5ie.js","assets/me58wahxzwibdrxp.js","assets/pnx8yl9r7yj5moem.js","assets/felxwdrg3fgsr1mu.js","assets/f51c6zie1stj9anw.js","assets/cs320738df36xnc1.js","assets/ktkip0mvmcezjx46.js"])))=>i.map(i=>d[i]);
import{bU as F,d as me,b6 as fe,c2 as je,bo as ye,co as ke,D as re,a7 as Ne,P as Ee,h as te,j as he,R as Ae,l as Ge,t as Pe,dw as De,l4 as Te,aQ as Oe,cl as ze,bV as xe,be as Le,bW as pe}from"./g670b8vtkhx0yc6d.js";import{j as n,m as V,b as K,r as a,A as Ue,u as ve,o as He}from"./gg0tb34p9fzo1omt.js";import{I as Z,D as we,u as Be}from"./fa8fxhoxwvscg8x6.js";import{gt as Fe,cc as qe,op as $e,bI as Ve,bA as B,bK as Ke,bM as We,bC as Qe,oq as Ye,or as Xe,gC as Je,aS as Ie,bB as Se,gD as Ze,os as I,iF as et,ot as ne,dV as tt,ou as nt,ov as ce,ow as at,ox as st,e$ as it}from"./forbprkns1cohsbl.js";import{C as _e}from"./c7q67liujwt03fxw.js";import{D as ot}from"./el6s6dnz325xncpm.js";import{C as rt}from"./mwnvv8c9o4042bbu.js";import"./cf441rgiwd88s4mv.js";import"./cg8klfuw4d9cqove.js";const be=({children:e,isDimensionsUnknown:t})=>n.jsxs(V.div,{className:F(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),ct=({children:e,isDimensionsUnknown:t,width:s,height:i})=>n.jsxs(V.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:F(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:s??"auto",height:i??"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]});function lt(){const[t,s]=a.useState(new Date);a.useEffect(()=>{s(new Date)},[]);const i=Fe(+t,12e4);return n.jsx(qe,{percentage:i,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:`${(100-i)/100*.2}s`,transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Ce=({isGettingStarted:e})=>{const t=K(),s=a.useMemo(()=>e?t.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):t.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,t]),i=me(),o=fe(i,"3019066937").get("should_show_cot_header",!1),l=a.useMemo(()=>e?n.jsx(_e,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(lt,{}),[e]);return n.jsx("div",{className:F("absolute inset-0 flex items-end justify-between px-6 py-6"),children:n.jsxs(Ue,{mode:"popLayout",children:[o&&n.jsx(V.span,{className:F("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:s},s),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:l})]})})},le=je.div`invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2
  ${({$rightAlign:e})=>e?"end-3":"start-3"}
  ${({$alwaysVisible:e})=>e?"visible":""}`,dt=({imageUrl:e})=>{const[t,s]=a.useState(void 0),i=K(),o=$e(),l=a.useCallback(()=>{const r=new Date;return`${i.formatDate(r,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}.png`},[i]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(le,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(Z,{icon:Ve,selected:t===!0,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!0,analyticsContext:o}),s(!0)}}),t!==!0&&n.jsx(Z,{icon:Ke,selected:t===!1,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!1,analyticsContext:o}),s(!1)}})]}),n.jsx(le,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(Z,{icon:We,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenDownload({analyticsContext:o}),Qe({url:e,fileName:l()})}})})]})};function Me({withLottie:e}){const s=K().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":s,children:n.jsx(_e,{size:40,arcPercentage:.2,children:n.jsx(ot,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const Re=300,ut=1.3,de=.05,gt=/blur\(([\d.]+)px\)/,mt={duration:Re/1e3,ease:"linear"};function ee(e,t,s){e.sort((r,c)=>r.lastSrcReceivedTime-c.lastSrcReceivedTime);const i=new Array(e.length).fill(0);for(let r=0;r<=e.length;r+=1){const c=r-1,x=r,u=e[c]?.availablePercentComplete??0,f=e[x]?.availablePercentComplete??1;if(t>=u&&t<=f&&u!==f){const _=(t-u)/(f-u);i[c]=1-_,i[x]=_}}const o=i[i.length-1],l=i[i.length-2];return o===1&&l===0&&(i[i.length-2]=.01),s&&t<=e[0]?.availablePercentComplete&&(i[0]=1),i}const ft=({alt:e,src:t,availablePercentComplete:s,onAnimationUpdate:i,ignoreFirstChunk:o=!1,isTransparent:l=!1,dimensions:r,onError:c,unconstrainedWidth:x=!1,progressLoaderProps:u})=>{const f=ye(),_=a.useMemo(()=>`url(${f?Ye:Xe})`,[f]),[S,C]=a.useState(!1),[v,A]=a.useState(1e3),[w,D]=a.useState(s??0),[g,b]=a.useState(s===1?1:0),N=a.useRef(performance.now()),h=a.useRef(0),p=a.useRef([]),[T,y]=a.useState([0]),[U,O]=a.useState(s===1),L=a.useRef(!1),E=a.useRef(null),k=w===1,R=s===1&&U,G=r?r.width/r.height:1;a.useEffect(()=>{!S&&s&&(C(!0),h.current=performance.now())},[S,s]),a.useEffect(()=>{const m=p.current[p.current.length-1]?.src;if(t&&t!==m){const d=p.current.findIndex(M=>M.availablePercentComplete===s);d!==-1?p.current[d]={src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}:p.current.push({src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}),y(ee(p.current,w,o))}},[t,w,o,s]);const W=a.useCallback(()=>{E.current&&s&&(A(R?Re:(performance.now()-N.current)*ut),(!o||L.current||s>=de)&&s!==1&&b(s),L.current=!0,N.current=performance.now(),u?.setHasImageReady(!0))},[s,R,o,u]),q=a.useCallback(m=>{const d=parseFloat(m.height)/100;i?.(d),D(d),y(ee(p.current,parseFloat(m.height)/100,o))},[i,o]),Q=a.useCallback(m=>{const d=m.filter.toString().match(gt)?.[1]??"0",P=(16-parseFloat(d))/16,J=1-g,Y=g+J*P;i?.(Y),D(Y),y(ee(p.current,Y,o))},[o,g,i]);if(!S)return n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Me,{withLottie:!0})});const $={duration:v/1e3,ease:"linear"},z=s!==1||!l;return n.jsxs("div",{className:F("relative z-0 cursor-pointer overflow-hidden",G<1?"max-w-[400px]":"max-w-[480px]",!k&&"pointer-events-none",!L.current&&"bg-token-main-surface-secondary",x&&"max-w-full"),"aria-label":e,style:{aspectRatio:G},children:[!u?.shouldHideDiagonalShimmer&&s&&s<de&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(V.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:R?!1:{height:"0%"},animate:k?{height:"100%"}:{height:`${g*100}%`},onUpdate:R?void 0:q,transition:R?{duration:0,ease:"linear"}:$,style:k?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:E,src:t,onLoad:W,onError:c,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:G}}),l&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:_,backgroundSize:"auto"}})})]}),n.jsx(V.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:R?{filter:"blur(0px)"}:void 0,transition:R?mt:void 0,onUpdate:R?Q:void 0,style:{aspectRatio:G},children:p.current.map((m,d)=>{const M=T[d],P=m.availablePercentComplete===1;return M!==0||P?n.jsx("img",{src:m.src,alt:e,style:{opacity:M,willChange:"opacity",aspectRatio:G},className:!R&&u?.shouldShowPulseAnimation?"bg-scale-pulse":"",onLoad:P?()=>O(!0):void 0},m.src):null})}),n.jsx(V.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:G},children:z&&p.current.filter((m,d)=>T[d]!==0).map(m=>n.jsx("img",{src:m.src,alt:e,className:"absolute top-0 w-full"},m.src))})]})},ue=2,X=({pointer:e,altLabel:t,isEditorAvailable:s,onPercentageRendered:i,messageId:o,imageIndex:l,clientThreadId:r,serverThreadId:c,onEditorClick:x,compact:u,progressLoaderProps:f})=>{const _=ve(),[S,C]=a.useState(void 0),v=a.useRef(void 0),A=e.metadata?.generation?.gen_id,w=e.metadata?.generation?.height??void 0,D=e.height,g=(w??0)/D,b=a.useRef({}),[N]=He(),{isUnauthenticated:h}=ke(),[p,T]=a.useState(!1),y=a.useContext(we),U=e.width/e.height,O=Je({imageAssetPointer:e,serverThreadId:c}),E=a.useCallback((d=!1)=>{!d&&v.current===e.asset_pointer||(v.current=e.asset_pointer,Ie.fetch(_,{asset:e,conversationId:c,force:d,isUnauthenticated:h}).then(M=>{C(M)}).finally(()=>{v.current=void 0}))},[e,_,c,h,null]);a.useEffect(()=>{const d=e.asset_pointer!==S?.asset_pointer;(!S||d)&&E()},[S,e.asset_pointer,E]);const k=a.useMemo(()=>Se({pointer:S,conversationId:c,messageId:o,source:y?"paragen":"chat",imageIndex:l.toString()}),[S,c,o,y,l]),R=a.useRef(g);a.useEffect(()=>{g===1&&R.current<1&&B.renderingComplete({analyticsContext:k})},[g,k]);const G=a.useCallback(()=>{S&&x?.({image:S,messageId:o,analyticsContext:k})},[S,o,x,k]),W=a.useMemo(()=>({width:e.width,height:e.height}),[e]),q=a.useCallback(()=>{const d=(b.current[e.asset_pointer]??0)+1;if(b.current[e.asset_pointer]=d,b.current[e.asset_pointer]>ue)return re.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:c,asset_pointer:e.asset_pointer,max_retries:ue});re.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:c,asset_pointer:e.asset_pointer,current_retry:d}),b.current[e.asset_pointer]=d,E(!0)},[e.asset_pointer,E,c]),Q=a.useCallback(d=>{d===1&&T(!0),i?.(d)},[i]),H=a.useRef(null),$=a.useRef(null);a.useEffect(()=>{if(H.current&&f?.setContainerSize){const d=H.current.getBoundingClientRect(),M={width:d.width,height:d.height},P=$.current;(!P||P.width!==M.width||P.height!==M.height)&&($.current=M,f.setContainerSize(M))}},[f]);const z=S?.url,m=O??z;return n.jsx(Ze.Provider,{value:k,children:n.jsxs("div",{ref:H,className:F("group/imagegen-image relative w-full overflow-hidden",U<1?"max-w-[400px]":"max-w-[480px]",u?"rounded-lg":"rounded-2xl",y&&"max-w-full",o===N.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:`image-${o}`,style:{aspectRatio:U},onClick:s?G:void 0,tabIndex:0,children:[O&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:O}),n.jsx(ft,{alt:t,src:z,availablePercentComplete:g,onAnimationUpdate:Q,isEditorAvailable:s,ignoreFirstChunk:!0,isTransparent:e.metadata?.generation?.transparent_background,dimensions:W,onError:q,unconstrainedWidth:y,progressLoaderProps:f},A),f?.state&&f?.state!==I.Complete&&!p&&f?.hasImageReady&&n.jsx(Ce,{isGettingStarted:!1}),p&&!u&&(y?n.jsx(dt,{imageUrl:z??""}):n.jsx(et,{imageAssetPointer:z,imageUrl:m,messageId:o,clientThreadId:r,serverThreadId:c,shouldShowOverflow:O!==void 0}))]},A)})},ht=({imageGenerationState:e,isInterrupted:t,asyncMessage:s,imageAssetPointer:i,altLabel:o,clientThreadId:l,serverThreadId:r,onEditorClick:c,isEditorAvailable:x,setAnimationPercentage:u,messageId:f})=>{const[_,S]=a.useState(null),C=_==null,[v,A]=a.useState(!0),w=e===I.Thinking||e===I.AsyncGenerating&&!s?.metadata?.is_visually_hidden_from_conversation,D=e===I.Generating||e===I.Complete;return a.useEffect(()=>{w&&A(!1)},[w]),t?null:n.jsxs(n.Fragment,{children:[(w||!v)&&n.jsx(ct,{isDimensionsUnknown:C,width:_?.width,height:_?.height,children:C&&n.jsx(Ce,{isGettingStarted:!0})}),D&&n.jsx(V.div,{className:"pb-2",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:v?"visible":"hidden",exit:"hidden",children:i&&n.jsx(X,{pointer:i,altLabel:o,isEditorAvailable:x,onPercentageRendered:u,messageId:f,clientThreadId:l,serverThreadId:r,imageIndex:0,onEditorClick:c,progressLoaderProps:{state:e,setContainerSize:S,hasImageReady:v,setHasImageReady:A,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function xt({title:e,description:t,shimmer:s}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:F("text-lg font-medium",s&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const pt=({cotMessages:e,visualPercentComplete:t,isInterrupted:s=!1,state:i})=>{const l=K().formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),r=i===I.Complete||t===1,c=a.useMemo(()=>{if(s)return l;if(!e)return;if(r)return e.complete;if(t){const x=Object.keys(e.generating);for(let u=0;u<x.length;u+=1){const f=parseFloat(x[u]);if(t<f)return e.generating[x[u]]}}else return e.thinking;return e.complete},[e,l,s,r,t]);return c&&n.jsx(rt,{latestHeadline:c,isComplete:r||s,showChunkIcon:!1,isExpandDisabled:!0})},vt=({pointersToRender:e,altLabel:t,isEditorAvailable:s,updatePercentageRendered:i,toolCallMessage:o,toolOutputMessageIds:l,clientThreadId:r,serverThreadId:c,handleEditorClick:x})=>{const u=ne.useStore(),f=ne.useSelectedIndex();a.useEffect(()=>{u.setSelectedIndex(Math.max(l.findIndex(g=>g===o?.metadata?.selected_image_message_id),0))},[]);const _=a.useRef({}),S=a.useCallback(g=>b=>{_.current[g]=b;const N=Object.keys(_.current).length,h=Object.values(_.current).reduce((p,T)=>p+T,0);i?.(h/N)},[i]),[C,v]=a.useState(null),A=Ne(r,te.getRequestId),w=tt(A);a.useEffect(()=>{!w&&C!=null&&o!=null&&c!=null&&(ge(o.id,l[C],r,c),v(null))},[w]);const D=a.useCallback(g=>{u.setSelectedIndex(g);const b=Object.values(_.current);Ee.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:c,messageId:l[g],imageIndex:g.toString(),isLoading:(b.length===0||b.some(p=>p<1)).toString()});const h=te.getConversationLastTurn(he(r))?.messages.find(p=>p.id===o?.id)!=null;o!=null&&c!=null&&(h&&w?v(g):ge(o.id,l[g],r,c))},[o,l,r,c,u,w,v]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(X,{pointer:e[f],altLabel:t,isEditorAvailable:s,messageId:l[f],imageIndex:f,clientThreadId:r,serverThreadId:c,onEditorClick:x}),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((g,b)=>n.jsx(wt,{pointer:g,altLabel:t,isSelected:b===f,onClick:()=>D(b),onPercentageRendered:g.metadata?.generation?.gen_id?S(g.metadata.generation.gen_id):void 0,messageId:l[b],imageIndex:b,clientThreadId:r,serverThreadId:c},g.metadata?.generation?.gen_id))})]})},wt=({pointer:e,altLabel:t,isSelected:s,onClick:i,onPercentageRendered:o,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:x})=>n.jsxs("button",{type:"button",onClick:i,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:F(s&&"opacity-70"),children:n.jsx(X,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:o,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:x,compact:!0})}),s&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function ge(e,t,s,i){const o=await Ae.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:i}}),l=o.id;l!=null&&Ge(s,r=>{Pe.updateTree(r,c=>{c.updateNodeMessage(l,o)})})}function It(e){const t=e.find(r=>r.author.role==="tool"&&r.author.name===nt&&r.content.content_type==="text"),[s,...i]=t?.content.content_type==="text"?t.content.parts:[],o=i.pop(),l=i.length;return s&&o&&i.length>0?{thinking:s,complete:o,generating:i.reduce((r,c,x)=>{const u=(x+1)/l;return r[u.toFixed(2)]=c,r},{})}:void 0}const St=e=>{const t=K(),{size:s="image",count:i=1}=e||{};return i>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:s==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},_t=xe(()=>pe(()=>import("./b2c9wjk47ow2mjzk.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12])).then(e=>e.ImageGenConversationLightboxNew)),bt=xe(async()=>pe(()=>import("./ktkip0mvmcezjx46.js"),__vite__mapDeps([13,3,1,4,2,5,7,8,9,10,11,12])).then(e=>e.ImageGenNewEditor)),Ct=[I.Empty,I.Errored],Dt=({messages:e,clientThreadId:t,isLastTurnInConversation:s,isParagen:i=!1})=>{const o=De(t),l=K(),r=l.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),[c,x]=a.useState(!1),[u,f]=a.useState(null),[_,S]=a.useState(null),{messageIds:C,imageAssetPointers:v}=a.useMemo(()=>ce(e),[e]),A=e.find(at),w=ne.useSelectedIndex(),D=v?.[w]?.metadata?.generation?.gen_size,g=St({size:D??"image",count:v?.length??1}),b=a.useMemo(()=>It(e)??g,[e,g]),N=e.find(m=>m.metadata?.image_gen_async),h=a.useMemo(()=>st(e,s),[e,s]),p=a.useRef(!1),T=a.useRef(!1),y=a.useRef(null),U=a.useMemo(()=>Se({pointer:v[w],conversationId:o,messageId:C[w],source:i?"paragen":"chat",imageIndex:w.toString()}),[v,C,w,o,i]);a.useEffect(()=>{if(!p.current&&(h===I.Thinking||h===I.Generating))p.current=!0,y.current=performance.now();else if(p.current&&!T.current)if(h===I.Complete){const m=y.current?performance.now()-y.current:void 0;B.generationSuccess({analyticsContext:U,durationMs:m}),T.current=!0}else h===I.Errored&&(B.generationFailure({analyticsContext:U,errorReason:"assistant_error"}),T.current=!0)},[h,U]);const O=e[e.length-1],L=a.useMemo(()=>O&&Te(O),[O]),E=me(),k=Oe(E).checkGate("3287225511"),{onRequestCompletion:R,currentModelId:G}=it(),W=fe(E,"3019066937").get("should_use_new_ui",!1),q=Be({clientThreadId:t})&&h===I.Complete,[Q,H]=a.useState(0),$=ve(),z=a.useCallback(async({image:m,messageId:d,analyticsContext:M})=>{if(k){const P=he(t),J=P?te.getConversationTurns(P).flatMap(j=>j.messages):e,{imageAssetPointers:Y,messageIds:ae}=ce(J,{skipSort:!0}),se=(i?[m]:await Promise.all(Y.map(j=>Ie.fetch($,{asset:j,conversationId:o})))).map((j,oe)=>({id:j.metadata?.generation?.gen_id??ae[oe],archived:!1,transformationId:j.metadata?.generation?.gen_id??null,url:j.url,assetPointer:j.asset_pointer,thumbnail:null,width:j.width,height:j.height,title:null,conversationId:o,messageId:ae[oe]}));B.editorClick({sourceOperation:m.metadata?.dalle?.edit_op??"none",analyticsContext:M});const ie=se.findIndex(j=>j.assetPointer===m.asset_pointer);ze(E,({onClose:j})=>n.jsx(_t,{images:se,initialIndex:ie===-1?0:ie,onClose:j,onRequestCompletion:R,clientThreadId:t,currentModelId:G}))}else f(m),S(d),x(!0),B.editorClick({sourceOperation:m.metadata?.dalle?.edit_op??"none",analyticsContext:M})},[e,o,E,R,t,G,$,k,i]);return Ct.includes(h)?null:n.jsxs(we.Provider,{value:i,children:[n.jsx("div",{className:"flex flex-col",children:W?n.jsx(ht,{imageGenerationState:h,isInterrupted:L,asyncMessage:N,imageAssetPointer:v[0],altLabel:r,clientThreadId:t,serverThreadId:o,onEditorClick:z,setAnimationPercentage:H,isEditorAvailable:q,messageId:C[0]}):n.jsxs(n.Fragment,{children:[h!==I.Unavailable&&h!==I.AsyncGenerating&&h!==I.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(pt,{cotMessages:b,visualPercentComplete:Q,isInterrupted:L,state:h})}),h===I.Thinking&&!L&&n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Me,{withLottie:!0})}),h===I.AsyncGenerating&&!N?.metadata?.is_visually_hidden_from_conversation&&n.jsx(xt,{shimmer:!0,title:N?.metadata?.ui_card_title,description:N?.metadata?.ui_card_description}),(h===I.Generating||h===I.Complete)&&!L&&n.jsx("div",{className:"pb-2",children:v.length>1?n.jsx(vt,{pointersToRender:v,altLabel:r,isEditorAvailable:q,updatePercentageRendered:H,toolCallMessage:A,toolOutputMessageIds:C,clientThreadId:t,serverThreadId:o,handleEditorClick:z}):n.jsx(X,{pointer:v[0],altLabel:r,isEditorAvailable:q,onPercentageRendered:H,messageId:C[0],imageIndex:0,clientThreadId:t,serverThreadId:o,onEditorClick:z})})]})}),!k&&n.jsx(Le,{testId:"modal-image-gen-content",type:"success",size:"fullscreen",isOpen:c,onClose:()=>x(!1),title:l.formatMessage({id:"imagegen.message.contentModalTitle",defaultMessage:"Edit image"}),visuallyHiddenHeader:!0,className:"dark:bg-(--gray-800)",children:u&&n.jsx(bt,{image:u,isLoadingNewImage:!1,clientThreadId:t,onClose:()=>x(!1),messageId:_??""})})]})};export{Dt as ImageGenMessage};
//# sourceMappingURL=lx02obl17cijrltu.js.map
