import{f as A,o as k}from"./nir0q9e2l94u37hi.js";import{n as P,a5 as $,an as R,dK as j}from"./g670b8vtkhx0yc6d.js";import{d as O,e4 as Q}from"./forbprkns1cohsbl.js";import{r as S,u as K,b as q}from"./gg0tb34p9fzo1omt.js";import{u as _}from"./juuj7s9t3x7u9it2.js";function U(e){const r=S.useMemo(()=>e.join("\0"),[e]);return S.useMemo(()=>e,[r])}function J(e,r,o){const a=q(),[i,m]=S.useState(o?a.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[u,t]=S.useState(i);S.useEffect(()=>{const f=O(()=>t(i),200);return f(),f.cancel},[i]);const s=S.useMemo(()=>`last-event-${e}-${o??""}-${Math.random().toString(36).slice(2)}`,[e,o]);return z(e,o,["task_turn_event"],{enabled:!!o&&!k(r),subscriberId:s,onEvent:f=>m(f.task_turn_event.text)}),u}function z(e,r,o,{enabled:a=!0,subscriberId:i,onEvent:m,onComplete:u}){const t=_(m),s=_(u),f=U(o),l=K(),c=S.useCallback(p=>{t.current(p)},[t]),n=S.useCallback(()=>{s.current?.()},[s]);S.useEffect(()=>{if(!(!r||!a))return C.retainTurnStream(l,e,r,i,f,c,n),()=>{C.releaseTurnStream(e,r,i)}},[e,r,i,f,a,l,c,n])}async function*D({taskId:e,turnId:r,abortSignal:o,types:a}){let m=window.location.origin+`/backend-api/wham/tasks/${e}/turns/${r}/stream`;if(a.length>0){const t=a.map(s=>`item_type=${encodeURIComponent(s)}`).join("&");m+=`?${t}`}const u=Q(m,{method:"GET",signal:o,headers:{...R({isAuthOptional:!1}),"Content-Type":"text/event-stream"},observer:{onClose:(t,s)=>{if(s&&!g(s))throw s}}});try{for await(const t of u){const s=G(t);s&&(!a||a.includes(s.item_type)?yield s:j.warn("Unknown event type",{event:t}))}}catch(t){if(g(t))return;throw t}}function G(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function g(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const M=P($(()=>({turnStreams:{}}))),T=M.getState,y=M.setState;function v(e,r){return`${e}:${r}`}const w=20;function H(e,r,o,a){let i;return y(m=>{const u=m.turnStreams[r];if(!u)return;if(u.initPromise){i=u.initPromise;return}const{abortController:t}=u,f=(async()=>{let l=0;const c=n=>{const p=[];y(h=>{const d=h.turnStreams[r];d&&(d.seenEventIds.has(n.id)||(d.seenEventIds.add(n.id),d.emittedEvents.push(n),Object.values(d.subscribers).forEach(b=>{if(!b.types.includes(n.item_type))return;const E=b.lastTimestamps[n.item_type];E&&n.timestamp<=E||(b.lastTimestamps[n.item_type]=n.timestamp,p.push(b.onEvent))})))}),p.forEach(h=>h(n))};for(;!t.signal.aborted&&l<w;){try{const b=D({taskId:o,turnId:a,abortSignal:t.signal,types:["task_turn_event","work_log_message","log","task_title_generated"]});for await(const E of b){if(t.signal.aborted)break;c(E)}}catch(b){if(g(b)||t.signal.aborted)break}const n=A(o,a),p=await e.fetchQuery(n),h=k(p.turn.turn_status);if(h&&e.refetchQueries({queryKey:["wham","task",o]}),l+=1,l>=w||t.signal.aborted||h)break;const d=Math.min(16e3,1e3*2**l)+Math.random()*500;await new Promise(b=>setTimeout(b,d))}if(!t.signal.aborted){const n=T().turnStreams[r]?.subscribers;Object.values(n??{}).forEach(p=>{p.onComplete?.()})}})().finally(()=>{y(l=>{const c=l.turnStreams[r];c&&c.initPromise===f&&(c.initPromise=null,Object.keys(c.subscribers).length||delete l.turnStreams[r])})});u.initPromise=f,i=f}),i??T().turnStreams[r]?.initPromise??Promise.resolve()}const C={async retainTurnStream(e,r,o,a,i,m,u){const t=v(r,o);let s=!1;y(l=>{let c=l.turnStreams[t];c?c.initPromise||(s=!0,c.abortController=new AbortController):(s=!0,c={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},l.turnStreams[t]=c);const n=c.subscribers[a];n?(n.types=Array.from(i),n.onEvent=m,n.onComplete=u):c.subscribers[a]={subscriberId:a,types:Array.from(i),onEvent:m,onComplete:u,lastTimestamps:{}}});const f=T().turnStreams[t].emittedEvents;for(const l of f)i.includes(l.item_type)&&m(l);s&&await H(e,t,r,o)},releaseTurnStream(e,r,o){const a=v(e,r);let i=!1,m;y(u=>{const t=u.turnStreams[a];!t||!t.subscribers[o]||(delete t.subscribers[o],Object.keys(t.subscribers).length||(i=!0,m=t.abortController,delete u.turnStreams[a]))}),i&&m&&m.abort()}};function L(e,r){return!e||e.length<=r?e:e.slice(0,r/2)+"â€¦"+e.slice(-r/2)}export{z as a,g as i,L as m,J as u};
//# sourceMappingURL=ogvupmk4xezkmrqf.js.map
