import{b as oe,r as o,j as t,M as T,A as ge,m as O,v as vt,e as ye,av as Et,at as St,f as _e}from"./gg0tb34p9fzo1omt.js";import{be as Xe,cY as Le,dX as be,bg as re,hx as wt,jp as jt,D as me,ay as Z,az as Q,bU as P,ch as Nt,ar as Ve,ad as Ye,R as ce,A as Ct,q1 as Tt,f7 as Rt,jw as kt,f4 as Me,q2 as _t,hp as Ke,f8 as Mt,dZ as At,fw as Ot,eh as It,g5 as Lt,i$ as Dt,hg as Pt,q3 as Bt,cO as Ae,f9 as Re,aG as Ft,cX as Ut,P as $t,g as Ht,ht as Wt,jF as qt,bj as Gt,ic as zt,c2 as X,e0 as Xt,bf as Vt,dk as Yt,d as Kt,m as Zt}from"./g670b8vtkhx0yc6d.js";import{lz as Qt,lA as Jt,n$ as es,cc as Ze,i3 as ts,i4 as ss,aw as ns,i6 as as,i7 as rs,dD as os,i9 as is,N as ls,qh as W,ql as cs,c5 as Qe,b$ as ds,dc as us,cs as Je,bE as De}from"./forbprkns1cohsbl.js";import{u as et}from"./go2lz3yja1ixfdzl.js";import{T as Oe,g as fs,i as ms,d as ps}from"./gffsn29yylc5pncm.js";import{M as N,a as ve,b as ue,c as xs,d as Ee,E as J}from"./ihgbljwwpo1mzi43.js";import{C as hs,L as Pe,a as gs}from"./e0kfywq1jfn60tks.js";import{s as ys,r as bs,t as vs,S as ie}from"./jh4r0k3f3n3zptua.js";import{L as Es}from"./gy64pge8qevmvg7e.js";import{N as Ss}from"./jy1u8exw8iz2slve.js";import{S as ws}from"./h431y4zi2z7ivdmh.js";import{u as Ce,f as js,n as tt}from"./jec2dxephizdapuu.js";const st=({origin:e,url:s})=>t.jsxs("div",{"aria-label":s,className:"w-full min-w-0 pe-4 text-start whitespace-nowrap",children:[t.jsx("span",{"aria-hidden":!0,className:"text-token-text-primary",children:e}),t.jsx("span",{"aria-hidden":!0,className:"text-token-text-tertiary",children:s.replace(e,"")})]}),Ns=({request:e,isDenied:s=!1,onClick:n})=>{const[{width:a},r]=et();return t.jsxs("button",{ref:r,className:"group relative z-0 my-1 flex w-full items-center",onClick:n,children:[t.jsx("div",{className:"sticky start-0 z-[-1] w-0",children:t.jsx("div",{className:"absolute top-0 hidden h-8 -translate-y-1/2 bg-gray-100 group-hover:block",style:{width:a}})}),t.jsx("div",{className:"bg-token-main-surface-primary text-token-text-secondary sticky start-0 z-10 flex h-8 shrink-0 items-center px-2 group-hover:bg-gray-100",children:s?t.jsx(es,{className:"icon text-red-500"}):t.jsx(jt,{className:"icon text-green-500"})}),t.jsx(st,{...e})]})},Cs=({title:e,requests:s})=>{const n=oe(),[a,r]=o.useState(()=>new Set),l=()=>{for(const{requestId:i,approve:c,deny:m}of s)a.has(i)?m():c()},d=()=>{for(const i of s)i.deny()},f=i=>{r(c=>{const m=new Set(c);return m.has(i)?m.delete(i):m.add(i),m})},u=s.length-a.size;return t.jsx(Xe,{testId:"modal-confirm-fetch-request",isOpen:!0,shouldIgnoreClickOutside:!0,onClose:l,type:"success",title:t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-xl",children:t.jsx(T,{id:"VmMpF1",defaultMessage:"Allow network access?"})}),t.jsx(be,{side:"top",contentClassName:"max-w-2xs!",label:t.jsx(T,{id:"WT7tgj",defaultMessage:"Learn more about network requests in canvas"}),children:t.jsx(re,{icon:wt,openNewTab:!0,onClick:()=>Qt.logButtonClick(Jt.LEARN_MODE_ABOUT_NETWORK_REQUESTS),as:"a",color:"ghost",size:"small",className:"text-token-text-secondary aspect-square p-1!",to:"https://help.openai.com/en/articles/9930697-what-is-the-canvas-feature-in-chatgpt-and-how-do-i-use-it#h_cd52fdbc16"})})]}),description:t.jsxs("div",{className:"mt-3 flex flex-col gap-3",children:[t.jsx("span",{className:"text-token-text-primary block",children:t.jsx(T,{id:"qk11AX",defaultMessage:"{title} is trying to connect to the network. If you don’t recognize {numRequests, plural, one {this request} other {any of these requests}}, don’t allow this app access to the network.",values:{title:`"${e}"`,numRequests:s.length}})}),t.jsx("div",{className:"flex max-w-full flex-col",children:s.length>1?t.jsx("ul",{className:"border-token-border-default relative flex max-h-48 flex-col overflow-x-auto overflow-y-auto rounded-lg border",children:s.map(i=>{const{requestId:c}=i;return t.jsx("li",{children:t.jsx(Ns,{request:i,isDenied:a.has(c),onClick:()=>f(c)})},c)})}):t.jsx("div",{className:"no-scrollbar bg-token-main-surface-secondary overflow-x-auto rounded-lg p-2",children:t.jsx(st,{...s[0]})})})]}),primaryButton:t.jsx(Le.Button,{disabled:u===0,title:s.length>1?n.formatMessage({id:"xpKkWv",defaultMessage:"Allow selected ({count})"},{count:u}):n.formatMessage({id:"ZeMrpd",defaultMessage:"Allow"}),color:"primary",onClick:l}),secondaryButton:t.jsx(Le.Button,{title:n.formatMessage({id:"TjJzqR",defaultMessage:"{count, plural, one {Deny} other {Deny all}}"},{count:s.length}),color:"secondary",onClick:d})})},Ts=({instrument:e})=>{switch(e.type){case"hist":return Z.hist(Q.WEB_SANDBOX,e.label,e.tags,e.value);case"count":return Z.count(Q.WEB_SANDBOX,e.label,e.tags,e.count);case"error":return me.addError(e.error)}},nt=({size:e=60,thickness:s=1/16,checkpoints:n,activeCheckpointId:a,isComplete:r=!1,onTransitionComplete:l,color:d})=>{const[f,u]=o.useState(0),i=n.findIndex(h=>h.id===a),c=o.useRef(null),m=n[i];o.useEffect(()=>{if(!m||r)return;const h=n.length,p=i*100/h,E=(i+1)*100/h;u(p);let S=null,y=null;const x=5/m.estimatedTime,b=_=>{y==null&&(y=_);const I=_-y;if(I!==0){const R=E-p,L=p+R*(1-Math.exp(-x*I));u(Math.min(L,E-1e-4))}S=window.setTimeout(()=>{c.current=requestAnimationFrame(b)},16)};return c.current=requestAnimationFrame(b),()=>{S!=null&&window.clearTimeout(S),c.current!=null&&cancelAnimationFrame(c.current)}},[i,r]);const g=()=>{r&&l?.()};return t.jsx(Ze,{sizeOverride:e,className:P(d==null&&"text-primary",d==="dark"&&"text-back",d==="light"&&"text-white"),thickness:s,backgroundStrokeClassName:P(d==null&&"stroke-[rgba(0,0,0,0.1)] dark:stroke-[rgba(0,0,0,0.32)]",d==="dark"&&"stroke-[rgba(0,0,0,0.32)]",d==="light"&&"stroke-[rgba(0,0,0,0.1)] "),percentage:r?100:f,onTransitionEnd:g,transitionDuration:"50ms",transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})},Rs=({checkpoints:e,activeCheckpointId:s,isIndeterminate:n=!1,isComplete:a})=>{const[r,l]=o.useState(a);return o.useEffect(()=>{l(a)},[s]),t.jsx(ge,{children:(s!=null&&!r||n)&&t.jsxs(O.div,{initial:{opacity:0},exit:{opacity:0},animate:{opacity:1},className:"bg-token-main-surface-primary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",children:[n?t.jsx(Ze,{percentage:30,thickness:1/12,className:"text-primary animate-spin",backgroundStrokeClassName:"dark:stroke-[rgba(255,255,255,0.4)] stroke-[rgba(0,0,0,0.1)]",sizeOverride:12}):s&&t.jsx(nt,{size:12,thickness:1/12,checkpoints:e,activeCheckpointId:s,isComplete:a,onTransitionComplete:()=>l(!0)}),t.jsxs("span",{className:"text-token-text-secondary flex items-baseline text-sm",children:[t.jsx(T,{id:"zfcWbe",defaultMessage:"Updating"}),t.jsx(Oe,{gap:1.5,padding:2,size:2})]})]})})};function ks(e){let s=null;const n=[];let a=!1;return e.on("message",r=>{s?(s({value:r,done:a}),s=null):n.push(r),r.type===N.RUN_COMPLETE&&(a=!0)}),{[Symbol.asyncIterator](){return this},next(){if(n.length>0){const r=n.shift();return Promise.resolve({value:r,done:a})}return a?Promise.resolve({value:void 0,done:a}):new Promise(r=>{s=r})}}}function Be(){let e=null;const s=new Promise(n=>e=n);return{resolve:e,promise:s}}const at=()=>{const[e,s]=o.useState(Be);return[e,o.useCallback(()=>s(Be()),[])]},rt=()=>Tt(Ve.getItem(Ye.CODE_EXECUTION_DOMAIN_ALLOW_LIST),s=>Rt(s,{origin:Me,expiresAt:kt}),[]).filter(({expiresAt:s})=>s>=Date.now()),Fe=(e,s)=>{const{origin:n}=new URL(e);let a=[...hs];const r=rt().map(({origin:l})=>l);return s&&(a=a.concat(r)),a.includes(n)},_s=({sessionId:e,networkAccessDeniedMessage:s,disableNetworkRequests:n,unsafeAllowAllNetworkRequests:a})=>{const r=Nt(),l=oe(),d=o.useRef(null),f=o.useRef(null),u=o.useRef(null),[i,c]=o.useState([]),m=o.useCallback(y=>f.current?.postMessage(y),[]),g=o.useCallback(y=>u.current?.postMessage(y),[]);o.useEffect(()=>()=>{g({type:ve.DISCONNECT,sessionId:e})},[e]);const h=o.useCallback(({url:y,requestId:x})=>{try{if(a||Fe(y,!n))return g({type:ve.FETCH_RESPONSE,isApproved:!0,requestId:x});if(n)return r.danger(s??l.formatMessage({id:"Lp7cKY",defaultMessage:"Network access is disabled."}),{loggingTitle:"Network access is disabled.",toastId:"network_access_denied"});Z.count(Q.WEB_SANDBOX,"network_access_requested");const{origin:b}=new URL(y),_=R=>{Z.count(Q.WEB_SANDBOX,`network_access_request.${R?"allow":"deny"}`),g({type:ve.FETCH_RESPONSE,isApproved:R,requestId:x}),c(L=>L.filter(M=>!a&&!Fe(M.url,!n)&&M.requestId!==x))},I=()=>{Ve.setItem(Ye.CODE_EXECUTION_DOMAIN_ALLOW_LIST,[...rt(),{origin:b,expiresAt:Date.now()+90*24*60*60*1e3}]),_(!0)};c(R=>[...R,{url:y,origin:b,requestId:x,approve:I,deny:()=>_(!1)}])}catch(b){me.addError(b),g({type:ve.FETCH_RESPONSE,isApproved:!1,requestId:x})}},[n,g,r,s,l,a]),[p,E]=at(),S=o.useCallback(async(y,x)=>{if(y.type===ue.SW_NOT_SUPPORTED)Z.count(Q.WEB_SANDBOX,"sw_not_supported"),p.resolve?.();else{f.current=x[0],u.current=x[1],u.current.onmessage=b=>{b.data.type==="ready"?p.resolve?.():h(b.data)};try{const{token:b}=await ce.safeGet("/public/code_execution_challenge",{authOption:Ct.Anonymous,parameters:{query:{relay_client_id:y.clientId}}});m({type:xs.SW_RECONNECT_RESPONSE,reconnectId:y.reconnectId,sessionId:e,token:b})}catch(b){me.addError(b)}}},[h,m,p,e]);return{relayRef:d,relayInitPromise:p,resetRelayInitPromise:E,handleMessageFromRelay:S,pendingFetchRequests:i}},Ms="https://persistent.oaistatic.com/canvas/loop-swirl.mp4",As="https://persistent.oaistatic.com/canvas/loop-swirl-poster.jpg",de=90,Os=({title:e,checkpoints:s,activeCheckpointId:n,isComplete:a,onTransitionComplete:r})=>{const[l,d]=o.useState(!1),f=s.findIndex(c=>c.id===n),u=s[f],i=()=>{r?.(),d(!0)};return t.jsx(O.div,{className:"relative flex h-full w-full items-center justify-center",transition:{type:"spring",bounce:0},children:t.jsxs(O.div,{className:"flex -translate-y-12 flex-col items-center gap-3",style:{minWidth:de,height:de},initial:{opacity:0},animate:{opacity:1},transition:{type:"spring",duration:.5,bounce:0},children:[t.jsxs(O.div,{className:"bg-token-main-surface-primary absolute overflow-hidden rounded-3xl shadow-2xl",initial:!1,animate:{width:de,height:de,opacity:l?0:1},transition:{type:"spring",duration:.56,bounce:0},children:[t.jsx("video",{muted:!0,loop:!0,autoPlay:!0,playsInline:!0,src:Ms,poster:As,className:P("absolute inset-0 z-0 h-full w-full object-cover transition-opacity duration-200")}),t.jsx("div",{className:P("relative z-10 flex h-full w-full items-center justify-center",l?"opacity-0":"opacity-100"),children:t.jsx(nt,{color:"light",checkpoints:s,activeCheckpointId:n,isComplete:a,onTransitionComplete:i,thickness:1/12})})]}),t.jsxs(O.div,{className:P("flex flex-col items-center transition-opacity duration-200",a?"opacity-0":"opacity-100"),style:{translateY:de+20},children:[t.jsx("span",{className:"text-token-text-primary font-semibold",children:e}),u&&t.jsx(O.span,{className:"text-token-text-secondary flex items-baseline",children:t.jsx("span",{className:"loading-shimmer",children:u.label})})]})]})})},Ue=({sessionId:e})=>"?"+[`sessionId=${e}`,""].filter(Boolean).join("&"),$e=[{id:J.INITIALIZING,label:"Initializing environment",estimatedTime:1e3},{id:J.INSTALLING_PACKAGES,label:"Installing packages",estimatedTime:2e3},{id:J.RUNNING_CODE,label:"Ready",estimatedTime:1}],Is=()=>Ot()?"ios":It()?"windows":Lt()?"android":Dt()?"safari":Pt()||Bt()?"chrome":"unknown",Ls=({isShare:e=!1,disableNetworkRequests:s=!1,unsafeAllowAllNetworkRequests:n=!1,networkAccessDeniedMessage:a,visuallyHidden:r=!1,isCodeUpdating:l=!1,enableTransition:d=!1,disablePermissions:f=!1,title:u,onChangeBackgroundColor:i},c)=>{const[m,g]=o.useState(0),[h]=o.useState(()=>crypto.randomUUID()),{pendingFetchRequests:p,handleMessageFromRelay:E,relayInitPromise:S,resetRelayInitPromise:y,relayRef:x}=_s({sessionId:h,disableNetworkRequests:s,networkAccessDeniedMessage:a,unsafeAllowAllNetworkRequests:n}),b=o.useRef(null),[_,I]=at(),R=o.useMemo(()=>Promise.all([_.promise,S.promise]),[_,S]),[L,M]=o.useState(null),[q,G]=o.useState(!1),V=o.useRef(null),H=o.useRef(new Map),U=o.useRef(null),C=o.useCallback(v=>{V.current?.postMessage(v)},[]),k=o.useCallback(()=>{const v=H.current.keys();M(null),G(!1),i?.(null);for(const j of v)C({type:Ee.STOP_CODE,runId:j});U.current=null},[C,i]),se=o.useCallback(()=>{y(),I(),g(v=>v+1),M(null),G(!1),U.current=null},[y,I]),B=o.useCallback(async function*({code:v,language:j}){if(M(J.INITIALIZING),Z.count(Q.WEB_SANDBOX,`${j}.eval`),await R,H.current.size!==0)return k();const D=vt(),A=new _t;H.current.set(D,A);const K={code:v,language:j,type:Ee.RUN_CODE,runId:D};U.current={runId:D,language:j},C(K);for await(const F of ks(A))F&&F.type===N.ENVIRONMENT_STATUS&&(M(F.status),d||G(F.status===J.RUNNING_CODE)),F?.type===N.ERROR?Z.count(Q.WEB_SANDBOX,`${j}.error`):F?.type===N.RUN_COMPLETE&&F.wasFatalError&&Z.count(Q.WEB_SANDBOX,`${j}.fatal_runtime_error`),F&&!Ke([N.READY],F.type)&&(yield F);M(null),G(!1),H.current.delete(D)},[R,d,C,k]),z=o.useCallback(async v=>{await R,C({type:Ee.PREPARE_ENVIRONMENT,language:v})},[R,C]),Y=v=>{U.current&&C({type:Ee.RUN_CODE,code:v,...U.current})};o.useImperativeHandle(c,()=>({stop:k,evalAsync:B,updateCode:Y,prepareEnvironment:z})),o.useEffect(()=>Mt(window,{message:v=>{const{data:j,ports:D}=v,{type:A}=j,K=v.source===x.current?.contentWindow,F=v.source===b.current?.contentWindow;if(!K&&!F)return;if(A===N.ENVIRONMENT_ERROR)return me.addError("Code execution environment error",j.error),j.error.name==="ServiceWorker"&&Z.count(Q.WEB_SANDBOX,"service_worker_connection_failure",[{key:"agent",value:Is()},{key:"is_share",value:String(e)}]),j.runId!=null&&j.runId===U.current?.runId&&Z.count(Q.WEB_SANDBOX,`${U.current.language}.environment_error`),se();if(K&&(j.type===ue.SW_NOT_SUPPORTED||j.type===ue.SW_RECONNECT))return E(j,D);if(K||!F||A===ue.SW_RECONNECT||A===ue.SW_NOT_SUPPORTED)return;if(V.current=D[0],A===N.READY)return _.resolve?.();if(A===N.SET_BACKGROUND_COLOR)return i?.(j.backgroundColor);if(A===N.INSTRUMENT)return Ts(j);const{runId:$}=j,ne=$&&H.current.get($);ne?ne.emit("message",j):me.addError("Code execution error: missing event emitter",{messageData:v.data})}}),[i,se,E,S,x,_,h,e]);const ee={type:"spring",duration:q&&d?.56:0,delay:q?.12:0,bounce:0},w=f?"":"midi";return t.jsxs(At,{children:[t.jsx("iframe",{title:"relay","aria-hidden":"true",className:"fixed h-0 w-0",allow:w,ref:x,src:`${Pe}/relay.html${Ue({sessionId:h})}`},`relay-${m}`),t.jsxs("div",{className:P("relative flex",r?"fixed h-0 w-0":"h-full w-full"),children:[!r&&L!=null&&d&&t.jsx(Os,{isComplete:L===J.RUNNING_CODE,onTransitionComplete:()=>G(!0),activeCheckpointId:L,title:u,checkpoints:$e}),t.jsx(O.div,{className:P("bg-token-main-surface-primary absolute inset-0 m-auto origin-center overflow-hidden",q?"pointer-events-auto":"pointer-events-none"),animate:{opacity:q?1:0,...q?{scale:1}:{scale:.95}},transition:ee,children:t.jsx(O.iframe,{title:u,className:"h-full w-full overflow-hidden",transition:ee,"aria-hidden":r?"true":void 0,allow:w,src:`${Pe}/index.html${Ue({sessionId:h})}`,sandbox:"allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms",ref:b,tabIndex:-1},`sandbox-${m}`)}),q&&t.jsx(Rs,{isIndeterminate:l,isComplete:L===J.RUNNING_CODE,activeCheckpointId:L,checkpoints:$e})]}),p.length>0&&t.jsx(Cs,{title:u,requests:p})]})},$n=o.forwardRef(Ls),Ds=({onClose:e,title:s,actions:n,showBorder:a=!1})=>t.jsxs("div",{className:P("bg-token-main-surface-primary flex items-center justify-between border-b py-2 ps-2 pe-2.5",{"border-token-border-xlight":a,"border-transparent":!a}),children:[t.jsx("div",{className:"text-token-text-primary flex items-center gap-2 ps-4 text-sm select-none",children:s}),t.jsxs("div",{className:"flex items-center gap-2",children:[n.map(({tooltip:r,icon:l,onClick:d},f)=>{const u=t.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",icon:l,onClick:d},f);return r?t.jsx(be,{label:r,children:u},f):u}),t.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",onClick:e,icon:Ae})]})]}),Ps=({onDrag:e,onDragEnd:s,onDoubleClick:n})=>t.jsx(O.div,{drag:"y",className:"bg-token-text-quaternary absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(a,r)=>{e?.(r)},onDragEnd:s,onDoubleClick:n}),Bs=({textdocTitle:e,onClickViewConsole:s,onClickFix:n,onDismiss:a})=>t.jsxs(O.div,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"border-token-border-default bg-token-main-surface-primary absolute end-2 bottom-2 flex w-fit max-w-80 flex-col gap-4 rounded-xl border px-4 py-4 shadow-xl",children:[t.jsxs("div",{className:"flex items-start",children:[t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{className:"text-sm font-semibold",children:t.jsx(T,{id:"ObCQBq",defaultMessage:"Cannot preview your code"})}),t.jsx("div",{className:"text-sm",children:t.jsx(T,{id:"3ZeoP8",defaultMessage:"An error occured while trying to run {name}",values:{name:e}})})]}),t.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-tertiary -m-1! aspect-square p-0!",onClick:a,icon:Ae})]}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(re,{size:"small",color:"secondary",onClick:s,children:t.jsx(T,{id:"Fch32I",defaultMessage:"View console"})}),t.jsx(re,{size:"small",color:"primary",onClick:n,children:t.jsx(T,{id:"HRfYX0",defaultMessage:"Fix bug"})})]})]}),ot=(e,{name:s,message:n,line:a,stack:r})=>{const l=a!=null?`

Error occured in:
${e.split(`
`).slice(a-1,a+1).join(`
`)}`:"";return`${s}: ${n}

Stack:
${r.join("")}${l}`},Te=new Es({capacity:5}),Fs=async(e,s,n)=>{const a=ot(s,n.error),r=Me(Te.get(a));if(Te.get(a))return r;const{hint:l}=await ce.safePost("/textdoc/{textdoc_id}/code/hint",{parameters:{path:{textdoc_id:e}},requestBody:{error:a,line:n.error.line??-1}});return Te.set(a,l),l},it=e=>Ke([N.ERROR,N.LOG,N.OUTPUT],e.type),lt=e=>e.type===N.OUTPUT&&ct(e.output),ct=e=>typeof e=="string"&&e.startsWith("data:image/png;"),fe=({as:e="li",contentBefore:s,contentAfter:n,disableEntryAnimation:a=!1,hasHint:r=!1,bottomBorder:l=!1,isHintOpen:d=!1,isSticky:f=!1,onClick:u,children:i})=>{const c=!!u,m=e==="div"?O.div:O.li;return t.jsxs(m,{initial:a?!1:{opacity:0},animate:{opacity:1},transition:{duration:.32},role:c?"button":void 0,className:P("bg-token-main-surface-primary flex items-start justify-between py-1.5 ps-6 pe-4 font-mono text-sm whitespace-pre",l&&"border-token-border-xlight border-b",f&&"sticky top-0 z-10",c&&"cursor-pointer",c&&r&&"hover:bg-red-500/10",c&&!r&&"hover:bg-gray-50 dark:hover:bg-gray-700",r&&d&&"bg-red-500/10"),onClick:c?u:void 0,children:[s&&t.jsx("div",{className:"me-3 flex h-6 w-5 items-start",children:s}),t.jsx("div",{className:"flex min-h-6 min-w-0 flex-1 items-start justify-start gap-2 leading-6",children:i}),n&&t.jsx("div",{className:"ms-3 flex min-h-6 items-start leading-6",children:n})]})};var te=(e=>(e.LOADING="loading",e.READY="ready",e.RESOLVED="resolved",e))(te||{});const dt=({hint:e,onClickFix:s,isOpen:n,onOpenChange:a})=>{const r=o.useRef(null),l=oe();return e?t.jsx("div",{className:"relative flex items-center font-sans",onClick:d=>d.stopPropagation(),children:t.jsxs(ts,{open:n,onOpenChange:a,children:[t.jsx(ss,{asChild:!0,ref:r,children:e.status==="resolved"?t.jsx("div",{className:"flex h-5 w-5 items-center",children:t.jsx(ns,{className:"text-token-text-tertiary",size:16})}):t.jsx("button",{className:"h-5 w-5",disabled:e.status==="loading",children:e.status==="loading"?t.jsx(ys,{}):t.jsx(bs,{position:"static",isError:!0,count:1,offsetY:0})})}),t.jsx(ge,{children:n&&t.jsx(as,{forceMount:!0,container:r.current?.ownerDocument.body,children:t.jsx(rs,{side:"top",align:"start",alignOffset:-4,sideOffset:10,children:t.jsx(vs,{position:"static",translateY:0,right:0,isFocused:!0,onDismiss:()=>a?.(!1),onAccept:d=>{a?.(!1),s?.(d)},comment:e,acceptButtonLabel:l.formatMessage({id:"Dl9vBh",defaultMessage:"Fix bug"})})})})})]})}):t.jsx("div",{className:"w-5"})},Us="module:",ke=({log:e,isDisabled:s=!1,onClick:n})=>t.jsx("div",{className:"flex items-center",children:"line"in e&&e.line!=null&&t.jsxs("button",{onClick:()=>e.line!=null&&n?.(e.line),className:"text-token-text-tertiary select-none enabled:hover:underline",disabled:s,children:[Us,e.line]})}),$s=({isPreview:e=!1,log:s,level:n})=>t.jsxs("span",{className:P("text-token-text-primary flex min-w-0 flex-wrap gap-1",e?"shrink truncate":"whitespace-pre-wrap",n==="warn"&&"text-yellow-600"),children:[n==="warn"&&"[warn]: ",typeof s=="string"?s:s.map((a,r)=>t.jsx(gs,{isPreview:e,value:a},r))]}),ut=({error:e,isPreview:s=!1,isResolved:n=!1})=>{const a=e.name+":";return t.jsxs("span",{className:P("whitespace-pre-wrap",n?"text-token-text-primary":"text-red-500"),children:[t.jsx("span",{className:"font-semibold",children:a})," ",e.message,t.jsx("div",{children:e.stack.length>0&&!s?e.stack.join(`
`):""})]})},Hs=({output:e,isPreview:s=!1})=>{const n=oe();return e==null?null:ct(e)?t.jsx("img",{alt:n.formatMessage(qs.imgAlt),className:P(s&&"border-token-border-xlight h-6 rounded-lg border"),src:e}):t.jsx("span",{className:"flex items-center gap-2",children:Me(e)})},Ie=({log:e,isHintResolved:s,isPreview:n=!1})=>{switch(e.type){case N.LOG:return t.jsx($s,{isPreview:n,...e});case N.ERROR:return t.jsx(ut,{isPreview:n,isResolved:s,...e});case N.OUTPUT:return t.jsx(Hs,{isPreview:n,...e});default:return null}},Ws=({log:e,isStale:s=!1,onClickFix:n,onClickLineNumber:a,hint:r})=>{const[l,d]=o.useState(!1);if(e.type===N.RUN_COMPLETE)return null;const f=r?.status===te.RESOLVED,u=e.type===N.ERROR&&r?.status===te.READY;return t.jsx(fe,{hasHint:u,isHintOpen:l,bottomBorder:!0,onClick:r&&!f&&(()=>d(!0)),contentBefore:t.jsx(dt,{hint:r,isOpen:l,onOpenChange:d,onClickFix:i=>e.type===N.ERROR&&r&&n?.(i,r.id,e.error)}),contentAfter:t.jsx(ke,{log:e,isDisabled:s,onClick:a}),children:t.jsx(Ie,{log:e,isHintResolved:f})})},qs=ye({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),Gs=({timestamp:e,duration:s})=>{const[,n]=o.useState(0);o.useEffect(()=>{setInterval(()=>{n(l=>l+1)},5e3)},[]);const a=Date.now(),r=Math.round((a-e)/1e3);return t.jsx(be,{label:t.jsx(T,{id:"bFO21A",defaultMessage:"Code ran {count, plural, =0 {instantly} one {in # second} other {in # seconds}}",values:{count:Math.floor(s/1e3)}}),children:t.jsx("span",{className:"text-token-text-tertiary",children:r>=60?t.jsx(Et,{value:-r,updateIntervalInSeconds:60,numeric:"auto"}):t.jsx(T,{id:"bRCEFN",defaultMessage:"Just now"})})})},ft=({isComplete:e,timestamp:s,duration:n})=>e&&s!=null&&n!=null?t.jsx(Gs,{timestamp:s,duration:n}):e&&n==null?t.jsx("span",{className:"text-token-text-tertiary",children:t.jsx(T,{id:"EMebM9",defaultMessage:"Stopped"})}):t.jsx(Oe,{gap:2}),zs=e=>{switch(e){case J.INITIALIZING:return t.jsx(T,{id:"J183Z0",defaultMessage:"initializing environment"});case J.INSTALLING_PACKAGES:return t.jsx(T,{id:"21sQ8o",defaultMessage:"installing packages"});case J.RUNNING_CODE:return t.jsx(T,{id:"nHITHk",defaultMessage:"running code"})}},je=({message:e,isComplete:s,statusLogs:n})=>{const a=Re(n);return t.jsxs("span",{className:"flex items-center",children:[t.jsx("span",{className:"text-token-text-secondary font-semibold",children:t.jsx(T,{...e})}),!s&&a&&t.jsxs(O.span,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{delay:.3,duration:.1},className:"text-token-text-tertiary ms-2 flex items-baseline",children:[zs(a.status),t.jsx(Oe,{gap:2,size:2})]})]})},Xs=({children:e,firstLog:s,lastLog:n,isHintResolved:a,duration:r,isComplete:l=!1,isLast:d=!1,statusLogs:f})=>{const[u,i]=o.useState(!0),[c,m]=o.useState(!1),g=o.useRef(null),h=()=>{i(!u)};return o.useEffect(()=>{const{current:p}=g;if(!p)return;const E=new IntersectionObserver(S=>{S[0].intersectionRatio===0?m(!0):m(!1)},{threshold:0});return E.observe(p),()=>E.unobserve(p)},[]),t.jsxs("li",{className:"relative flex flex-col",children:[t.jsx("div",{"aria-hidden":"true",className:"pointer-events-none absolute h-[1px] bg-transparent",ref:g}),t.jsxs(fe,{as:"div",disableEntryAnimation:!0,isSticky:!0,bottomBorder:c||!d&&!u,contentAfter:t.jsx(ft,{isComplete:l,duration:r,timestamp:s?.timestamp}),contentBefore:t.jsx("button",{className:"text-token-text-tertiary",onClick:()=>h(),children:t.jsx(os,{className:P("icon transition-transform",u&&"rotate-90")})}),onClick:()=>h(),children:[t.jsx(je,{isComplete:l,message:Ne.run,statusLogs:f}),!u&&n&&t.jsx(Ie,{isPreview:!0,isHintResolved:a,log:n})]}),u&&e]})},Vs=({runMessages:e,onClickFix:s,onClickLineNumber:n,hints:a,isStale:r,isLast:l,includeContentBefore:d=!1})=>{const[f,u]=o.useState(!1),i=e.filter(x=>x.type===N.ENVIRONMENT_STATUS),c=e.filter(it),m=Re(e),g=m?.type===N.RUN_COMPLETE,h=g?m.duration:null,p=c[0];if(g){if(c.length===0)return t.jsx(fe,{isHintOpen:f,bottomBorder:!0,contentBefore:d,contentAfter:t.jsx(ft,{isComplete:g,duration:h,timestamp:p?.timestamp}),children:t.jsx(je,{isComplete:g,message:Ne.success,statusLogs:i})});if(c.length===1&&p?.type===N.ERROR){const x=a.get(p.id);return t.jsxs(fe,{hasHint:!!x,isHintOpen:f,bottomBorder:!0,contentBefore:(d||!!x)&&t.jsx(dt,{hint:x,isOpen:f,onOpenChange:u,onClickFix:b=>s?.(b,p.id,p.error)}),contentAfter:t.jsx(ke,{log:p,isDisabled:r,onClick:n}),onClick:x&&x.status!==te.RESOLVED&&(()=>u(!0)),children:[t.jsx(je,{isComplete:g,message:Ne.run,statusLogs:i}),t.jsx(ut,{isResolved:x?.status===te.RESOLVED,...p})]})}else if(c.length===1&&p&&!lt(c[0]))return t.jsxs(fe,{bottomBorder:!0,contentBefore:d,contentAfter:t.jsx(ke,{log:p,isDisabled:r,onClick:n}),children:[t.jsx(je,{isComplete:g,message:Ne.run,statusLogs:i}),t.jsx(Ie,{log:p})]})}const E=Re(c.filter(x=>x.type!==N.RUN_COMPLETE)),y=(E&&a.get(E.id))?.status===te.RESOLVED;return t.jsx(Xs,{statusLogs:i,firstLog:p??null,lastLog:E??null,duration:h,isComplete:g,isHintResolved:y,isLast:l,children:t.jsx("ol",{children:c.map(x=>t.jsx(Ws,{log:x,isStale:r,onClickLineNumber:n,onClickFix:s,hint:a.get(x.id)},x.id))})})},Ne=ye({success:{id:"laZI5H",defaultMessage:"Run successfully"},run:{id:"o7dgBT",defaultMessage:"Run"}}),Ys=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,Ks=(e,s,n)=>{const a=ot(e,n);return`
${Ys}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

${s?`# Hint

${s}

`:""}
# Error

${a}`.trim()},Zs=({codeRunMessages:e,scrollRef:s,onClose:n,onClickLineNumber:a,onClickFix:r,title:l,headerActions:d,lastRunId:f,hints:u})=>{const i=u.size>0,c=o.useMemo(()=>Object.entries(Ut(e,"runId")),[e]),m=c.some(([,g])=>{const h=g.filter(it);return h.length>1||h.length===1&&lt(h[0])});return t.jsxs(t.Fragment,{children:[t.jsx(Ds,{title:l,actions:d,onClose:n,showBorder:e.length>0}),t.jsx("div",{ref:s,className:"bg-token-main-surface-primary flex flex-1 flex-col-reverse overflow-auto",children:t.jsx("ol",{className:"flex flex-1 flex-col justify-start pb-4",children:t.jsx(ge,{children:c.map(([g,h],p)=>t.jsx(Vs,{runMessages:h,includeContentBefore:m||i,onClickFix:r,onClickLineNumber:a,hints:u,isStale:g!==f,isLast:p===c.length-1},g))})})})]})},Qs=({sandboxRef:e,textdocContent:s,textdocTitle:n,textdocId:a,isOpen:r,isTextdocAttachedPending:l,headerActions:d=[],highlightLine:f,createTextdocTurn:u,onOpenChange:i},c)=>{const[m,g]=o.useState(!1),[h,p]=o.useState(!1),[E,S]=o.useState([]),[y,x]=o.useState(0),[b,_]=o.useState(null),[I,R]=o.useState(null),[L,M]=o.useState(()=>new Map),[q,G]=o.useState(320),V=o.useRef(null),H=oe();o.useEffect(()=>R(null),[s]);const U=E.filter(w=>[N.LOG,N.ERROR,N.OUTPUT].includes(w.type)).length;o.useEffect(()=>{r&&x(U)},[r]);const C=o.useMemo(()=>{for(let w=E.length-1;w>=0;w--){const v=E[w];if(v.runId!==I)return null;if(v.type===N.ERROR)return v}return null},[E,I]),k=(w,v,j)=>{const D=L.get(v);if(D){const{id:A,content:K}=D;M(F=>{const $=new Map(F);return $.set(A,{id:A,content:K,status:te.RESOLVED}),$})}_(v),u({sourceEvent:w,action:ie.EDIT,userMessageType:W.CONSOLE,content:Ks(s,D?.content??null,j)})},se=async(w,v)=>{if(!l){M(j=>{const D=new Map(j);return D.set(w,{id:w,status:te.LOADING,content:""}),D});try{const j=await Fs(a,s,v);M(D=>{const A=new Map(D);return A.set(w,{id:w,status:te.READY,content:j}),A})}catch{M(D=>{const A=new Map(D);return A.delete(w),A})}}},B=async(w,v)=>{const j=fs(w,v),D=ms(w,v),A=ps(w);if(!j||!A&&!D)return;A&&i?.(!0),p(!0),S($=>$.map(ne=>({...ne,isStale:!0})));let K=!1;const F=Ft(e.current).evalAsync({code:v,language:j});for await(const $ of F){if($.type===N.RUN_START&&requestAnimationFrame(()=>{V.current?.scrollTo({top:0,behavior:"smooth"})}),$.type===N.ERROR){if($.line!=null){const{line:ne}=$;requestAnimationFrame(()=>f(ne))}K=!0,se($.id,$)}R($.runId),S(ne=>[...ne,{...$,isStale:!1}])}K&&i?.(!0),p(!1)};o.useImperativeHandle(c,()=>({runCode:B,stopCode:()=>e.current?.stop()}));const z=!r&&h,Y=z&&C&&C.id!==b,ee=!Y&&z&&U>y;return t.jsxs(ge,{children:[m&&t.jsx("div",{className:"pointer-events-auto absolute inset-0 bg-transparent"},"drag-overlay"),ee&&t.jsx(O.button,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"bg-token-main-surface-primary hover:bg-token-main-surface-secondary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",onClick:()=>i?.(!0),children:t.jsxs("span",{className:"text-token-text-secondary flex items-center gap-1 text-sm",children:[t.jsx(is,{className:"icon-sm"}),t.jsx(T,{id:"etzFTa",defaultMessage:"{numLogs, plural, one {{numLogs} message} other {{numLogs} messages}}",values:{numLogs:U}})]})},"view-console"),Y&&t.jsx(Bs,{textdocTitle:n,onClickViewConsole:()=>i?.(!0),onDismiss:()=>_(C.id),onClickFix:w=>{k(w,C.id,C.error)}},"error-modal"),r&&t.jsxs(O.div,{initial:{translateY:"100%",opacity:0},animate:{translateY:"0%",opacity:1},exit:{translateY:"100%",opacity:0},transition:{type:"spring",bounce:0,duration:.48},className:"border-token-border-default relative z-10 w-full border-t shadow-[0px_0px_32px_rgba(0,0,0,0.08)]",children:[t.jsx(Ps,{onDragEnd:()=>g(!1),onDrag:({delta:{y:w}})=>{g(!0),G(v=>v-w)}}),t.jsx("div",{className:"flex flex-col",style:{height:q},children:t.jsx(Zs,{scrollRef:V,codeRunMessages:E,onClose:()=>i?.(!1),onClickLineNumber:f,onClickFix:k,title:H.formatMessage({id:"P9VJDk",defaultMessage:"Console"}),headerActions:[...d,{tooltip:H.formatMessage({id:"gAICYK",defaultMessage:"Clear console"}),icon:ls,onClick:()=>{x(0),S([]),M(new Map)}}],lastRunId:I,hints:L})})]},"console")]})},Hn=o.forwardRef(Qs);function Wn({isDisabled:e=!1,isCodePreviewable:s=!1,isCodeRunning:n,disabledTooltip:a,clientThreadId:r,onClick:l}){const[d,f]=o.useState(n),[{width:u},i]=et();o.useEffect(()=>{let p=null;return!n||s?f(n):(p=setTimeout(()=>{f(n)},200),()=>clearTimeout(p))},[n,s]);const c=()=>({conversation_id:r?Ht(r):void 0}),m=()=>{$t.logEventWithStatsig("Canvas Run Code Button Clicked","chatgpt_canvas_run_code_button_clicked",c()),setTimeout(()=>l?.())},g=t.jsx(O.button,{disabled:e||n&&!d,onClick:m,className:P("btn rounded-full border transition-colors",d?P(Ss,"border-transparent"):"border-token-border-default hover:bg-token-surface-hover bg-transparent"),animate:{width:u??0},initial:{width:u??0},transition:{type:"spring",bounce:.24,duration:.4},children:t.jsx("div",{ref:i,children:d?t.jsxs(O.div,{className:"flex items-center gap-2 px-3 sm:px-4",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[t.jsx(ws,{className:"icon"}),t.jsx("span",{className:"hidden sm:inline",children:t.jsx(T,{...Se.stopCode})})]}):t.jsxs(O.div,{className:"flex items-center gap-2 px-3 sm:px-4",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[t.jsx(cs,{className:"icon"}),t.jsx("span",{className:"hidden whitespace-nowrap sm:inline",children:t.jsx(T,{...Se.runCode})})]})})}),h=e&&a?a:n?null:t.jsx(T,{...s?Se.previewCodeTooltip:Se.runCodeTooltip});return h?t.jsx(be,{label:h,children:g}):g}const Se=ye({runCode:{id:"37troW",defaultMessage:"Run code"},stopCode:{id:"nCwG4+",defaultMessage:"Stop"},runCodeTooltip:{id:"UeNB/S",defaultMessage:"See output and debug"},previewCodeTooltip:{id:"xAotrE",defaultMessage:"Run your code in canvas"}}),Js=/\s/,en=30;function He(e,s){const n=e.indexOf(s);return n===-1?!1:e.indexOf(s,n+s.length)===-1}function ae(e,s){return Js.test(e[s])}function We(e,s,n=!1){if(s===0||n&&ae(e,s-1))return s;for(;s>0&&ae(e,s-1);)s--;for(;s>0&&!ae(e,s-1);)s--;return ae(e,s)&&s++,s}function qe(e,s,n=!1){if(s===e.length||n&&ae(e,s))return s;for(;s<e.length&&ae(e,s);)s++;for(;s<e.length&&!ae(e,s);)s++;return ae(e,s-1)&&s--,s}function tn(e,s,n=!0,a=en){if(e.start<0||e.end>s.length||e.start>e.end)throw new Error("Invalid commentSourceRange provided.");const r=s.substring(e.start,e.end);let l=e.start,d=e.end;n&&(l=We(s,l,!0),d=qe(s,d,!0));let f=s.substring(l,e.start),u=s.substring(e.end,d),i=`${f}${r}${u}`;if(He(s,i)&&(a==null||i.length>=a))return{before:f,after:u,allSurrounding:i};let c=l,m=d,g=!0;for(;g&&(a==null||i.length<a);){let h=!1;const p=c>0?We(s,c):c;p<c&&(c=p,h=!0);const E=m<s.length?qe(s,m):m;if(E>m&&(m=E,h=!0),h){const S=s.substring(c,e.start),y=s.substring(e.end,m),x=`${S}${r}${y}`;if(He(s,x)&&(a==null||x.length>=a))return{before:S,after:y,allSurrounding:x};f=S,u=y,i=x}else g=!1}return{before:f,after:u,allSurrounding:i}}const pe="# Context",xe="# Instructions";function he(e,s,n){if(s==null||n==null)return`The user is referring to the entire text of "${e}".`;const a=`
## Selected Text
The user has selected this text in "${e}" in particular:
${s}
`.trim();return n.allSurrounding===s?a:`
${a}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function mt(e,s){return e==null||s==null?"entire document":e===s.allSurrounding?"selected text":"surrounding context"}function pt(e){return`For the update pattern, create a regex which exactly matches the ${e}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${e}. The only exception to this rule is if the ${e} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function sn(e,s,n,a){if(!Qe(s)&&n&&a){const r=mt(n,a);return`
${pe}
The user requests that you directly edit the document.

${he(e,n,a)}

${xe}
Use the update_textdoc tool to make this edit. ${pt(r)}`.trim()}return`
${pe}
The user requests that you directly edit the document.

${he(e,n,a)}

${xe}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function nn(e,s,n){return`
${pe}
The user requests that you add comments about some text.

${he(e,s,n)}

${xe}
Do not respond to the user's question directly, just leave comments.`.trim()}function an(e,s){return Qe(e)?s==="entire document"?` If you choose to update the ${s}, you MUST fully rewrite the ${s} by using ".*" as the update regex pattern.`:` If you choose to update the ${s}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${s} and rewrite other sections exactly as is, except for parts that must change based on this update`:s==="entire document"?"":` If you choose to update the ${s}, follow these instructions: ${pt(s)}`}function rn(e,s,n,a){const r=mt(n,a),l=an(s,r);return`
${pe}
${he(e,n,a)}

${xe}
The user would like you perform one of the following actions:
- Update the ${r} via the \`update_textdoc\` tool.${l}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${r} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function on(e,s,n){return`
${pe}
${he(e,s,n)}

${xe}
The user would like you to create a new textdoc.
`.trim()}function ln(e,s,n,a=null,r=null){switch(n){case ie.ASK:return rn(e,s,a,r);case ie.CREATE_TEXTDOC:return on(e,a,r);case ie.EDIT:return sn(e,s,a,r);case ie.COMMENT:return nn(e,a,r)}}function cn(e){switch(e){case W.ACCELERATOR:case W.CONSOLE:case W.ACCEPT_COMMENT:case W.HIVE_SPEAKER_EDIT:return!0;case W.ASK_CHATGPT:case W.FULL_SCREEN_SUBMIT:return!1}}function dn(e,s){switch(s){case W.ASK_CHATGPT:case W.ACCEPT_COMMENT:case W.FULL_SCREEN_SUBMIT:return e.formatMessage(fn.askChatGPT);case W.ACCELERATOR:case W.CONSOLE:case W.HIVE_SPEAKER_EDIT:return}}const un=(e,s)=>{const n=oe(),a=ds(e),r=us(e),l=Wt();return o.useCallback(async({content:d,sourceRange:f,action:u,userMessageType:i,acceleratorMetadata:c,selectionMetadata:m,sourceEvent:g})=>{if(s?.versionInt==null||l)return;const{textdocId:h,type:p,versionInt:E,content:S}=s;let y,x=null;f&&f.start!==f.end&&(y=S.slice(f.start,f.end),x=tn(f,S));const b=ln(h,p,u,y,x),I=qt(b,{exclude_after_next_user_message:!0});r({sourceEvent:g,promptMessage:Gt(d,{canvas:{textdoc_id:h,textdoc_type:p,version:E,textdoc_content_length:S.length,user_message_type:i,accelerator_metadata:c,selection_metadata:m},is_visually_hidden_from_conversation:cn(i),targeted_reply:y,targeted_reply_label:dn(n,i),open_in_canvas_view:{type:"canvas_textdoc",id:h}}),completionMetadata:a?{conversationMode:a}:void 0,appendMessages:[I]})},[s,l,r,a,n])},fn=ye({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}}),mn=(e,s,n=1)=>{St(e.scrollTop,s,{duration:n,ease:"easeInOut",onUpdate:a=>{e.scrollTop=a}})},xt=X.div`flex w-full grow flex-col gap-1 rounded-xl p-2 pe-5 text-sm`,pn=X.input`ms-[-2px] w-auto rounded-none border-none bg-[#E5F3FF] p-0 px-0.5 text-sm font-semibold outline-none focus:outline-none`,xn=X(O.span)`start border-token-text-tertiary absolute -bottom-0.5 w-full origin-left border-b border-solid`,hn=X(O.span)`start border-token-text-tertiary absolute -bottom-0.5 w-full border-b border-dashed`,we=X.div`w-full loading-results-shimmer bg-token-bg-secondary h-2 rounded-full`,gn=()=>t.jsxs(xt,{className:"gap-2",children:[" ",t.jsx(we,{className:"w-[48px]"})," ",t.jsx(we,{})," ",t.jsx(we,{})," ",t.jsx(we,{className:"w-1/2"})]}),yn={initial:{scaleX:0,opacity:1},animate:{scaleX:1,opacity:0,transition:{scaleX:{duration:.85,ease:[.65,0,.35,1]},opacity:{delay:.85,duration:.1}}}},bn={initial:{opacity:0},animate:{opacity:1,transition:{delay:.85,duration:.1}}};X.div`ms-2 rounded-full px-2 py-0.5 text-xs font-medium`;const ht=({speakerId:e,content:s,range:n,filterDecision:a,isEditing:r,isSaving:l,containerRef:d,measuredTextContainerRef:f,isEditingEnabled:u})=>{const i=o.useRef(null),{setSpeakers:c,setEditingSpeaker:m,hoveringSpeakerId:g,setHoveringSpeakerId:h,speakers:p,editingSpeaker:E,enableDebugger:S}=Ce.getState(),y=Ce(k=>k.currentTime),x=n.max==null?y===n.min:y>=n.min&&y<=n.max;o.useEffect(()=>{if(x&&i.current&&d.current){const k=d.current,se=i.current,B=k.getBoundingClientRect().top,Y=se.getBoundingClientRect().top-B+k.scrollTop-20;mn(k,Y,.3)}},[n.min,n.max,x,d]);const b=p.get(e),_=!!b?.storedName&&b.storedName!==b?.placeholderName||(b?.isEdited??!1),I=b?.name??b?.storedName??b?.placeholderName??"Unidentified Speaker",R=o.useRef(null),L=e===E?.id,M=e===g,[q,G]=o.useState(!1),[V,H]=o.useState(!1);o.useEffect(()=>{R.current&&(!L||!V||(R.current?.focus(),_&&(R.current.value=I)))},[_,L,V,I]),zt(()=>{if(f?.current&&R.current){const k=f.current.offsetWidth;R.current.style.width=`${k}px`}},[E?.name]);const U=o.useCallback(()=>{if(!E||!b)return;m(null),H(!1),G(!1),h(null);const k=p.set(e,{...b,name:E.name?E.name:b.placeholderName,isEdited:!!E.name});c(k)},[E,b,m,h,p,e,c]),C=!r||l;return t.jsxs(xt,{ref:i,className:P(x&&"animate-[hive-log-fadeout_0.3s_1.5s_forwards] bg-blue-500/10",!1,!1),children:[!1,t.jsxs("div",{className:"mb-[1px] flex w-full items-center justify-between",children:[u&&(L?t.jsx(pn,{ref:R,disabled:!V,onBlur:U,className:P(!L&&"hidden w-0"),placeholder:b?.isEdited?void 0:b?.placeholderName,value:E?.name,onKeyDown:k=>{k.key==="Enter"&&U()},onChange:k=>m({id:e,name:k.target.value})}):t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs("div",{onClick:()=>{C||(m({id:e,name:_?I:""}),H(!0))},onMouseEnter:()=>{C||(h(e),G(!0))},onMouseLeave:()=>{C||(h(null),G(!1))},className:P("relative flex font-semibold transition-colors",{"text-blue-400!":M&&!C},{"cursor-pointer":!C},{"text-token-text-tertiary":!C&&!_}),children:[I,!C&&!_&&t.jsxs(t.Fragment,{children:[t.jsx(xn,{...yn}),t.jsx(hn,{...bn,className:P(M&&!C&&"border-blue-400!")})]})]}),q&&!C&&t.jsx(Je,{className:"h-4 w-4 text-blue-400"}),!1]})),t.jsx("div",{className:"text-xs text-[#5D5D5D]",children:js(n.min)})]}),t.jsx("div",{className:"flex",children:s})]})},vn=e=>_e({queryKey:["sharedHiveLog",e],queryFn:()=>ce.safeGet("/hive/textdoc/shared/{shared_textdoc_id}/transcript",{parameters:{path:{shared_textdoc_id:e}}}),select:tt}),En=e=>_e({queryKey:["hiveLog",e],queryFn:()=>ce.safeGet("/hive/{hive_id}/transcript",{parameters:{path:{hive_id:e}}}),enabled:!!e,select:tt}),Sn=()=>_e({queryKey:["hiveLogPrompts"],queryFn:()=>ce.safeGet("/hive/prompts"),enabled:!0}),wn=(e,s)=>ce.safePost("/hive/{hive_id}/speakers",{parameters:{path:{hive_id:e}},requestBody:{speakers:s}}),jn=X.div`invisible absolute start-0 top-0 rounded-md border px-0.5 text-sm font-semibold whitespace-pre`,Nn=(e,s)=>!s||!e?"":s.isEdited||e.name&&e.name!==s.placeholderName?e.name:s.placeholderName,gt=()=>t.jsx(Yt,{children:t.jsx(T,{...le.researchPreview})}),Cn=X.div`flex h-full w-full max-w-[360px] min-w-[240px] flex-col border-l border-gray-200`,Tn=X.div`flex w-full max-w-[360px] min-w-[240px] flex-col border-l border-gray-200`,Rn=X.div`bg-token-bg-primary mt-[0.5px] flex h-18 w-full items-center justify-between border-b-[0.5px] border-gray-200 p-4`,yt=X.div`flex h-full w-full flex-col gap-2 overflow-y-auto p-2`,Ge=X(O.div)`flex items-center gap-2`,ze={initial:{opacity:0,y:-4},animate:{opacity:1,y:0,transition:{duration:.2}},exit:{opacity:0,y:-4,transition:{duration:.2}}},qn="ts",Gn=({sharedTextDocId:e})=>{const s=vn(e),n=o.useRef(null),a=Xt(),{selectedFilters:r,isOpen:l,currentTime:d,closeSidebar:f}=Ce(),u=o.useMemo(()=>s.data?.filter(({filterDecision:m})=>!m||r?.includes(m)),[s.data,r]);if(s.isError)return null;const i=t.jsxs("div",{className:"text-token-text-secondary flex items-center gap-1.5 px-2 py-2 text-base font-medium md:px-0",children:[t.jsx(T,{...le.transcript}),t.jsx(gt,{})]}),c=t.jsxs(t.Fragment,{children:[s.isLoading&&Array.from({length:16}).map((m,g)=>t.jsx(gn,{},`loading-${g}`)),u?.map(m=>t.jsx(ht,{isEditingEnabled:!1,containerRef:n,...m},bt(m)))]});return!l||!d?null:a?t.jsxs(Tn,{children:[t.jsxs(Rn,{children:[i,t.jsx(Vt,{onClick:f})]}),t.jsx(yt,{ref:n,children:c})]}):t.jsx(Xe,{contentRef:n,testId:"modal-shared-canvas-transcript-modal",isOpen:l,title:i,contentClassName:"overflow-y-auto gap-2 p-2 flex flex-col",showCloseButton:!0,onClose:f,children:c})},zn=({hiveId:e,clientThreadId:s,ts:n,textdocVersion:a})=>{const r=En(e),l=Sn(),d=oe(),[f,u]=o.useState(!1),i=o.useRef(null),c=Kt(),m=Zt(c,"2986567482"),{isOpen:g,closeSidebar:h,openSidebar:p,setCurrentTime:E,speakers:S,setSpeakers:y,editingSpeaker:x,enableDebugger:b,setEnableDebugger:_,selectedFilters:I,setSelectedFilters:R}=Ce();o.useEffect(()=>{n!==void 0&&(p(),E(n))},[n,p,E]);const L=o.useRef(null),[M,q]=o.useState(!1),G=un(s,a);if(r.isLoading||l.isLoading||r.isError||l.isError||!r.data||!l.data)return null;const V=x?S.get(x.id):null,H=Array.from(S.values()).some(({isEdited:B})=>B),U=()=>{const B=new Map(Array.from(S.entries()).map(([z,Y])=>[z,{...Y,name:void 0,isEdited:!1}]));y(B),u(!1)},C=B=>{if(!l.data.speaker_edits)return;const z=l.data.speaker_edits.replace("{speakers}",JSON.stringify(Array.from(S.entries())));return G({sourceEvent:B,action:ie.EDIT,content:z,userMessageType:W.HIVE_SPEAKER_EDIT,selectionMetadata:void 0})},k=async B=>{if(H){q(!0);try{const z=[];Array.from(S.entries()).forEach(([w,v])=>{!v.isEdited||!v.name||z.push({id:w,updated_name:v.name})});const Y=await wn(e,z);if(!Y)throw new Error("Failed to update hive content");const ee=new Map(S);for(const w of Y.updated_speakers){if(!ee.has(w.id))continue;const v=ee.get(w.id);v&&ee.set(w.id,{...v,storedName:w.updated_name,isEdited:!1})}await C(B),y(ee),u(!1)}catch{}finally{q(!1)}}},se=r.data.filter(({filterDecision:B})=>!B||I?.includes(B));return t.jsxs(Cn,{className:P(g?"visible":"invisible hidden"),children:[t.jsxs("div",{className:"flex h-14 w-full items-center justify-between border-b border-gray-200 p-4",children:[t.jsxs("div",{className:"text-token-text-secondary group/debug flex items-center gap-1.5 py-2 text-base font-medium",children:[t.jsx(T,{...le[f?"edit":"transcript"]}),t.jsx(gt,{}),!1]}),t.jsx("div",{className:"flex h-10 items-center gap-2",children:t.jsx(ge,{mode:"wait",children:f?t.jsxs(Ge,{...ze,children:[t.jsx(re,{onClick:U,color:"secondary",disabled:M,children:t.jsx(T,{...le.cancelButton})}),t.jsx(re,{color:"primary",onClick:k,disabled:!H,loading:M,children:t.jsx(T,{...le.saveButton})})]},"edit-buttons"):t.jsxs(Ge,{...ze,children:[m&&t.jsx(be,{className:"h-10",label:d.formatMessage(le.editButtonTooltip),children:t.jsx(De,{icon:Je,onClick:()=>u(!0)})}),t.jsx(De,{icon:Ae,onClick:()=>h()})]},"non-edit-buttons")})})]}),!1,t.jsxs(yt,{ref:i,children:[m&&x&&t.jsx(jn,{ref:L,children:Nn(x,V)}),se.map(B=>t.jsx(ht,{isEditingEnabled:m,measuredTextContainerRef:L,containerRef:i,isEditing:f,isSaving:M,...B},bt(B)))]})]})},bt=e=>{const{speakerId:s,content:n,range:a}=e;return`${s}-${a.min}-${a.max}-${n.slice(0,2)}`},le=ye({researchPreview:{id:"HiveLogSidebar.researchPreview",defaultMessage:"Research Preview"},edit:{id:"HiveLogSidebar.edit",defaultMessage:"Edit"},transcript:{id:"HiveLogSidebar.transcript",defaultMessage:"Transcript"},editButtonTooltip:{id:"HiveLogSidebar.editButtonTooltip",defaultMessage:"Edit speakers"},cancelButton:{id:"HiveLogSidebar.cancelButton",defaultMessage:"Cancel"},saveButton:{id:"HiveLogSidebar.saveButton",defaultMessage:"Save"}});export{$n as C,qn as H,Gn as S,Wn as T,Hn as a,zn as b,un as u};
//# sourceMappingURL=mgu35bfjmjtg3slf.js.map
