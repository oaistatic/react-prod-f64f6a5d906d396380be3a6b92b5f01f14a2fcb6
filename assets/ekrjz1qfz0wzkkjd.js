const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/l10vl2ttbxxbazn4.js","assets/gg0tb34p9fzo1omt.js","assets/gt2c25hojvlnw6hf.js","assets/forbprkns1cohsbl.js","assets/g670b8vtkhx0yc6d.js","assets/root-ilxovqci.css","assets/conversation-small-mtta3ozz.css","assets/h6uvwty3c3amaxiz.js","assets/nir0q9e2l94u37hi.js","assets/cnl9n9geu2oxb8o4.js","assets/f4wsvwai0sxxe1lf.js","assets/hu61i4occl5w2buc.js","assets/iot1vlqga29hiiwl.js","assets/ansi-1f6vhsjh.css","assets/c7e30quc1do1jojv.js","assets/kv8a9039cr2p5scx.js","assets/ogvupmk4xezkmrqf.js","assets/juuj7s9t3x7u9it2.js","assets/lptwpbjabrvjmhsj.js","assets/kqivh2k2gjqolo2l.js","assets/ewqfcp1vbowm20lj.js","assets/fzrn137102spawew.js","assets/f36jz1b044mtoyky.js","assets/ii534sx9kl9dq5ip.js","assets/e3erq0emp0cqk1ou.js","assets/epts3f5f624a6l7w.js","assets/mu0w85wyyiji3bj8.js","assets/b40xa0ca5oqnzth6.js","assets/b451x40oixvdmzqh.js","assets/hsr6nqstg4abtqru.js","assets/k5ngqk6bkqja3f09.js","assets/jgs7169reknaons9.js","assets/wham-task-turn-grouping-iz0raby8.css","assets/eiffxi5640gvsu4t.js","assets/o68lxipd1oht2mfn.js","assets/jlkzv5bipqb1jti4.js","assets/h9p1albvmprbl3kb.js","assets/code-diff-krvv6lyt.css"])))=>i.map(i=>d[i]);
import{j as fe,W as q,h as Pe,w as Ce,l as ia,g as Ke,L as Te,u as oa,f as la,o as Ae,m as ca,M as Ve,c as da,B as ua}from"./nir0q9e2l94u37hi.js";import{r as c,j as e,M as k,h as De,b as G,m as ze,a as te,f as ma,u as he,A as fa,e as ha,g as pa}from"./gg0tb34p9fzo1omt.js";import{be as ga,bg as se,ch as re,j3 as xa,e6 as wa,d as pe,m as z,bU as Y,R as Le,ck as ge,cD as va,py as _a,dX as ba,dU as ya,c5 as Q,iw as ae,c6 as Ye,f9 as ka,bV as ja,bW as Ma,ic as Pa,cu as Ca,ad as Ta,lT as Sa,cO as Na}from"./g670b8vtkhx0yc6d.js";import{B as Da,b6 as La,bE as Se,t as Fa,i3 as Ra,i4 as Ba,mA as Ee,i6 as Ea,i7 as qa,v as _e,a4 as Ha,bv as qe,i$ as be,a3 as Ia,K as He,e as Oa,g7 as Ie,mF as Oe,py as Ua,pz as Wa,hH as Qa,f2 as Ga,bp as $a}from"./forbprkns1cohsbl.js";import{JsonViewer as Ka}from"./kqivh2k2gjqolo2l.js";import{T as Aa,a as Va,b as za}from"./jgs7169reknaons9.js";import{f as Ya,C as Ne,M as ye,p as Xa,W as Ja,b as Za,c as et}from"./h6uvwty3c3amaxiz.js";import{S as at}from"./isn1igquqvc1qe44.js";import{u as tt,W as st}from"./ii534sx9kl9dq5ip.js";import{W as rt}from"./lv749h5qyvjegoog.js";import{S as nt}from"./ns3o7cu7dtun5l1w.js";import{W as Ue}from"./e3erq0emp0cqk1ou.js";import{N as it}from"./ds557awgotgdm7n4.js";import{s as me,B as ot}from"./ob8dna56sqm37byd.js";import{s as ke}from"./epts3f5f624a6l7w.js";import{u as lt}from"./go2lz3yja1ixfdzl.js";function zt({taskId:a,task:r,currentDiffTaskTurn:t,currentUserTurn:s,currentAssistantTurn:n}){const i=fe(w=>w.addTurnToTaskMap),l=fe(w=>w.getTurnsForTask),[d,o]=c.useState(t?.id??n?.id??r?.current_turn_id??null);c.useEffect(()=>{a&&(n&&["pending","in_progress","failed"].includes(n.turn_status)?o(n.id):o(t?.id??n?.id??null),s&&i(a,s),n&&i(a,n))},[n,s,t,a,i]);let u=l(a??"")?.filter(w=>w.type==="assistant")?.find(w=>w.id===d)??null;return u||(u=[n,t].find(w=>w?.id===d)??null),u||(u=t??u),{focusedAssistantTurn:u,setFocusedAssistantTurnId:o}}function ct({isOpen:a,onConfirm:r,onClose:t,loading:s}){return e.jsx(ga,{isOpen:a,onClose:t,testId:"modal-wham-retry-all-turns",type:"warning",title:e.jsx("p",{className:"text-token-text-primary font-semibold",children:e.jsx(k,{id:"wham.retryAllTurnsModal.title",defaultMessage:"Retry all turns"})}),primaryButton:e.jsx(se,{color:"primary",loading:s,onClick:r,children:e.jsx(k,{id:"wham.retryAllTurnsModal.confirm",defaultMessage:"Retry all turns"})}),secondaryButton:e.jsx(se,{color:"secondary",onClick:t,children:e.jsx(k,{id:"wham.retryAllTurnsModal.cancel",defaultMessage:"Cancel"})}),children:e.jsx("div",{className:"text-sm",children:e.jsx(k,{id:"wham.retryAllTurnsModal.message",defaultMessage:"All latest turns will restart, including any siblings turns that are in progress or completed."})})})}function dt({taskId:a,turnId:r,comments:t,lastTurnWithDiffId:s,clearComments:n,lastTurn:i,focusedAssistantTurn:l,setFocusedAssistantTurnId:d,retry:o,attemptIndex:p,siblings:u}){const w=De(),h=G(),g=re(),b=xa(),M=wa(),S=tt(),m=P=>{M.eraseContent(),n(),d(P.turn.id)},L=async()=>{if(o){x(!0);try{if(o.previousTurnId){const P=await q.createFollowUpTask(a,o.previousTurnId,o.prompt,o.comments??[],!1,D?o.bestOfN??1:void 0,S?o.attachments:[]);m(P)}else{const P=await q.createNewTask(o.environmentId,o.branch,o.prompt,!1,D?o.bestOfN:void 0,S?o.attachments:[]);w(`/codex/tasks/${P.task.id}`)}j(!1)}catch(P){P instanceof Pe?Ce(P,r,h,g):g.danger({id:"wham.whamTaskPageFooter.errorRetryingTask",defaultMessage:"Error retrying task",description:"Error retrying task"},{toastId:"wham_task_page_footer_error_retrying_task"})}finally{x(!1)}}},O=l?.output_items?.some(P=>P.type==="pr"),F=!s||!l||s===l?.id||!O,U=o&&F&&l?.turn_status==="failed",y=l?.previous_turn_id&&i?.type==="assistant"&&l.previous_turn_id===i.previous_turn_id,[R,x]=c.useState(!1),[T,j]=c.useState(!1),N=pe(),$=z(N,"1406552515"),K=z(N,"879591222")||void 0,D=z(N,"3492040717"),X=c.useMemo(()=>{const P=[...l?.output_items?.find(C=>C.type==="review")?.suggested_followup_tasks??[],...l?.output_items?.filter(C=>C.type==="suggested_task")??[]],Z=Ya(l?.child_turns?.filter(C=>C.source.type==="suggested_task")?.map(C=>[C.source.suggested_task_id,C]));return P.map(C=>({suggestion:C,userTurnId:C.id?Z[C.id]?.assistant_turn_id??null:null,assistantTurnId:C.id?Z[C.id]?.user_turn_id??null:null}))},[l]),J=i?.type==="assistant"?i.turn_status:"completed",W=u?.map(P=>P.turn_status)??[];return i?.type==="assistant"&&["pending","in_progress"].includes(i.turn_status)&&!K?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"wham-message-modal-footer",className:"z-50 flex w-full justify-center",children:[(F||y)&&e.jsx("div",{className:"flex w-full justify-center px-4",children:e.jsx("div",{className:Y("relative z-1 flex w-full flex-col pt-2 pb-4",Ne),children:U?e.jsx(se,{className:"w-full",color:"primary",size:"large",loading:R&&!T,onClick:()=>{(o?.bestOfN??1)>1?j(!0):L()},children:(o.bestOfN??1)>1?h.formatMessage({id:"wham.whamTaskPageFooter.retryAllTurns",defaultMessage:"Retry all turns"}):h.formatMessage({id:"wham.whamTaskPageFooter.retry",defaultMessage:"Retry"})}):n&&e.jsxs("div",{className:"flex w-full flex-col gap-3",children:[e.jsx(rt,{}),!$&&e.jsx(st,{disableAutoFocus:!0,disableDuringSubmit:!0,onSuccess:m,onClearComments:n,followUp:{taskId:a,turnId:r,comments:t,turnStatus:J,siblingTurnStatuses:W,followUpSuggestions:X},attemptIndex:p,ariaLabel:h.formatMessage({id:"wham.whamTaskPageFooter.composerAriaLabel",defaultMessage:"Composer to enter a follow up prompt to the task"})})]})})}),!F&&!y&&e.jsx(ze.div,{layout:!0,className:Y("dark mx-6 mb-6 w-full",Ne),initial:{opacity:0,translateY:10},animate:{opacity:1,translateY:0},exit:{opacity:0,translateY:10},transition:{duration:b?0:.25},children:e.jsx(Da,{title:e.jsx(k,{id:"wham.whamTaskPageFooter.previousTurn",defaultMessage:"You are viewing a previous turn"}),primaryCtaText:e.jsx(k,{id:"wham.whamTaskPageFooter.viewLatestTurn",defaultMessage:"View latest"}),content:e.jsx(k,{id:"wham.whamTaskPageFooter.followUpsLatestTurn",defaultMessage:"Follow-ups are only available for the latest turn"}),icon:e.jsx(at,{className:"icon"}),onPrimaryCtaClick:()=>d(i.id)})})]}),e.jsx(ct,{isOpen:T,onClose:()=>j(!1),onConfirm:L,loading:R})]})}const Xe=window.location.origin+"/s/";function ut(a){return`${Xe}${a}`}function Je(a){return!a||!a.attachments||a.attachments.length===0||a.attachments[0].kind!=="codex"?null:{postId:a.id,permalink:a.permalink??ut(a.id),permissions:a.permissions.share_setting??"public",codexTask:a.attachments[0].task,codexTurn:a.attachments[0].turns}}function oe(a){return["codex_tasks","result","share",a]}function mt({taskId:a,enabled:r}){return ma({enabled:!!a&&r,queryKey:oe(a),queryFn:async()=>{const t=await Le.safeGet("/share/post/by_codex_task/{codex_task_id}",{parameters:{path:{codex_task_id:a}}});return t.post?Je(t.post):null}})}function ft({taskId:a,onSuccess:r,onError:t}){return te({scope:{id:a},mutationFn:()=>q.forkSharedTask(a),onSuccess:r,onError:t})}function ht({taskId:a,turnId:r,onSuccess:t,onError:s}){return te({scope:{id:a},mutationFn:async()=>{const n=await Le.safePost("/share/post",{requestBody:{attachments_to_create:[{kind:"codex",codex_task_id:a,current_codex_turn_id:r}]}});return Je(n.post)},onSuccess:t,onError:s})}function pt({taskId:a,sharedResult:r}){const t=he();return te({scope:{id:r?.postId??""},mutationFn:async({sharedResultId:s,access:n})=>(await Le.safePost("/share/post/update_access",{requestBody:{post_id:s,share_settings:n}})).share_setting,onMutate:({access:s})=>{const n=oe(a),i=t.getQueryData(n);return t.setQueryData(n,i&&{...i,permissions:s}),{previousAccess:i?.permissions}},onSuccess:s=>{const n=oe(a),i=t.getQueryData(n);i&&t.setQueryData(n,{...i,permissions:s})},onError:(s,n,i)=>{const l=oe(a),d=t.getQueryData(l);t.setQueryData(l,d&&{...d,permissions:i?.previousAccess??"public"})}})}function gt({taskId:a}){const r=G(),t=re(),s=De(),{mutate:n}=ft({taskId:a,onSuccess:i=>{i?.task?.id&&s(`/codex/tasks/${i?.task?.id}`)},onError:()=>{t.danger(r.formatMessage({id:"wham.codexForkButton.failedToFork",defaultMessage:"Failed to fork task"}))}});return e.jsx(se,{size:"small",color:"secondary",type:"button",className:"px-3 py-2",onClick:()=>n(),children:e.jsx(k,{id:"wham.share.taskForkButton",defaultMessage:"Fork"})})}const xt=`${Xe}...`;function wt({taskId:a,turnId:r,isLoading:t,sharedResult:s,title:n}){const[i,l]=c.useState(!1),d=(m,L)=>{m&&Ha(m,void 0,L).then(()=>{l(!0),setTimeout(()=>l(!1),1500)}).catch(()=>{})},o=he(),p=re(),{mutate:u,isPending:w}=ht({taskId:a,turnId:r,onSuccess:m=>{if(!m){p.danger("Failed to create share link");return}o.setQueryData(oe(a),m),d(m.permalink)}}),{mutate:h}=pt({taskId:a,sharedResult:s}),g=c.useRef(null),b=m=>{g.current?.focus(),s?d(s.permalink,m):u()},M=m=>{s&&h({sharedResultId:s.postId,access:m})},S=m=>{switch(m){case"public":return _e.PUBLIC;case"private":return _e.PRIVATE;case"workspace":return _e.WORKSPACE}};return e.jsx(ot,{inputRef:g,isLoading:t,isPublishedVersionLatest:!0,sharedObject:s&&{id:s.postId,title:n,access:S(s.permissions)},title:n,shareTextPlaceholder:xt,shareUrl:s?.permalink,isCopySuccessful:i,isCreateLinkRequestInProgress:w,handlePrivacyChange:M,handlePrimaryButtonClick:b})}function vt({taskId:a,turnId:r,isDisabled:t,title:s}){const n=ge(),i=va(),l=G(),[d,o]=c.useState(!1),{data:p,isLoading:u}=mt({taskId:a,enabled:d&&!t}),{triggerRef:w,container:h}=_a({isOpen:d,onClose:()=>o(!1)}),g=i?.isWorkspaceAccount()&&!i?.features.includes(La.WorkspaceShareLinks);return t||g?e.jsx(ba,{label:g?l.formatMessage(me.workspaceSharingDisabled):l.formatMessage(me.share),children:e.jsx(Se,{disabled:!0,icon:Fa,"aria-label":l.formatMessage(g?me.workspaceSharingDisabled:me.share)})}):e.jsxs(Ra,{open:d,onOpenChange:o,children:[e.jsx(Ba,{ref:w,asChild:!0,children:n?e.jsx(Se,{icon:Ee,"aria-label":l.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"})}):e.jsx(se,{icon:Ee,color:"ghost","aria-label":l.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"}),children:e.jsx(k,{id:"wham.whamTaskPageHeader.share",defaultMessage:"Share"})})}),e.jsx(fa,{children:d&&e.jsx(Ea,{forceMount:!0,container:h,children:e.jsx(qa,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:e.jsx(wt,{title:s,taskId:a,turnId:r,sharedResult:p,isLoading:u})})})})]})}function _t({assistantTurn:a}){const r=G(),t=re(),s=ge(),n=a?.pull_request_data?.head??a?.branch??"";return s||!n?null:e.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer truncate",onClick:()=>{navigator.clipboard.writeText(n),t.success(r.formatMessage({id:"wham.branchName.copied",defaultMessage:"Copied branch name to clipboard"}))},children:n})}const bt=({assistantTurn:a})=>{const r=G(),t=c.useMemo(()=>a?.created_at?new Date(a.created_at*1e3):null,[a?.created_at]),s=c.useMemo(()=>t?.getFullYear()===new Date().getFullYear(),[t]);return t?t.toLocaleDateString(r.locale,{month:"short",day:"numeric",year:s?void 0:"numeric"}):null};function Ze(a){const r=ea(a?.output_items);return{filesModified:ke(r,t=>t.files_modified??0),linesAdded:ke(r,t=>t.lines_added??0),linesRemoved:ke(r,t=>t.lines_removed??0)}}function ea(a){return a?a.map(r=>{switch(r.type){case"output_diff":return r;case"pr":return r.output_diff;default:return null}}).filter(r=>r!=null):[]}const yt=({title:a,assistantTurn:r})=>{const{linesAdded:t,linesRemoved:s}=Ze(r),n=r?.environment?.label;return e.jsxs("div",{className:"flex min-w-0 flex-col text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"truncate font-medium",children:a})}),e.jsxs("div",{className:"flex gap-4 max-md:flex-wrap max-md:gap-1",children:[e.jsx("span",{className:"text-token-text-secondary truncate empty:hidden max-md:hidden",children:e.jsx(bt,{assistantTurn:r})}),e.jsx("span",{className:"text-token-text-secondary truncate",children:n}),e.jsx(_t,{assistantTurn:r}),e.jsx("span",{className:"max-md:hidden",children:e.jsx(ia,{linesAdded:t,linesRemoved:s})})]})]})};function ie({children:a,dropdownContent:r,buttonIcon:t,triggerButtonAriaLabel:s,...n}){const[i,l]=c.useState(!1),d=t||qe,o=t||null,p=G();return e.jsxs("div",{tabIndex:-1,className:"btn-primary hover:bg-token-interactive-bg-primary-default inline-flex w-fit items-center rounded-full text-sm font-medium data-disabled:cursor-not-allowed data-disabled:opacity-50",children:[e.jsxs("div",{className:"hidden items-center md:inline-flex",children:[n.as==="a"?e.jsx("a",{className:"rounded-s-full px-3 py-2",href:n.href,target:"_blank",rel:"noreferrer",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"hidden md:flex",children:o?e.jsx(o,{className:"icon-sm"}):null}),e.jsx("span",{className:"truncate",children:a})]})}):e.jsx("button",{className:"hover:bg-token-bg-primary/10 rounded-s-full px-3 py-2 transition-colors duration-120",onClick:n.onClick,children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"hidden md:flex",children:o?e.jsx(o,{className:"h-5 w-5"}):null}),e.jsx("span",{className:"truncate",children:a})]})}),e.jsx("div",{className:"bg-token-text-inverted/20 h-9 w-px"})]}),e.jsx(ya,{open:i,contentAlign:"end",onOpenChange:l,triggerButton:e.jsxs("button",{className:`hover:bg-token-bg-primary/10 flex h-9 items-center gap-1.5 ps-2 pe-3 transition-colors duration-120 focus:outline-none md:ps-2 md:pe-3 ${i?"bg-token-bg-primary/10 opacity-100":"md:opacity-60 md:hover:opacity-120"}`,onMouseDown:u=>u.preventDefault(),onFocus:u=>u.currentTarget.blur(),"aria-label":p.formatMessage(s??{id:"wham.dropdownButton.openMenu",defaultMessage:"Open menu",description:"Aria label for dropdown trigger button"}),children:[e.jsx("div",{className:"flex md:hidden",children:e.jsx(d,{className:"icon-md"})}),e.jsx("div",{className:"opacity-60 md:flex",children:e.jsx(qe,{className:"icon-sm"})})]}),sideOffset:8,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Q.ItemAs,{className:"md:hidden",icon:o,as:n.as??"button",...n.as==="a"?{href:n.href,target:"_blank",rel:"noreferrer"}:{onClick:n.onClick},children:e.jsx("span",{className:"truncate",children:a})}),e.jsx(Q.Separator,{className:"md:hidden"}),r]})})]})}const kt=({copyApplyToClipboard:a,copyPatchToClipboard:r,createPr:t,updateBranch:s,navigateToCreatingPrPage:n,canCreatePr:i,isCreatingPr:l,permissions:d,assistantTurn:o})=>{const p=pe(),u=G(),w=z(p,"296452287"),h=e.jsxs(e.Fragment,{children:[s&&i&&e.jsx(Q.Item,{icon:ae,onClick:()=>t(),"aria-label":u.formatMessage(_.createNewPr),children:e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(k,{..._.createNewPr})})}),e.jsx(Q.Item,{icon:be,onClick:()=>a(),"aria-label":u.formatMessage(_.copyGitApply),children:e.jsx(k,{..._.copyGitApply})}),e.jsx(Q.Item,{icon:be,onClick:()=>r(),"aria-label":u.formatMessage(_.copyPatch),children:e.jsx(k,{..._.copyPatch})})]});return!i||d==="read"?e.jsx(ie,{buttonIcon:Ia,onClick:()=>a(),triggerButtonAriaLabel:_.openDropdown,dropdownContent:e.jsx(Q.Item,{icon:be,onClick:()=>r(),"aria-label":u.formatMessage(_.copyPatch),children:e.jsx(k,{..._.copyPatch})}),children:e.jsx(k,{..._.copyGitApply})}):l?e.jsx(ie,{buttonIcon:Ye,onClick:n,dropdownContent:h,triggerButtonAriaLabel:_.openDropdown,children:e.jsx(k,{..._.viewPullRequest})}):o?.pull_request_data?.url?e.jsx(ie,{buttonIcon:ae,as:"a",href:o.pull_request_data.url,dropdownContent:h,triggerButtonAriaLabel:_.openDropdown,children:e.jsx(k,{..._.viewPullRequest})}):s?e.jsx(ie,{buttonIcon:ae,onClick:()=>s(),dropdownContent:h,triggerButtonAriaLabel:_.openDropdown,children:e.jsx(k,{..._.updateExistingBranch})}):e.jsx(ie,{buttonIcon:ae,onClick:()=>t(),"aria-label":u.formatMessage(_.createPr),triggerButtonAriaLabel:_.openDropdown,dropdownContent:e.jsxs(e.Fragment,{children:[e.jsx(Q.Item,{icon:ae,onClick:()=>t("draft"),"aria-label":u.formatMessage(_.createDraftPr),children:e.jsx(k,{..._.createDraftPr})}),w&&e.jsx(Q.Item,{icon:ae,onClick:()=>t("auto_merge"),"aria-label":u.formatMessage(_.createAutoMergePr),children:e.jsx(k,{..._.createAutoMergePr})}),e.jsx(Q.Separator,{}),h]}),children:e.jsx(k,{..._.createPr})})},_=ha({copyGitApply:{id:"wham.whamTaskPushDiffDropdown.copyGitApply",defaultMessage:"Copy git apply"},copyPatch:{id:"wham.whamTaskPushDiffDropdown.copyPatch",defaultMessage:"Copy patch"},viewPullRequest:{id:"wham.message.modal.footer.viewPr",defaultMessage:"View PR"},createPr:{id:"wham.message.modal.footer.createPrItem",defaultMessage:"Create PR"},createNewPr:{id:"wham.whamTaskPushDiffDropdown.createNewPr",defaultMessage:"Create new PR"},createDraftPr:{id:"wham.message.modal.footer.createDraftPr",defaultMessage:"Create draft PR"},createAutoMergePr:{id:"wham.message.modal.footer.createAutoMergePr",defaultMessage:"Create auto-merged PR"},updateExistingBranch:{id:"wham.whamTaskPushDiffDropdown.updateExistingBranch",defaultMessage:"Update branch"},openDropdown:{id:"wham.whamTaskPushDiffDropdown.openDropdown",defaultMessage:"Open git action menu"}});var je,We;function jt(){if(We)return je;We=1;function a(r){return r&&r.length?r[0]:void 0}return je=a,je}var Me,Qe;function Mt(){return Qe||(Qe=1,Me=jt()),Me}var Pt=Mt();const Ct=pa(Pt);function Tt({taskId:a,task:r,focusedAssistantTurn:t,onClose:s,shouldShowShare:n,shouldShowFork:i,permissions:l,title:d}){const[o,p]=c.useState(t?.pull_request_status==="creating"),[u,w]=c.useState(void 0),h=re(),g=he(),b=G(),M=Ct(Ke(t)),S=l==="write",m=S,L=fe(v=>v.getTurnsForTask(a).filter(Te)),O=fe(v=>v.getTurnsForTask(a)),F=new Map(O.map(v=>[v.id,v])),U=v=>{if(Te(v)){const B=r?.external_pull_requests;if(B&&B.length)for(let E=B.length-1;E>=0;E--){const ue=B[E];if(ue.assistant_turn_id===v.id)return ue}}const H=v.previous_turn_id?F.get(v.previous_turn_id):void 0;return H?U(H):void 0},y=t?U(t):void 0,{linesAdded:R,linesRemoved:x}=Ze(t),T=ea(t?.output_items),j=De(),N=pe(),$=z(N,"2665240312")||void 0,K=z(N,"369193424"),X=L.filter(v=>t?.sibling_turn_ids?.includes(v.id)).some(v=>v.pull_request_data?.url),J=K&&l==="write"&&y&&!y.pull_request.merged&&y.pull_request.state!=="closed"&&y.codex_updated_sha!==""&&!X,W=c.useRef(null),{mutate:P,isPending:Z}=te({mutationFn:async()=>{a&&await q.archiveTask(a)},onSuccess:async()=>{await g.invalidateQueries({queryKey:["wham","tasks"]}),await g.invalidateQueries({queryKey:["wham","task",a]}),j("/codex")},onError:()=>{h.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),{mutate:C,isPending:A}=te({mutationFn:async()=>{a&&await q.recoverTask(a)},onSuccess:async()=>{await g.invalidateQueries({queryKey:["wham","tasks"]}),await g.invalidateQueries({queryKey:["wham","task",a]})},onError:()=>{h.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),le=Z||A;c.useEffect(()=>{t?.pull_request_status==="creating"?(p(!0),g.invalidateQueries({queryKey:["wham","task",a,"turns"]})):p(!1)},[a,t?.pull_request_status,g]),oa([{key:"copyApplyToClipboard",action:()=>{ce()},actionMessageDescriptor:b.formatMessage({id:"wham.keyboardActions.copyApplyToClipboard",defaultMessage:"Copy git apply"}),group:Oa.Chat,keyboardBinding:[He.Mod,He.Shift,";"],enabled:!!M}]);const ce=async()=>{M&&(await navigator.clipboard.writeText(` (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
${M} 
EOF
)`),h.success(b.formatMessage({id:"wham.message.modal.footer.copiedToClipboard",defaultMessage:"Copied git apply command to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&(Ue.recordGitAction("diff-copied",R,x,a,t.id,"regular"),q.copyGitApply(a,t.id,!0)))},xe=async()=>{M&&(await navigator.clipboard.writeText(M),h.success(b.formatMessage({id:"wham.whamTaskPageHeader.copiedPatchToClipboard",defaultMessage:"Copied patch to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&await q.copyGitApply(a,t.id,!1))},we=async()=>{if(!y||!t?.id){h.danger({id:"wham.whamTaskPageHeader.noPrToUpdate",defaultMessage:"No PR to update",description:"Toast when no PR is found to update"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_no_pr_to_update"});return}p(!0);try{await q.updatePr(a,t.id,y.id),await g.invalidateQueries({queryKey:["wham","task"]})}catch(v){p(!1),await q.getTaskTurnPR(a,y.assistant_turn_id),v instanceof Pe?Ce(v,t.id,b,h):h.danger({id:"wham.whamTaskPageHeader.failedToUpdatePr",defaultMessage:"Failed to update PR",description:"Toast when failed to update PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_update_pr"})}finally{p(!1)}},ve=async v=>{if(!t?.id)return;w(v);const H=W.current;try{p(!0),await q.createPr(a,t.id,v),await g.invalidateQueries({queryKey:["wham","task"]}),await g.fetchQuery(la(a,t.id)).then(B=>{const E=B;E.turn.pull_request_data!=null&&(H&&!H.closed&&E.turn.pull_request_data.url&&H.location.assign(E.turn.pull_request_data.url),Ua({title:E.task.title,clientThreadId:E.turn.conversation_id,subtitle:b.formatMessage({id:"wham.message.modal.footer.prCreatedSuccess",defaultMessage:"Click to view your pull request."}),onClick:()=>{window.open(E.turn.pull_request_data?.url,"_blank")}}))}),Ue.recordGitAction("pr-created",R,x,a,t.id,v??"regular")}catch(B){p(!1),H?.close(),B instanceof Pe?Ce(B,t.id,b,h):h.danger({id:"wham.message.modal.footer.createPrError",defaultMessage:"Failed to create PR",description:"Error message for failed to create PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_create_pr"})}},de=()=>{if(!t?.id)return;const v=u?`?mode=${u}`:"";W.current=window.open(`/codex/tasks/${a}/turns/${t.id}/pr${v}`,"_blank")},ne=!!ge();return e.jsxs("div",{className:"border-b-token-border-default flex w-full justify-between gap-2 border-b p-3 transition-colors duration-50",children:[e.jsxs("div",{className:"flex min-w-0 flex-shrink max-md:gap-2",children:[s?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"hover:bg-token-bg-tertiary group-radix-state-open:bg-token-bg-tertiary rounded-sm p-2 font-semibold",onClick:s,"aria-label":b.formatMessage({id:"wham.taskPageHeader.goBack",defaultMessage:"Go back to tasks"}),children:e.jsx(nt,{className:"icon-lg text-token-text-secondary"})}),e.jsx("div",{className:"bg-token-border-default my-auto ms-[11px] me-4 h-4 w-[1px] max-md:hidden"})]}):e.jsx("div",{className:"ms-3"}),e.jsx(yt,{title:d,assistantTurn:t})]}),e.jsxs("div",{className:"relative flex h-10 items-center gap-1.5",children:[!1,i&&t?.id&&e.jsx(gt,{taskId:a}),$&&t?.id&&S&&(ne?e.jsx(Se,{icon:r?.archived?Ie:Oe,onClick:()=>r?.archived?C():P(),disabled:le,"aria-label":r?.archived?b.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):b.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"})}):e.jsx(se,{color:"ghost",icon:r?.archived?Ie:Oe,loading:le,onClick:()=>r?.archived?C():P(),"aria-label":r?.archived?b.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):b.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"}),children:r?.archived?e.jsx(k,{id:"wham.whamTaskPageHeader.unarchive",defaultMessage:"Unarchive"}):e.jsx(k,{id:"wham.whamTaskPageHeader.archive",defaultMessage:"Archive"})})),n&&t?.id&&e.jsx(vt,{taskId:a,turnId:t?.id,isDisabled:!1,title:d??""}),T.length>0&&e.jsx(kt,{isCreatingPr:o,assistantTurn:t,copyApplyToClipboard:ce,copyPatchToClipboard:xe,createPr:ve,navigateToCreatingPrPage:de,canCreatePr:m,updateBranch:J?we:void 0,permissions:l}),!ne&&e.jsx(it,{})]})]})}function St(a){const r={},t={};let s;for(const i of a)Ve(i)?i.previous_turn_id?t[i.previous_turn_id]=i:s=i:i.previous_turn_id&&(r[i.previous_turn_id]??=[]).push(i);if(!s)return null;const n=i=>{const l=r[i.id]??[],d={};for(const o of l){const p=t[o.id];p&&(d[o.id]=n(p))}return{userTurn:i,assistantTurns:l,children:d}};return n(s)}function Nt(a){for(let r=a.length-1;r>=0;r--){const t=a[r];if(Ve(t)&&t.previous_turn_id)return t.previous_turn_id}return null}function Dt(a,r){if(!r)return[];const t=s=>{for(const n of s.assistantTurns){if(n.id===r)return[{node:s,activeId:n.id}];const i=s.children[n.id],l=i&&t(i);if(l)return[{node:s,activeId:n.id},...l]}return null};return t(a)??[]}function Lt({className:a,focusedAssistantTurn:r,currentTab:t,permissions:s,task:n,turns:i,containerHeight:l,onClickFile:d,setFocusedAssistantTurnId:o,onTabChange:p,latestTurnRef:u,hasComments:w,clearComments:h,showFullDiff:g,loadingTurnMapping:b}){c.useEffect(()=>{if(!r){const x=Nt(i);x&&o(x)}},[r,i,o]);const M=c.useMemo(()=>St(i),[i]),S=c.useMemo(()=>M&&Dt(M,r?.id??null),[M,r]),m=c.useMemo(()=>{if(!M||!S)return[];const x=S.length>0?[...S]:[{node:M,activeId:M.assistantTurns[0]?.id??null}];let T=x[x.length-1];for(;T.activeId;){const j=T.node.children[T.activeId];if(!j)break;x.push({node:j,activeId:j.assistantTurns[0]?.id??null}),T=x[x.length-1]}return x},[M,S]),L=m.length-1,O=m.slice(0,L),F=ka(m),U=F?.node.assistantTurns.some(x=>Ae(x.turn_status)),{data:y}=ca(n?.id),R=c.useMemo(()=>{if(!b||!y?.current_assistant_turn)return null;const x=y.current_assistant_turn,T=(x.sibling_turn_ids?.length??0)+1,j=x.attempt_placement??0,N=Array.from({length:T},(K,D)=>D===j?x.id:`placeholder-${D}`),$={};return N.forEach((K,D)=>$[K]=D),{attemptIds:N,idToIdxMap:$}},[b,y?.current_assistant_turn]);return e.jsx("div",{className:Y("relative flex h-full w-full flex-col",a),children:e.jsx("div",{className:"flex h-fit min-h-full shrink-0 flex-col gap-6 pt-6 text-sm",children:b&&n&&y?.current_user_turn&&y?.current_assistant_turn?e.jsxs("div",{ref:u,className:Y("flex min-h-full shrink-0 flex-col gap-6",U&&"pb-72"),style:{minHeight:l-24},children:[e.jsx("div",{className:"text-token-text-secondary flex w-full items-center justify-center gap-2",children:e.jsx(Ye,{className:"text-xl"})}),e.jsx(ye,{isLatest:!0,task:n,userTurn:y.current_user_turn,assistantTurns:[y.current_assistant_turn],selectedAssistantId:y.current_assistant_turn.id,focusedAssistantTurn:y.current_assistant_turn,setFocusedAssistantTurnId:o,onClickFile:d,currentTab:t,onTabChange:p,permissions:s,startOpen:!0,hasComments:w,clearComments:h,showFullDiff:g,attemptIdsOverride:R?.attemptIds,idToIndexMapOverride:R?.idToIdxMap})]}):e.jsxs(e.Fragment,{children:[O.length>0&&e.jsx("div",{className:"flex flex-col gap-6",children:O.map(({node:x,activeId:T},j)=>e.jsx(ye,{isLatest:j===L,task:n,userTurn:x.userTurn,assistantTurns:x.assistantTurns,selectedAssistantId:T,focusedAssistantTurn:r,setFocusedAssistantTurnId:o,onClickFile:d,startOpen:j===L,currentTab:t,onTabChange:p,permissions:s,hasComments:w,clearComments:h,showFullDiff:g},x.userTurn.id))}),F&&e.jsx("div",{ref:u,className:Y("flex min-h-full shrink-0 flex-col gap-6",U&&"pb-72"),style:{minHeight:l-24},children:e.jsx(ye,{isLatest:!0,task:n,userTurn:F.node.userTurn,assistantTurns:F.node.assistantTurns,selectedAssistantId:r?.id??null,focusedAssistantTurn:r,setFocusedAssistantTurnId:o,onClickFile:d,currentTab:t,onTabChange:p,permissions:s,startOpen:!0,hasComments:w,clearComments:h,showFullDiff:g})})]})})})}const Ge=new Set,$e=ja(()=>Ma(()=>import("./l10vl2ttbxxbazn4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37])).then(a=>a.WhamTaskPageCodeDiffContent),{loading:()=>e.jsx("div",{className:"flex-1"})});function Yt({taskId:a,turnId:r,task:t,focusedAssistantTurn:s,pastTurns:n,lastTurnWithDiffId:i,canFollowUp:l,confirmClose:d,permissions:o,comments:p,setComments:u,clearComments:w,setConfirmClose:h,handleClose:g,setFocusedAssistantTurnId:b,showForkButton:M,loadingTurnMapping:S}){const m=G(),{data:L,isLoading:O}=da(),F=he(),[{height:U},y]=lt(),R=c.useRef(null),x=c.useRef(null);Pa(()=>{const f=R.current,V=x.current;!f||!V||(f.scrollTop=f.scrollHeight,f.clientHeight>=V.clientHeight&&(f.scrollTop=V.offsetTop))},[n.length,S]),c.useEffect(()=>{const f=R.current;if(!f)return;f.scrollHeight-f.scrollTop-f.clientHeight<5&&f.scrollTo({top:f.scrollHeight,behavior:"smooth"})},[n.length]);const[T,j]=c.useState(void 0),N=c.useMemo(()=>Ke(s,!0).length>0,[s]),[$,K]=Ca(Ta.WhamShowFullDiff,!N,Wa),D=N?$:!0,X=c.useMemo(()=>s?Xa({assistantTurn:s,followUp:!D}):[],[s,D]),J=s?.turn_status==="failed",W=X.length>0,P=n[n.length-1],Z=t?t.title??m.formatMessage({id:"wham.whamTaskPageContentLoaded.newTask",defaultMessage:"New Task"}):null,C=re(),A=!!ge(),le=A||L?.git_diff_mode==="unified",ce=pe(),xe=z(ce,"3673716873");c.useEffect(()=>{const f=s?.id;f&&!Ge.has(f)&&s?.turn_status==="completed"&&(Ge.add(f),q.markTurnViewed(a,f))},[s?.id,a,s?.turn_status]),c.useEffect(()=>{$e.prefetch()},[O]);const{mutate:we}=te({mutationFn:f=>q.updateUserPreferences(f),onSuccess:async()=>{await ua(F)},onError:()=>{C.danger({id:"wham.whamTaskPageContentLoaded.failedToUpdatePreferences",defaultMessage:"Failed to update preferences",description:"Failed to update preferences error message"},{toastId:"wham_task_page_content_loaded_failed_to_update_preferences"})}}),ve=f=>{we({diffView:f?"unified":"split"})},de=A?"chat":W?"diff":void 0,[ne,v]=c.useState(!1);!ne&&t&&(v(!0),j(de));const H=s?.turn_status?Ae(s?.turn_status):null,B=c.useRef(!1);c.useEffect(()=>{H===!1?B.current=!0:H===!0&&B.current&&W&&j("diff")},[H]);const E=c.useMemo(()=>{if(J&&s?.environment_id&&s?.branch){const f=[...n].reverse().find(I=>I.type==="user"),ee=f?.input_items.find(I=>I.type==="message")?.content.find(I=>I.content_type==="text")?.text,ta=f?.input_items.filter(I=>I.type==="comment"),sa=(s?.sibling_turn_ids?.length??0)+1,ra=f?.input_items.filter(I=>I.type==="message").flatMap(I=>I.content.filter(na=>na.content_type==="image_asset_pointer"))??[];return{environmentId:s?.environment_id,branch:s?.branch,previousTurnId:f?.previous_turn_id,prompt:ee??"",comments:ta??[],bestOfN:sa,attachments:ra}}},[J,s,n]),{attemptIndex:ue,siblings:aa}=c.useMemo(()=>{if(!s)return{attemptIndex:null,hasSiblingTurns:!1};const f=n.filter(ee=>Te(ee)&&!!ee.sibling_turn_ids?.includes(s.id)),V=f.findIndex(ee=>ee.id===s.id);return{attemptIndex:V===-1?null:V+1,siblings:f}},[s,n]),Fe=o==="write"&&w?e.jsx(dt,{taskId:a,turnId:s?.id??r,comments:p??[],lastTurnWithDiffId:i,clearComments:w,focusedAssistantTurn:s,setFocusedAssistantTurnId:b,lastTurn:P,retry:E,attemptIndex:ue,siblings:aa??[]}):null,Re=e.jsx("div",{ref:Qa(y,R),className:"flex h-full w-full flex-col items-center overflow-y-auto px-6",children:e.jsxs("div",{className:Y("w-full",Ne),children:[e.jsx(Lt,{focusedAssistantTurn:s,currentTab:T,permissions:o,task:t,turns:n,containerHeight:U,onClickFile:()=>j("diff"),setFocusedAssistantTurnId:b,onTabChange:j,latestTurnRef:x,hasComments:(p?.length??0)>0,clearComments:w,showFullDiff:D,loadingTurnMapping:S}),Fe&&e.jsx("div",{className:"keyboard-open:fixed absolute start-0 end-0 bottom-0",children:Fe})]})}),Be=e.jsx("div",{className:"relative flex h-full w-full flex-col",children:e.jsxs(Aa,{onChange:j,currentTab:T,defaultTab:de,tabs:[{key:"chat",isHidden:!A,label:m.formatMessage({id:"wham.whamTaskPageContentLoaded.conversation",defaultMessage:"Conversation"}),ariaLabel:m.formatMessage({id:"wham.whamTaskPageContentLoaded.conversationAriaLabel",defaultMessage:"Tab to view the conversation with the assistant"}),children:Re},{key:"diff",isHidden:!W,label:m.formatMessage({id:"wham.whamTaskPageContentLoaded.diff",defaultMessage:"Diff"}),ariaLabel:m.formatMessage({id:"wham.whamTaskPageContentLoaded.diffAriaLabel",defaultMessage:"Tab to view the code diff"}),children:!O&&W&&e.jsx($e,{diffFiles:X,unifiedDiff:le,setUnifiedDiff:ve,showFullDiff:D,setShowFullDiff:N?K:void 0,enableComments:l,comments:p,setComments:u})},{key:"logs",label:m.formatMessage({id:"wham.whamTaskPageContentLoaded.logs",defaultMessage:"Logs"}),ariaLabel:m.formatMessage({id:"wham.whamTaskPageContentLoaded.logsAriaLabel",defaultMessage:"Tab to view the work logs"}),children:e.jsx(Ja,{taskId:a,focusedAssistantTurn:s,agentNetworkAccess:s?.environment?.agent_network_access})},{key:"internal_rollout",isHidden:s?.internal_only_rollouts==null||!0,label:m.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRollout",defaultMessage:"Internal Rollout"}),ariaLabel:m.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRolloutAriaLabel",defaultMessage:"Tab to view the internal rollout information"}),children:e.jsx("div",{className:"flex h-full w-full overflow-auto p-4",children:e.jsx(Ka,{json:s?.internal_only_rollouts??void 0,jsonViewProps:{collapsed:5}})})}],children:[e.jsx(Va,{withUnderline:A,className:"border-b p-3 max-md:py-0"}),e.jsx(za,{children:({content:f})=>e.jsx("div",{className:"flex h-full w-full",children:f})})]},s?.id??a)});return e.jsxs(e.Fragment,{children:[e.jsxs(ze.div,{className:Y("relative flex size-full flex-1 flex-col items-center",A?"[--right-bg:var(--bg-primary)]":"[--right-bg:var(--bg-tertiary)] dark:[--right-bg:black]"),...Ga,children:[e.jsx(Tt,{title:Z,taskId:a,task:t,focusedAssistantTurn:s,onClose:g?()=>g?.({force:!0}):void 0,permissions:o,shouldShowShare:xe&&o==="write",shouldShowFork:!!M}),e.jsx("div",{className:"bg-token-bg-primary flex min-h-0 w-full flex-1",children:!t||!ne?e.jsx(Sa,{}):A?Be:e.jsx(Za,{leftContent:Re,rightContent:T?e.jsxs("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:[Be,e.jsx($a,{className:"absolute end-3 top-3",icon:e.jsx(Na,{}),label:m.formatMessage({id:"wham.whamTaskPageContentLoaded.close",defaultMessage:"Close"}),onClick:()=>j(void 0)})]}):void 0})})]}),d&&h&&g&&e.jsx(et,{setConfirmClose:h,handleClose:g})]})}export{Yt as W,zt as u};
//# sourceMappingURL=ekrjz1qfz0wzkkjd.js.map
